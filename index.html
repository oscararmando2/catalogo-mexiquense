<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MEXIQUENSE - Catálogo de Productos</title>

  <!-- Tailwind + fuentes -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Librerías utilitarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
    .card-hover { transition: transform .25s ease, box-shadow .25s ease; }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0,0,0,.1); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }
    .error-message { color:#dc2626; font-size:.875rem; margin-top:.25rem; }

    .loader { border:4px solid #f3f3f3; border-top:4px solid #4f46e5; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; margin:0 auto; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .product-image-container { position:relative; width:100%; padding-top:100%; }
    .product-image { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; border-radius:8px; background-color:#f9fafb; }

    /* Badge NEW (solo vista pública) */
    .new-badge {
      position:absolute; top:.5rem; right:.5rem;
      background-color:#a3e635; color:#065f46; font-weight:700; font-size:.75rem;
      padding:.25rem .5rem; border-radius:9999px; box-shadow:0 2px 6px rgba(0,0,0,.2);
      animation:fadeIn .8s ease-in-out;
    }
    .fade-in { animation:fadeIn 1s ease; }
    @keyframes fadeIn { from{opacity:0; transform:scale(.95)} to{opacity:1; transform:scale(1)} }

    #offlineBanner { display:none; }
  </style>
</head>
<body>
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
      <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center mb-4 md:mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4z" clip-rule="evenodd"/>
            </svg>
            <h1 class="text-2xl md:text-3xl font-bold">MEXIQUENSE</h1>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="adminViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Panel de Administración</button>
            <button id="publicViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Productos</button>
            <div id="adminButtons" class="flex flex-wrap gap-2">
              <button id="importBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                Importar CSV
              </button>
              <button id="exportBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                Exportar PDF
              </button>
              <button id="addProductBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                Nuevo Producto
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Banner offline -->
    <div id="offlineBanner" class="w-full bg-yellow-100 text-yellow-800 border border-yellow-300 px-4 py-2 text-center text-sm">
      ⚠️ Sin conexión con Firebase. <strong>Usando datos locales</strong>. Los cambios se guardarán en este navegador hasta que vuelva la conexión.
    </div>

    <!-- Admin -->
    <section id="adminView" class="flex-grow container mx-auto px-4 py-8 hidden">
      <div class="bg-white rounded-xl shadow-md p-4 mb-8">
        <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
          <div class="flex-grow">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Buscar productos..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"/>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 11-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center space-x-4 mb-4">
        <input type="checkbox" id="selectAll" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
        <label for="selectAll" class="text-gray-700 font-medium">Seleccionar Todos</label>
        <button id="deleteSelected" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Eliminar Seleccionados</button>
      </div>

      <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </section>

    <!-- Público -->
    <section id="publicView" class="flex-grow container mx-auto px-4 py-8">
      <div class="bg-white rounded-xl shadow-md p-4 mb-8">
        <h2 class="text-2xl font-bold text-indigo-600 mb-4">Catálogo de Productos</h2>

        <div class="bg-white rounded-xl shadow-md p-4 mb-8">
          <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="flex-grow">
              <div class="relative">
                <input id="publicSearchInput" type="text" placeholder="Buscar productos por nombre o UPC..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
              </div>
            </div>
          </div>
        </div>

        <div id="publicTabs" class="flex space-x-4 border-b border-gray-200"></div>
        <div id="publicTabContent" class="mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6">
      <div class="container mx-auto px-4 text-center">
        <p>© 2025 MEXIQUENSE - Sistema de Catálogo</p>
      </div>
    </footer>

    <!-- Modal Detalle Producto -->
    <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
          <h3 id="modalProductTitle" class="text-xl font-bold">Detalles del Producto</h3>
          <button id="closeDetailModal" class="text-white hover:text-indigo-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div id="productImage" class="bg-gray-100 rounded-lg h-64 flex items-center justify-center mb-4 overflow-hidden">
                <img id="productImageSrc" src="" class="max-h-full max-w-full object-contain hidden" alt="Producto" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                <svg id="productImagePlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </div>
              <div class="space-y-2" id="productFields">
                <p><strong>Número de Ítem:</strong> <span id="productItemNumber" class="text-gray-700"></span></p>
                <p><strong>UPC:</strong> <span id="productUpc" class="text-gray-700"></span></p>
                <p><strong>Tamaño:</strong> <span id="productSize" class="text-gray-700"></span></p>
                <p><strong>Cantidad:</strong> <span id="productQty" class="text-gray-700"></span></p>
              </div>
              <div id="customFields" class="space-y-2 mt-4"></div>
              <div class="mt-4 admin-only">
                <button id="addCustomFieldBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Agregar Campo Personalizado</button>
              </div>
              <div id="customFieldForm" class="hidden mt-4 space-y-4 admin-only">
                <div>
                  <label for="customKey" class="block text-sm font-medium text-gray-700 mb-1">Clave (ej. Palimex):</label>
                  <input type="text" id="customKey" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <p id="customKeyError" class="error-message hidden"></p>
                </div>
                <div>
                  <label for="customValue" class="block text-sm font-medium text-gray-700 mb-1">Valor (ej. $3.80):</label>
                  <input type="text" id="customValue" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div class="flex justify-end space-x-2">
                  <button id="cancelCustomField" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                  <button id="saveCustomField" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50" disabled>Guardar</button>
                </div>
              </div>
            </div>
            <div>
              <h4 class="text-lg font-semibold mb-2">Descripción</h4>
              <p id="productDescription" class="text-gray-700 mb-4"></p>
              <h4 class="text-lg font-semibold mb-2">Costo</h4>
              <p id="productCosto" class="text-2xl font-bold text-indigo-600 mb-4"></p>
            </div>
          </div>
        </div>
        <div class="flex justify-end p-6 pt-0 admin-only">
          <button id="deleteProductBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Eliminar</button>
        </div>
      </div>
    </div>

    <!-- Modal Form Producto -->
    <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
          <h3 id="formTitle" class="text-xl font-bold">Nuevo Producto</h3>
          <button id="closeFormModal" class="text-white hover:text-indigo-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar">
          <form id="productForm" class="space-y-4">
            <input type="hidden" id="productId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="itemNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Ítem*</label>
                <input type="text" id="itemNumber" name="itemNumber" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="itemNumberError" class="error-message hidden"></p>
              </div>
              <div>
                <label for="upc" class="block text-sm font-medium text-gray-700 mb-1">UPC*</label>
                <input type="text" id="upc" name="upc" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="upcError" class="error-message hidden"></p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre*</label>
                <input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="nombreError" class="error-message hidden"></p>
              </div>
              <div>
                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Tamaño*</label>
                <input type="text" id="size" name="size" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="sizeError" class="error-message hidden"></p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                <input type="number" id="qty" name="qty" required min="0" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="qtyError" class="error-message hidden"></p>
              </div>
              <div>
                <label for="costo" class="block text-sm font-medium text-gray-700 mb-1">Costo*</label>
                <input type="number" id="costo" name="costo" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <p id="costoError" class="error-message hidden"></p>
              </div>
            </div>
            <div>
              <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen (opcional)</label>
              <input type="url" id="url" name="url" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción*</label>
              <textarea id="description" name="description" required rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
              <p id="descriptionError" class="error-message hidden"></p>
            </div>
            <div class="pt-4 flex justify-end space-x-2">
              <button type="button" id="cancelProductBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-all">Cancelar</button>
              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Guardar Producto</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Import -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
        <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
          <h3 class="text-xl font-bold">Importar Productos desde CSV</h3>
          <button id="closeImportModal" class="text-white hover:text-indigo-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="p-6">
          <p class="text-gray-600 mb-4">CSV con encabezados: ITEM NUMBER, DESCRIPTION, UPC, NOMBRE, SIZE, QTY, COSTO, URL (opcional). Separador: coma.</p>
          <form id="importForm" class="space-y-4">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
              <input type="file" id="csvFile" name="csvFile" accept=".csv" class="hidden">
              <label for="csvFile" class="cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <span class="mt-2 block text-sm font-medium text-indigo-600">Haz clic para seleccionar archivo</span>
                <span id="fileName" class="mt-1 block text-sm text-gray-500">Ningún archivo seleccionado</span>
              </label>
            </div>
            <div id="importLoader" class="hidden">
              <div class="loader"></div>
              <p class="text-gray-600 mt-2">Importando...</p>
            </div>
            <div class="pt-4 flex justify-end">
              <button type="submit" id="importSubmitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Importar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
      <span id="toastMessage">Operación completada con éxito</span>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
        <h3 class="text-xl font-bold text-indigo-600 mb-4">Ingresar Contraseña para Administración</h3>
        <input type="password" id="adminPasswordInput" placeholder="Contraseña" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
        <div class="flex justify-end space-x-2">
          <button id="cancelPassword" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
          <button id="confirmPassword" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Firebase config (SIN CAMBIOS) ===
    const firebaseConfig = {
      apiKey: "TU_API_KEY_AQUI",
      authDomain: "catalogomexiquense.firebaseapp.com",
      databaseURL: "https://catalogomexiquense-default-rtdb.firebaseio.com",
      projectId: "catalogomexiquense",
      storageBucket: "catalogomexiquense.appspot.com",
      messagingSenderId: "TU_SENDER_ID_AQUI",
      appId: "TU_APP_ID_AQUI"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Estado / refs
    const adminPassword = 'admin123';
    let products = [];
    let isOffline = false;
    let currentView = 'public';

    const productsContainer = document.getElementById('productsContainer');
    const searchInput = document.getElementById('searchInput');
    const publicSearchInput = document.getElementById('publicSearchInput');
    const adminView = document.getElementById('adminView');
    const publicView = document.getElementById('publicView');
    const adminViewBtn = document.getElementById('adminViewBtn');
    const publicViewBtn = document.getElementById('publicViewBtn');
    const publicTabs = document.getElementById('publicTabs');
    const publicTabContent = document.getElementById('publicTabContent');
    const adminButtons = document.getElementById('adminButtons');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const addProductBtn = document.getElementById('addProductBtn');
    const passwordModal = document.getElementById('passwordModal');
    const adminPasswordInput = document.getElementById('adminPasswordInput');
    const confirmPassword = document.getElementById('confirmPassword');
    const cancelPassword = document.getElementById('cancelPassword');

    const productDetailModal = document.getElementById('productDetailModal');
    const productFormModal = document.getElementById('productFormModal');
    const importModal = document.getElementById('importModal');

    const selectAll = document.getElementById('selectAll');
    const deleteSelected = document.getElementById('deleteSelected');
    const deleteProductBtn = document.getElementById('deleteProductBtn');
    const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
    const cancelCustomField = document.getElementById('cancelCustomField');
    const saveCustomField = document.getElementById('saveCustomField');

    const productForm = document.getElementById('productForm');
    const importForm = document.getElementById('importForm');
    const customFieldForm = document.getElementById('customFieldForm');
    const customKey = document.getElementById('customKey');
    const customValue = document.getElementById('customValue');

    const offlineBanner = document.getElementById('offlineBanner');

    // Utils
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 flex items-center z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
      toast.classList.remove('translate-y-20', 'opacity-0');
      setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
    }
    function isLocalStorageAvailable() {
      try { const t='__t__'; localStorage.setItem(t,t); localStorage.removeItem(t); return true; } catch(e){ return false; }
    }
    function sanitizeInput(input) { if (!input) return ''; const div=document.createElement('div'); div.textContent=input; return div.innerHTML; }
    function formatCurrency(amount) { return new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN' }).format(amount); }
    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function debounce(func, wait){ let timeout; return (...args)=>{ clearTimeout(timeout); timeout=setTimeout(()=>func(...args),wait); }; }

    // NEW: es nuevo si dateAdded <= 7 días
    function isNewProduct(dateAdded){
      if(!dateAdded) return false;
      const now = new Date();
      const added = new Date(dateAdded);
      const diffDays = (now - added) / (1000*60*60*24);
      return diffDays <= 7;
    }

    // Mezcla aleatoria (para no tocar sort global)
    function shuffleArray(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // Carga de datos (misma ruta /products)
    function loadData() {
      try {
        productsContainer.innerHTML = '<div class="col-span-full animate-pulse text-gray-400">Cargando productos…</div>';
        publicTabContent.innerHTML = '<div class="col-span-full animate-pulse text-gray-400">Cargando catálogo…</div>';

        database.ref('products').on('value', (snapshot) => {
          try {
            const val = snapshot.val();
            if (val) {
              // Compatibilidad: si es array u objeto
              products = Array.isArray(val) ? val.filter(Boolean) : Object.values(val);
            } else {
              products = [];
            }
            if (isLocalStorageAvailable()) localStorage.setItem('products', JSON.stringify(products));
            setOffline(false);
            renderAdminProducts();
            renderPublicTabs();
            showToast('Datos sincronizados desde Firebase.');
          } catch (e) {
            console.error('Error procesando snapshot:', e);
            showToast('Error al procesar datos de Firebase. Usando datos locales.', true);
            setOffline(true); useLocalFallback();
          }
        }, (error) => {
          console.error('Listener error:', error);
          showToast('No se pudo sincronizar con Firebase. Usando datos locales.', true);
          setOffline(true); useLocalFallback();
        });
      } catch (error) {
        console.error('Error loading data from Firebase:', error);
        showToast('Error al cargar los datos desde Firebase. Usando datos locales.', true);
        setOffline(true); useLocalFallback();
      }
    }
    function saveData() {
      try {
        database.ref('products').set(products, (err) => {
          if (err) {
            console.error('Error saving:', err);
            showToast('No se pudo guardar en Firebase. Guardado local.', true);
            setOffline(true);
            if (isLocalStorageAvailable()) localStorage.setItem('products', JSON.stringify(products));
          } else {
            if (isLocalStorageAvailable()) localStorage.setItem('products', JSON.stringify(products));
            setOffline(false);
          }
        });
      } catch (error) {
        console.error('Error saving data to Firebase:', error);
        showToast('Error al guardar en Firebase. Guardado local.', true);
        setOffline(true);
        if (isLocalStorageAvailable()) localStorage.setItem('products', JSON.stringify(products));
      }
    }
    function useLocalFallback(){
      if (isLocalStorageAvailable()) {
        const stored = localStorage.getItem('products');
        products = stored ? JSON.parse(stored) : [];
      } else { products = []; }
      renderAdminProducts(); renderPublicTabs();
    }
    function setOffline(state){ isOffline = state; offlineBanner.style.display = state ? 'block' : 'none'; }

    // === Render Admin (se mantiene, sin badge NEW) ===
    function renderAdminProducts() {
      productsContainer.innerHTML = '';
      const searchTerm = sanitizeInput(searchInput.value?.toLowerCase() || '');
      let filtered = [...products];
      if (searchTerm) {
        filtered = filtered.filter(p=>{
          try{
            return p.nombre?.toLowerCase().includes(searchTerm) ||
                   p.itemNumber?.toLowerCase().includes(searchTerm) ||
                   p.description?.toLowerCase().includes(searchTerm) ||
                   p.upc?.toLowerCase().includes(searchTerm);
          }catch(e){ return false; }
        });
      }
      if (!filtered.length) {
        productsContainer.innerHTML = `
          <div class="col-span-full text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">No se encontraron productos</h3>
            <p class="mt-1 text-gray-500">Intenta con otra búsqueda o agrega nuevos productos.</p>
          </div>`;
        return;
      }
      filtered.forEach(product=>{
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover relative';
        card.innerHTML = `
          <input type="checkbox" class="product-checkbox absolute top-4 left-4 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded z-10" data-id="${product.id}">
          <div class="product-image-container relative">
            <img loading="lazy" decoding="async"
              src="${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}"
              alt="${sanitizeInput(product.nombre || 'Producto')}"
              class="product-image"
              onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
          </div>
          <div class="p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
            <div class="flex justify-center">
              <button class="view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all" data-id="${product.id}">
                Ver detalles
              </button>
            </div>
          </div>`;
        productsContainer.appendChild(card);
      });
      updateDeleteButton();
    }

    // === Render Público (aquí sí: nuevos arriba, badge NEW y aleatorio para el resto) ===
    function renderPublicTabs(searchTerm=''){
      publicTabs.innerHTML = '';
      publicTabContent.innerHTML = '';
      publicTabContent.className = 'mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';

      let filtered = [...products];
      const term = (searchTerm || '').toLowerCase();
      if (term) {
        filtered = filtered.filter(p =>
          p.nombre?.toLowerCase().includes(term) ||
          p.upc?.toLowerCase().includes(term) ||
          p.itemNumber?.toLowerCase().includes(term) ||
          p.description?.toLowerCase().includes(term)
        );
      }
      if (!filtered.length) {
        publicTabContent.innerHTML = `
          <div class="col-span-full text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <h3 class="mt-4 text-lg font-medium text-gray-900">No se encontraron productos</h3>
            <p class="mt-1 text-gray-500">Intenta con otra búsqueda.</p>
          </div>`;
        return;
      }
      renderPublicProducts(filtered, publicTabContent);
    }

    function renderPublicProducts(list, container){
      container.innerHTML = '';
      if (!list.length) {
        container.innerHTML = `<div class="col-span-full text-center py-12"><h3 class="mt-4 text-lg font-medium text-gray-900">No hay productos en esta categoría</h3></div>`;
        return;
      }

      const newOnes = list.filter(p => isNewProduct(p.dateAdded));
      const oldOnes = shuffleArray(list.filter(p => !isNewProduct(p.dateAdded)));
      const ordered = [...newOnes, ...oldOnes];

      ordered.forEach(product=>{
        const card = document.createElement('div');
        const isNew = isNewProduct(product.dateAdded);
        card.className = `relative bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover ${isNew ? 'fade-in' : ''}`;
        card.innerHTML = `
          <div class="product-image-container relative">
            <img loading="lazy" decoding="async"
                 src="${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}"
                 alt="${sanitizeInput(product.nombre || 'Producto')}"
                 class="product-image"
                 onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
            ${isNew ? '<span class="new-badge">NEW</span>' : ''}
          </div>
          <div class="p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-1">${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
            <p class="text-sm text-gray-500">${sanitizeInput(product.upc || '')}</p>
            <div class="mt-3 flex justify-center">
              <button class="view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all" data-id="${product.id}">
                Ver detalles
              </button>
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    // Modal detalle (compartido; oculta elementos admin en vista pública)
    function showProductDetails(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) { showToast('Producto no encontrado.', true); return; }
      try {
        document.getElementById('modalProductTitle').textContent = sanitizeInput(product.nombre || 'Sin nombre');
        document.getElementById('productItemNumber').textContent = sanitizeInput(product.itemNumber || 'N/A');
        document.getElementById('productUpc').textContent = sanitizeInput(product.upc || 'N/A');
        document.getElementById('productSize').textContent = sanitizeInput(product.size || 'N/A');
        document.getElementById('productQty').textContent = sanitizeInput(product.qty || 'N/A');
        document.getElementById('productDescription').textContent = sanitizeInput(product.description || 'Sin descripción');
        document.getElementById('productCosto').textContent = formatCurrency(product.costo || 0);

        const imageSrc = document.getElementById('productImageSrc');
        const imagePlaceholder = document.getElementById('productImagePlaceholder');
        if (product.url) {
          imageSrc.src = product.url;
          imageSrc.onerror = () => { imageSrc.classList.add('hidden'); imagePlaceholder.classList.remove('hidden'); };
          imageSrc.classList.remove('hidden'); imagePlaceholder.classList.add('hidden');
        } else {
          imageSrc.classList.add('hidden'); imagePlaceholder.classList.remove('hidden');
        }

        const customFieldsContainer = document.getElementById('customFields');
        customFieldsContainer.innerHTML = '';
        const customFields = product.customFields || {};
        Object.entries(customFields).forEach(([key, value]) => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${sanitizeInput(key)}:</strong> <span class="text-gray-700">${sanitizeInput(value)}</span>`;
          customFieldsContainer.appendChild(p);
        });

        deleteProductBtn.dataset.id = product.id;
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentView === 'admin' ? '' : 'none');
        productDetailModal.classList.remove('hidden');
      } catch (error) {
        console.error('Error showing product details:', error);
        showToast('Error al mostrar los detalles del producto.', true);
      }
    }

    // Acciones auxiliares admin
    function updateDeleteButton() {
      const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
      deleteSelected.disabled = checkedCount === 0;
    }

    // Exportar PDF
    function exportToPDF() {
      try {
        if (!window.jspdf) { showToast('Error: No se pudieron cargar las bibliotecas para exportar PDF.', true); return; }
        const { jsPDF } = window.jspdf;
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<div class="loader inline-block"></div> Exportando...';
        const doc = new jsPDF();
        doc.autoTable({
          head: [['Nombre', 'Descripción', 'Número de Ítem', 'UPC', 'Tamaño', 'Cantidad', 'Costo']],
          body: products.map(product => [
            sanitizeInput(product.nombre || 'N/A'),
            sanitizeInput(product.description || 'N/A'),
            sanitizeInput(product.itemNumber || 'N/A'),
            sanitizeInput(product.upc || 'N/A'),
            sanitizeInput(product.size || 'N/A'),
            sanitizeInput(product.qty || 'N/A'),
            formatCurrency(product.costo || 0)
          ]),
          theme: 'grid',
          headStyles: { fillColor: [99, 102, 241] },
          styles: { font: 'helvetica', fontSize: 10 },
          margin: { top: 20 },
          didDrawPage: function (data) {
            if (data.pageNumber === 1) {
              doc.setFontSize(18);
              doc.text('Catálogo de Productos', data.settings.margin.left, 10);
              doc.setFontSize(10);
              doc.text(`Generado el ${new Date().toLocaleDateString('es-MX')}`, data.settings.margin.left, 15);
            }
          }
        });
        doc.save('catalogo-productos.pdf');
        showToast('Catálogo exportado correctamente a PDF.');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Error al generar el PDF.', true);
      } finally {
        exportBtn.disabled = false;
        exportBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
          </svg>
          Exportar PDF`;
      }
    }

    // Validar formulario
    function validateForm(formId, fields) {
      let isValid = true;
      fields.forEach(field => {
        const element = document.getElementById(field.id);
        const errorElement = document.getElementById(`${field.id}Error`);
        if (!element || !errorElement) return;
        errorElement.classList.add('hidden'); errorElement.textContent = '';
        if (field.required && !element.value.trim()) {
          errorElement.textContent = `${field.label} es obligatorio.`; errorElement.classList.remove('hidden'); isValid = false;
        } else if (field.type === 'number' && element.value && isNaN(parseFloat(element.value))) {
          errorElement.textContent = `Por favor ingresa un valor numérico válido para ${field.label}.`; errorElement.classList.remove('hidden'); isValid = false;
        } else if (field.type === 'int' && element.value && !Number.isInteger(parseFloat(element.value))) {
          errorElement.textContent = `${field.label} debe ser un número entero.`; errorElement.classList.remove('hidden'); isValid = false;
        } else if (field.min !== undefined && parseFloat(element.value) < field.min) {
          errorElement.textContent = `${field.label} debe ser mayor o igual a ${field.min}.`; errorElement.classList.remove('hidden'); isValid = false;
        }
      });
      return isValid;
    }
// Importar productos desde CSV (versión compatible con GitHub Pages + Firebase)
function importFromCSV(file) {
    try {
        if (!window.Papa) {
            showToast('Error: La biblioteca PapaParse no se cargó.', true);
            return;
        }

        const importLoader = document.getElementById('importLoader');
        const importSubmitBtn = document.getElementById('importSubmitBtn');
        importLoader.classList.remove('hidden');
        importSubmitBtn.disabled = true;

        // Usar FileReader en lugar de URL directa (evita errores CORB)
        const reader = new FileReader();
        reader.onload = function (e) {
            const csvData = e.target.result;

            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const importedProducts = [];
                    let errors = 0;

                    const requiredHeaders = ['ITEM NUMBER', 'DESCRIPTION', 'UPC', 'NOMBRE', 'SIZE', 'QTY', 'COSTO'];
                    const csvHeaders = Object.keys(results.data[0] || {});
                    const missingHeaders = requiredHeaders.filter(h => !csvHeaders.includes(h));

                    if (missingHeaders.length > 0) {
                        showToast(`Faltan columnas: ${missingHeaders.join(', ')}`, true);
                        importLoader.classList.add('hidden');
                        importSubmitBtn.disabled = false;
                        return;
                    }

                    results.data.forEach((row, index) => {
                        try {
                            if (!row['UPC']?.trim() || !row['NOMBRE']?.trim()) {
                                errors++;
                                return;
                            }

                            const newProduct = {
                                id: generateId(),
                                itemNumber: sanitizeInput(row['ITEM NUMBER']),
                                description: sanitizeInput(row['DESCRIPTION']),
                                upc: sanitizeInput(row['UPC']),
                                nombre: sanitizeInput(row['NOMBRE']),
                                size: sanitizeInput(row['SIZE'] || ''),
                                qty: parseInt(row['QTY'] || 0),
                                costo: parseFloat(row['COSTO'] || 0),
                                url: sanitizeInput(row['URL'] || ''),
                                customFields: {}
                            };

                            // Agregar campos adicionales como personalizados
                            for (let [key, value] of Object.entries(row)) {
                                if (!['ITEM NUMBER', 'DESCRIPTION', 'UPC', 'NOMBRE', 'SIZE', 'QTY', 'COSTO', 'URL'].includes(key)) {
                                    if (value && value.trim()) {
                                        newProduct.customFields[sanitizeInput(key)] = sanitizeInput(value);
                                    }
                                }
                            }

                            // Actualizar productos existentes
                            const existingProduct = products.find(p => p.upc === newProduct.upc);
                            if (existingProduct) {
                                // Solo actualizar los campos que tienen contenido
                                Object.keys(newProduct).forEach(key => {
                                    if (newProduct[key] && newProduct[key] !== '' && key !== 'id') {
                                        existingProduct[key] = newProduct[key];
                                    }
                                });
                            } else {
                                importedProducts.push(newProduct);
                            }

                        } catch (err) {
                            console.error(`Error en fila ${index + 1}:`, err);
                            errors++;
                        }
                    });

                    products = [...products, ...importedProducts];
                    saveData();
                    renderAdminProducts();
                    renderPublicTabs();

                    const msg = errors > 0
                        ? `Importación completada: ${importedProducts.length} productos nuevos, ${errors} errores.`
                        : `Importación completada: ${importedProducts.length} productos nuevos.`;

                    showToast(msg, errors > 0);
                    importModal.classList.add('hidden');
                    importLoader.classList.add('hidden');
                    importSubmitBtn.disabled = false;
                },
                error: function (error) {
                    console.error('Error al leer el CSV:', error);
                    showToast('Error al leer el archivo CSV.', true);
                    importLoader.classList.add('hidden');
                    importSubmitBtn.disabled = false;
                }
            });
        };

        reader.onerror = function () {
            showToast('Error al cargar el archivo CSV. Intenta nuevamente.', true);
            importLoader.classList.add('hidden');
            importSubmitBtn.disabled = false;
        };

        reader.readAsText(file);

    } catch (error) {
        console.error('Error en importación CSV:', error);
        showToast('Error inesperado al importar el archivo.', true);
        importLoader.classList.add('hidden');
        importSubmitBtn.disabled = false;
    }
}


    // Eventos
    function setupEventListeners(){
      try{
        searchInput.addEventListener('input', debounce(renderAdminProducts, 300));
        publicSearchInput.addEventListener('input', debounce(()=>renderPublicTabs(sanitizeInput(publicSearchInput.value.toLowerCase())),300));

        document.getElementById('closeDetailModal').addEventListener('click',()=>productDetailModal.classList.add('hidden'));
        document.getElementById('closeFormModal').addEventListener('click',()=>productFormModal.classList.add('hidden'));
        document.getElementById('cancelProductBtn').addEventListener('click',()=>productFormModal.classList.add('hidden'));
        document.getElementById('closeImportModal').addEventListener('click',()=>importModal.classList.add('hidden'));

        addProductBtn.addEventListener('click',()=>{
          productForm.reset();
          document.getElementById('productId').value = '';
          document.getElementById('formTitle').textContent = 'Nuevo Producto';
          productFormModal.classList.remove('hidden');
        });

        // Abrir modal de importación (FIX)
        importBtn.addEventListener('click',()=>{
          importForm.reset();
          document.getElementById('fileName').textContent = 'Ningún archivo seleccionado';
          importModal.classList.remove('hidden');
        });

        exportBtn.addEventListener('click', exportToPDF);

        productForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          const fields = [
            { id:'itemNumber', label:'Número de Ítem', required:true },
            { id:'upc', label:'UPC', required:true },
            { id:'nombre', label:'Nombre', required:true },
            { id:'size', label:'Tamaño', required:true },
            { id:'qty', label:'Cantidad', required:true, type:'int', min:0 },
            { id:'costo', label:'Costo', required:true, type:'number', min:0 },
            { id:'description', label:'Descripción', required:true }
          ];
          if (!validateForm('productForm', fields)) return;

          const productId = document.getElementById('productId').value;
          const newProduct = {
            id: productId || generateId(),
            itemNumber: sanitizeInput(document.getElementById('itemNumber').value),
            upc: sanitizeInput(document.getElementById('upc').value),
            nombre: sanitizeInput(document.getElementById('nombre').value),
            size: sanitizeInput(document.getElementById('size').value),
            qty: parseInt(document.getElementById('qty').value),
            costo: parseFloat(document.getElementById('costo').value),
            url: document.getElementById('url').value || '',
            description: sanitizeInput(document.getElementById('description').value),
            customFields: {}
          };

          // Duplicados (UPC / Item Number)
          const duplicate = products.find(p =>
            (p.id !== productId) &&
            (p.upc?.toLowerCase() === newProduct.upc?.toLowerCase() ||
             p.itemNumber?.toLowerCase() === newProduct.itemNumber?.toLowerCase())
          );
          if (duplicate) { showToast('UPC o Número de Ítem ya existe en otro producto.', true); return; }

          if (productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
              const prevCustom = product.customFields || {};
              Object.assign(product, newProduct);
              product.customFields = prevCustom;
              // NO tocar dateAdded en edición
            }
          } else {
            // Nuevo producto: agrega sello temporal
            newProduct.dateAdded = new Date().toISOString();
            products.push(newProduct);
          }
          saveData(); renderAdminProducts(); renderPublicTabs();
          showToast(productId ? 'Producto actualizado correctamente.' : 'Producto agregado correctamente.');
          productFormModal.classList.add('hidden');
        });

        importForm.addEventListener('submit',(e)=>{
          e.preventDefault();
          const fileInput = document.getElementById('csvFile');
          if (fileInput.files.length > 0) importFromCSV(fileInput.files[0]);
          else showToast('Por favor selecciona un archivo CSV.', true);
        });

        document.getElementById('csvFile').addEventListener('change',(e)=>{
          const fileName = e.target.files[0]?.name || 'Ningún archivo seleccionado';
          document.getElementById('fileName').textContent = sanitizeInput(fileName);
        });

        window.addEventListener('click',(e)=>{
          if (e.target === productDetailModal) productDetailModal.classList.add('hidden');
          if (e.target === productFormModal) productFormModal.classList.add('hidden');
          if (e.target === importModal) importModal.classList.add('hidden');
          if (e.target === passwordModal) passwordModal.classList.add('hidden');
        });

        selectAll.addEventListener('change',(e)=>{
          document.querySelectorAll('.product-checkbox').forEach(cb=>{ cb.checked = e.target.checked; });
          updateDeleteButton();
        });

        deleteSelected.addEventListener('click',()=>{
          if (!confirm('¿Eliminar los productos seleccionados?')) return;
          const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
          products = products.filter(p => !selectedIds.includes(p.id));
          saveData(); renderAdminProducts(); renderPublicTabs();
          showToast('Productos eliminados correctamente.'); selectAll.checked = false;
        });

        productsContainer.addEventListener('change',(e)=>{
          if (e.target.classList.contains('product-checkbox')) {
            updateDeleteButton();
            const allChecked = document.querySelectorAll('.product-checkbox').length === document.querySelectorAll('.product-checkbox:checked').length;
            selectAll.checked = allChecked;
          }
        });

        productsContainer.addEventListener('click',(e)=>{
          if (e.target.classList.contains('view-details')) showProductDetails(e.target.dataset.id);
        });
        publicTabContent.addEventListener('click',(e)=>{
          if (e.target.classList.contains('view-details')) showProductDetails(e.target.dataset.id);
        });

        deleteProductBtn.addEventListener('click',()=>{
          const productId = deleteProductBtn.dataset.id;
          if (confirm('¿Eliminar este producto?')) {
            products = products.filter(p => p.id !== productId);
            saveData(); renderAdminProducts(); renderPublicTabs();
            productDetailModal.classList.add('hidden');
            showToast('Producto eliminado correctamente.');
          }
        });

        addCustomFieldBtn.addEventListener('click',()=>{
          customFieldForm.classList.remove('hidden');
          addCustomFieldBtn.classList.add('hidden');
          customKey.value = ''; customValue.value = '';
          saveCustomField.disabled = true;
        });
        cancelCustomField.addEventListener('click',()=>{
          customFieldForm.classList.add('hidden');
          addCustomFieldBtn.classList.remove('hidden');
        });
        saveCustomField.addEventListener('click',()=>{
          const key = sanitizeInput(customKey.value.trim());
          const value = sanitizeInput(customValue.value.trim());
          if (!key) { showToast('La clave es obligatoria.', true); return; }
          const productId = deleteProductBtn.dataset.id;
          const product = products.find(p => p.id === productId);
          if (product) {
            product.customFields = product.customFields || {};
            product.customFields[key] = value;
            saveData(); showProductDetails(productId);
            customFieldForm.classList.add('hidden');
            addCustomFieldBtn.classList.remove('hidden');
            showToast('Campo personalizado agregado correctamente.');
            renderAdminProducts(); renderPublicTabs();
          }
        });

        // Habilitar/deshabilitar botón guardar en custom fields
        function updateSaveCustomButton(){ saveCustomField.disabled = !(customKey.value.trim() && customValue.value.trim()); }
        customKey.addEventListener('input', updateSaveCustomButton);
        customValue.addEventListener('input', updateSaveCustomButton);

        // Cambiar vistas (protección con password modal)
        adminViewBtn.addEventListener('click',()=>{
          passwordModal.classList.remove('hidden');
          adminPasswordInput.focus();
        });
        publicViewBtn.addEventListener('click',()=> showView('public'));
        confirmPassword.addEventListener('click',()=>{
          if (adminPasswordInput.value === adminPassword) { passwordModal.classList.add('hidden'); showView('admin'); }
          else { showToast('Contraseña incorrecta.', true); }
          adminPasswordInput.value = '';
        });
        cancelPassword.addEventListener('click',()=>{
          passwordModal.classList.add('hidden'); adminPasswordInput.value = '';
        });
        adminPasswordInput.addEventListener('keypress',(e)=>{ if (e.key === 'Enter') confirmPassword.click(); });
      }catch(error){
        console.error('Error setupEventListeners:', error);
        showToast('Error al inicializar la aplicación.', true);
      }
    }

    function showView(view){
      currentView = view;
      if (view === 'admin') {
        adminView.classList.remove('hidden');
        publicView.classList.add('hidden');
        adminViewBtn.classList.add('bg-indigo-100');
        publicViewBtn.classList.remove('bg-indigo-100');
        adminButtons.style.display = 'flex';
      } else {
        adminView.classList.add('hidden');
        publicView.classList.remove('hidden');
        adminViewBtn.classList.remove('bg-indigo-100');
        publicViewBtn.classList.add('bg-indigo-100');
        adminButtons.style.display = 'none';
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();
      setupEventListeners();
      // Vista pública por defecto
      showView('public');
    });
  </script>
</body>
</html>
