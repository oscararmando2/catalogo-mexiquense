<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MEXIQUENSE - Catálogo de Productos (V4)</title>

    <!-- Tailwind + fuentes -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- jsPDF / html2canvas / PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

    <!-- Apple Touch Icon (opcional) -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .product-image-container { position: relative; width: 100%; padding-top: 100%; }
        .product-image { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: contain; border-radius:8px; background:#f9f9f9; }
        /* Selección múltiple (admin) */
        .selected-card { outline: 2px solid rgb(59 130 246); background: rgb(239 246 255); }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-4 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                        </svg>
                        <h1 class="text-2xl md:text-3xl font-bold">MEXIQUENSE</h1>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="adminViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Panel de Administración</button>
                        <button id="publicViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Productos</button>
                        <div id="adminButtons" class="flex flex-wrap gap-2">
                            <button id="importBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                                Importar CSV
                            </button>
                            <button id="exportBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                Exportar PDF
                            </button>
                            <button id="addProductBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                                Nuevo Producto
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin View -->
        <section id="adminView" class="flex-grow container mx-auto px-4 py-8 hidden">
            <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                    <div class="flex-grow">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Buscar productos..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 gap-3 mb-4">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="selectAll" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                    <label for="selectAll" class="text-gray-700 font-medium">Seleccionar Todos</label>
                </div>
                <button id="deleteSelected" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Eliminar Seleccionados
                </button>
                <div class="text-sm text-gray-600">Mantén <b>Ctrl</b> (Windows) o <b>Cmd</b> (Mac) y haz clic en los productos para seleccionar varios. También puedes arrastrar para seleccionar.</div>
            </div>

            <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="adminPagination" class="flex justify-center items-center gap-2 mt-6 hidden"></div>
        </section>

        <!-- Public View -->
        <section id="publicView" class="flex-grow container mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4">Catálogo de Productos</h2>
                <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                    <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex-grow">
                            <div class="relative">
                                <input id="publicSearchInput" type="text" placeholder="Buscar productos por nombre o UPC..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="publicTabs" class="flex space-x-4 border-b border-gray-200"></div>
                <div id="publicTabContent" class="mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
                <div id="publicPagination" class="flex justify-center items-center gap-2 mt-6 hidden"></div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4 text-center">
                <p>© 2025 MEXIQUENSE - Sistema de Catálogo</p>
            </div>
        </footer>

        <!-- Modal Detalle -->
        <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="modalProductTitle" class="text-xl font-bold">Detalles del Producto</h3>
                    <button id="closeDetailModal" class="text-white hover:text-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div id="productImage" class="bg-gray-100 rounded-lg h-64 flex items-center justify-center mb-4 overflow-hidden">
                                <img id="productImageSrc" loading="lazy" src="" class="max-h-full max-w-full object-contain hidden" alt="Producto" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';" />
                                <svg id="productImagePlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            </div>
                            <div class="space-y-2" id="productFields">
                                <p><strong>Número de Ítem:</strong> <span id="productItemNumber" class="text-gray-700 cursor-pointer"></span></p>
                                <p><strong>UPC:</strong> <span id="productUpc" class="text-gray-700"></span></p>
                                <p><strong>Tamaño:</strong> <span id="productSize" class="text-gray-700"></span></p>
                                <p><strong>Cantidad:</strong> <span id="productQty" class="text-gray-700"></span></p>
                            </div>
                            <div id="customFields" class="space-y-2 mt-4"></div>
                            <div class="mt-4 admin-only">
                                <button id="addCustomFieldBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Agregar Campo Personalizado</button>
                            </div>
                            <div id="customFieldForm" class="hidden mt-4 space-y-4 admin-only">
                                <div>
                                    <label for="customKey" class="block text-sm font-medium text-gray-700 mb-1">Clave (ej. Palimex):</label>
                                    <input type="text" id="customKey" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                    <p id="customKeyError" class="error-message hidden"></p>
                                </div>
                                <div>
                                    <label for="customValue" class="block text-sm font-medium text-gray-700 mb-1">Valor (ej. $3.80):</label>
                                    <input type="text" id="customValue" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button id="cancelCustomField" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                                    <button id="saveCustomField" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50" disabled>Guardar</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">Descripción</h4>
                            <p id="productDescription" class="text-gray-700 mb-4"></p>
                            <h4 class="text-lg font-semibold mb-2">Costo</h4>
                            <p id="productCosto" class="text-2xl font-bold text-indigo-600 mb-4"></p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 pt-0 admin-only">
                    <button id="deleteProductBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Eliminar</button>
                </div>
            </div>
        </div>

        <!-- Modal Formulario Producto -->
        <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="formTitle" class="text-xl font-bold">Nuevo Producto</h3>
                    <button id="closeFormModal" class="text-white hover:text-indigo-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <form id="productForm" class="space-y-4">
                        <input type="hidden" id="productId" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="itemNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Ítem*</label>
                                <input type="text" id="itemNumber" name="itemNumber" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="itemNumberError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="upc" class="block text-sm font-medium text-gray-700 mb-1">UPC*</label>
                                <input type="text" id="upc" name="upc" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="upcError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre*</label>
                                <input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="nombreError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Tamaño*</label>
                                <input type="text" id="size" name="size" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="sizeError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                                <input type="number" id="qty" name="qty" required min="0" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="qtyError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="costo" class="block text-sm font-medium text-gray-700 mb-1">Costo*</label>
                                <input type="number" id="costo" name="costo" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                <p id="costoError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div>
                            <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen (opcional)</label>
                            <input type="url" id="url" name="url" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción*</label>
                            <textarea id="description" name="description" required rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                            <p id="descriptionError" class="error-message hidden"></p>
                        </div>
                        <div class="pt-4 flex justify-end space-x-2">
                            <button type="button" id="cancelProductBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Guardar Producto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Import CSV -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Importar Productos desde CSV</h3>
                    <button id="closeImportModal" class="text-white hover:text-indigo-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">Sube un archivo CSV con los siguientes encabezados: ITEM NUMBER, DESCRIPTION, UPC, NOMBRE, SIZE, QTY, COSTO, URL (URL es opcional). Usa comas como separador.</p>
                    <form id="importForm" class="space-y-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="csvFile" name="csvFile" accept=".csv" class="hidden" />
                            <label for="csvFile" class="cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                <span class="mt-2 block text-sm font-medium text-indigo-600">Haz clic para seleccionar archivo</span>
                                <span id="fileName" class="mt-1 block text-sm text-gray-500">Ningún archivo seleccionado</span>
                            </label>
                        </div>
                        <div id="importLoader" class="hidden"><div class="loader"></div><p class="text-gray-600 mt-2">Importando...</p></div>
                        <div class="pt-4 flex justify-end"><button type="submit" id="importSubmitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Importar</button></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50"><span id="toastMessage">Operación completada con éxito</span></div>

        <!-- Modal Password Admin -->
        <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-bold text-indigo-600 mb-4">Ingresar Contraseña para Administración</h3>
                <input type="password" id="adminPasswordInput" placeholder="Contraseña" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4" />
                <div class="flex justify-end space-x-2">
                    <button id="cancelPassword" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                    <button id="confirmPassword" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==== Firebase (reemplaza con tus credenciales reales) ====
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI",
            authDomain: "catalogomexiquense.firebaseapp.com",
            databaseURL: "https://catalogomexiquense-default-rtdb.firebaseio.com",
            projectId: "catalogomexiquense",
            storageBucket: "catalogomexiquense.appspot.com",
            messagingSenderId: "TU_SENDER_ID_AQUI",
            appId: "TU_APP_ID_AQUI"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==== Estado ====
        const adminPassword = 'admin123';
        let products = [];
        const selection = new Set();
        let currentView = 'public';
        const PAGE_SIZE = 20;
        let publicCurrentPage = 1;

        // ==== DOM ====
        const productsContainer = document.getElementById('productsContainer');
        const searchInput = document.getElementById('searchInput');
        const publicSearchInput = document.getElementById('publicSearchInput');
        const adminView = document.getElementById('adminView');
        const publicView = document.getElementById('publicView');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const publicViewBtn = document.getElementById('publicViewBtn');
        const publicTabs = document.getElementById('publicTabs');
        const publicTabContent = document.getElementById('publicTabContent');
        const publicPagination = document.getElementById('publicPagination');
        const adminButtons = document.getElementById('adminButtons');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const passwordModal = document.getElementById('passwordModal');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const confirmPassword = document.getElementById('confirmPassword');
        const cancelPassword = document.getElementById('cancelPassword');

        // Modales
        const productDetailModal = document.getElementById('productDetailModal');
        const productFormModal = document.getElementById('productFormModal');
        const importModal = document.getElementById('importModal');

        // Botones/controles admin
        const selectAll = document.getElementById('selectAll');
        const deleteSelected = document.getElementById('deleteSelected');
        const deleteProductBtn = document.getElementById('deleteProductBtn');

        // Campos personalizados
        const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
        const cancelCustomField = document.getElementById('cancelCustomField');
        const saveCustomField = document.getElementById('saveCustomField');

        // Formularios
        const productForm = document.getElementById('productForm');
        const importForm = document.getElementById('importForm');
        const customFieldForm = document.getElementById('customFieldForm');
        const customKey = document.getElementById('customKey');
        const customValue = document.getElementById('customValue');

        // Campos del modal de detalles
        const modalProductTitle = document.getElementById('modalProductTitle');
        const productItemNumber = document.getElementById('productItemNumber');
        const productUpc = document.getElementById('productUpc');
        const productSize = document.getElementById('productSize');
        const productQty = document.getElementById('productQty');
        const productDescription = document.getElementById('productDescription');
        const productCosto = document.getElementById('productCosto');
        const productImageSrc = document.getElementById('productImageSrc');
        const productImagePlaceholder = document.getElementById('productImagePlaceholder');

        // Formulario agregar/editar
        const productIdInput = document.getElementById('productId');
        const itemNumberInput = document.getElementById('itemNumber');
        const upcInput = document.getElementById('upc');
        const nombreInput = document.getElementById('nombre');
        const sizeInput = document.getElementById('size');
        const qtyInput = document.getElementById('qty');
        const costoInput = document.getElementById('costo');
        const urlInput = document.getElementById('url');
        const descriptionInput = document.getElementById('description');
        const formTitle = document.getElementById('formTitle');

        // Import CSV
        const csvFileInput = document.getElementById('csvFile');
        const fileNameText = document.getElementById('fileName');
        const importLoader = document.getElementById('importLoader');
        const importSubmitBtn = document.getElementById('importSubmitBtn');

        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // ==== Utils ====
        function generateId(){ return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function sanitizeInput(input){ if (!input) return ''; const div=document.createElement('div'); div.textContent=input; return div.innerHTML; }
        function formatCurrency(amount){ return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(amount); }
        function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
        function isLocalStorageAvailable(){ try{ localStorage.setItem('__t','__t'); localStorage.removeItem('__t'); return true; }catch{ return false; } }
        function paginate(items, page, pageSize = PAGE_SIZE){ const start = (Math.max(page,1)-1)*pageSize; return items.slice(start, start+pageSize); }
        function renderPagination(container, currentPage, totalPages){
            if(!container) return;
            container.innerHTML = '';
            if(totalPages <= 1){ container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const createButton = (label, page, disabled=false, isActive=false)=>{
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'px-3 py-1 rounded-md border border-gray-300 text-sm font-medium transition-colors';
                if(isActive){ button.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
                else { button.classList.add('bg-white','text-gray-700','hover:bg-indigo-50'); }
                if(disabled){ button.classList.add('opacity-50','cursor-not-allowed'); button.disabled = true; }
                else { button.dataset.page = page; }
                return button;
            };

            container.appendChild(createButton('Anterior', currentPage-1, currentPage===1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
            let endPage = startPage + maxPagesToShow - 1;
            if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxPagesToShow + 1); }

            for(let page=startPage; page<=endPage; page++){
                container.appendChild(createButton(String(page), page, false, page===currentPage));
            }

            container.appendChild(createButton('Siguiente', currentPage+1, currentPage===totalPages));
        }

        function normalizeProducts(data){
            if(!data) return [];
            let items = [];
            if(Array.isArray(data)){ items = data.filter(Boolean); }
            else if(typeof data === 'object'){ items = Object.values(data); }
            else { return []; }
            return items
                .filter(item => item && typeof item === 'object')
                .map(item => ({
                    ...item,
                    customFields: item.customFields || {},
                    dateAdded: item.dateAdded || Date.now()
                }));
        }
        function paginate(items, page, pageSize = PAGE_SIZE){ const start = (Math.max(page,1)-1)*pageSize; return items.slice(start, start+pageSize); }
        function renderPagination(container, currentPage, totalPages){
            if(!container) return;
            container.innerHTML = '';
            if(totalPages <= 1){ container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const createButton = (label, page, disabled=false, isActive=false)=>{
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'px-3 py-1 rounded-md border border-gray-300 text-sm font-medium transition-colors';
                if(isActive){ button.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
                else { button.classList.add('bg-white','text-gray-700','hover:bg-indigo-50'); }
                if(disabled){ button.classList.add('opacity-50','cursor-not-allowed'); button.disabled = true; }
                else { button.dataset.page = page; }
                return button;
            };

            container.appendChild(createButton('Anterior', currentPage-1, currentPage===1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
            let endPage = startPage + maxPagesToShow - 1;
            if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxPagesToShow + 1); }

            for(let page=startPage; page<=endPage; page++){
                container.appendChild(createButton(String(page), page, false, page===currentPage));
            }

            container.appendChild(createButton('Siguiente', currentPage+1, currentPage===totalPages));
        }

        function normalizeProducts(raw){
            if(raw == null) return [];

            const coerceItem = (item, fallbackId)=>{
                if(!item || typeof item !== 'object') return null;
                const normalized = { ...item };
                const providedId = normalized.id != null ? String(normalized.id) : undefined;
                normalized.id = providedId || (fallbackId != null ? String(fallbackId) : generateId());
                normalized.customFields = normalized.customFields && typeof normalized.customFields === 'object' && !Array.isArray(normalized.customFields)
                    ? normalized.customFields
                    : {};
                normalized.dateAdded = typeof normalized.dateAdded === 'number' ? normalized.dateAdded : Date.now();
                return normalized;
            };

            if(typeof raw === 'string'){
                try{ return normalizeProducts(JSON.parse(raw)); }
                catch{ return []; }
            }

            if(Array.isArray(raw)){
                return raw
                    .filter(Boolean)
                    .map((item, index)=> coerceItem(item, index))
                    .filter(Boolean);
            }

            if(typeof raw === 'object'){
                if(Array.isArray(raw.products)) return normalizeProducts(raw.products);
                return Object.entries(raw)
                    .map(([key, value])=> coerceItem(value, key))
                    .filter(Boolean);
            }

            return [];
        }
        function paginate(items, page, pageSize = PAGE_SIZE){ const start = (Math.max(page,1)-1)*pageSize; return items.slice(start, start+pageSize); }
        function renderPagination(container, currentPage, totalPages){
            if(!container) return;
            container.innerHTML = '';
            if(totalPages <= 1){ container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const createButton = (label, page, disabled=false, isActive=false)=>{
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'px-3 py-1 rounded-md border border-gray-300 text-sm font-medium transition-colors';
                if(isActive){ button.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
                else { button.classList.add('bg-white','text-gray-700','hover:bg-indigo-50'); }
                if(disabled){ button.classList.add('opacity-50','cursor-not-allowed'); button.disabled = true; }
                else { button.dataset.page = page; }
                return button;
            };

            container.appendChild(createButton('Anterior', currentPage-1, currentPage===1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
            let endPage = startPage + maxPagesToShow - 1;
            if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxPagesToShow + 1); }

            for(let page=startPage; page<=endPage; page++){
                container.appendChild(createButton(String(page), page, false, page===currentPage));
            }

            container.appendChild(createButton('Siguiente', currentPage+1, currentPage===totalPages));
        }

        function normalizeProducts(raw){
            if(raw == null) return [];

            const indicativeKeys = ['itemNumber','nombre','description','upc','qty','costo','size','customFields','url','dateAdded'];
            const hasProductShape = (candidate)=>{
                if(!candidate || typeof candidate !== 'object' || Array.isArray(candidate)) return false;
                return indicativeKeys.some((key)=> key in candidate);
            };

            const coerceItem = (item, fallbackId)=>{
                if(!item || typeof item !== 'object') return null;
                const normalized = { ...item };
                const providedId = normalized.id != null ? String(normalized.id) : undefined;
                normalized.id = providedId || (fallbackId != null ? String(fallbackId) : generateId());
                normalized.customFields = normalized.customFields && typeof normalized.customFields === 'object' && !Array.isArray(normalized.customFields)
                    ? normalized.customFields
                    : {};
                normalized.dateAdded = typeof normalized.dateAdded === 'number' ? normalized.dateAdded : Date.now();
                return normalized;
            };

            if(typeof raw === 'string'){
                try{ return normalizeProducts(JSON.parse(raw)); }
                catch{ return []; }
            }

            if(Array.isArray(raw)){
                const results = [];
                raw.forEach((item, index)=>{
                    if(item == null) return;
                    if(typeof item === 'string'){
                        results.push(...normalizeProducts(item));
                        return;
                    }
                    if(Array.isArray(item) || (typeof item === 'object' && !hasProductShape(item))){
                        results.push(...normalizeProducts(item));
                        return;
                    }
                    const normalized = coerceItem(item, index);
                    if(normalized) results.push(normalized);
                });
                return results;
            }

            if(typeof raw === 'object'){
                const results = [];
                const containerKeys = ['products','items','data','records','list'];

                containerKeys.forEach((key)=>{
                    if(Object.prototype.hasOwnProperty.call(raw, key)){
                        const value = raw[key];
                        if(hasProductShape(value)){
                            const normalized = coerceItem(value, key);
                            if(normalized) results.push(normalized);
                        }else{
                            results.push(...normalizeProducts(value));
                        }
                    }
                });

                Object.entries(raw).forEach(([key, value])=>{
                    if(value == null || containerKeys.includes(key)) return;
                    if(typeof value === 'string'){
                        results.push(...normalizeProducts(value));
                        return;
                    }
                    if(Array.isArray(value) || (typeof value === 'object' && !hasProductShape(value))){
                        results.push(...normalizeProducts(value));
                        return;
                    }
                    const normalized = coerceItem(value, key);
                    if(normalized) results.push(normalized);
                });

                return results;
            }

            return [];
        }
        function paginate(items, page, pageSize = PAGE_SIZE){ const start = (Math.max(page,1)-1)*pageSize; return items.slice(start, start+pageSize); }
        function renderPagination(container, currentPage, totalPages){
            if(!container) return;
            container.innerHTML = '';
            if(totalPages <= 1){ container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const createButton = (label, page, disabled=false, isActive=false)=>{
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'px-3 py-1 rounded-md border border-gray-300 text-sm font-medium transition-colors';
                if(isActive){ button.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
                else { button.classList.add('bg-white','text-gray-700','hover:bg-indigo-50'); }
                if(disabled){ button.classList.add('opacity-50','cursor-not-allowed'); button.disabled = true; }
                else { button.dataset.page = page; }
                return button;
            };

            container.appendChild(createButton('Anterior', currentPage-1, currentPage===1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
            let endPage = startPage + maxPagesToShow - 1;
            if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxPagesToShow + 1); }

            for(let page=startPage; page<=endPage; page++){
                container.appendChild(createButton(String(page), page, false, page===currentPage));
            }

            container.appendChild(createButton('Siguiente', currentPage+1, currentPage===totalPages));
        }

        function normalizeProducts(raw){
            if(raw == null) return [];

            const canonicalKey = (key)=> String(key || '')
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '');

            const aliasGroups = {
                itemNumber: ['itemnumber','itemcode','codigo','codigoitem','sku','clave','claveproducto'],
                nombre: ['nombre','name','producto','productoname','productname','titulo','title','nombreproducto'],
                description: ['description','descripcion','descripcionlarga','detalle','detalles','descripccion'],
                upc: ['upc','barcode','codigobarras','codbarras','ean','ean13'],
                size: ['size','tamano','tamanho','tamaño','presentation','presentacion'],
                qty: ['qty','cantidad','existencia','stock','inventario','cant','existencias'],
                costo: ['costo','price','precio','precioventa','preciounitario','valor','cost'],
                url: ['url','imagen','image','img','foto','fotourl','imageurl','picture'],
                proveedor: ['proveedor','supplier','vendor','palimex'],
                category: ['categoria','category','departamento','familia','seccion'],
                dateAdded: ['dateadded','fecha','fechaingreso','fechacreacion','createdat','creadoel','timestamp']
            };

            const indicativeKeys = new Set([
                'itemnumber','nombre','description','descripcion','upc','qty','cantidad','costo','price','size','tamano','tamano','url','imagen','customfields','dateadded'
            ]);

            const hasProductShape = (candidate)=>{
                if(!candidate || typeof candidate !== 'object' || Array.isArray(candidate)) return false;
                const keys = Object.keys(candidate);
                if(keys.length === 0) return false;
                const canonicalKeys = keys.map(canonicalKey);
                if(canonicalKeys.some((key)=> indicativeKeys.has(key))) return true;
                const primitiveCount = keys.reduce((count, key)=>{
                    const value = candidate[key];
                    return (value == null || typeof value !== 'object') ? count + 1 : count;
                }, 0);
                return primitiveCount >= 2;
            };

            const buildAliasLookup = (item)=>{
                const lookup = {};
                Object.entries(item || {}).forEach(([key, value])=>{
                    const canon = canonicalKey(key);
                    if(!canon) return;
                    if(!(canon in lookup)) lookup[canon] = { key, value };
                });
                return lookup;
            };

            const parseNumber = (value, { integer=false }={})=>{
                if(value == null || value === '') return undefined;
                if(typeof value === 'number') return integer ? Math.trunc(value) : value;
                if(typeof value === 'string'){
                    const cleaned = value.replace(/[^0-9,.-]/g,'').replace(/,/g,'.');
                    const parsed = cleaned ? Number.parseFloat(cleaned) : Number.NaN;
                    if(Number.isNaN(parsed)) return undefined;
                    return integer ? Math.trunc(parsed) : parsed;
                }
                return undefined;
            };

            const coerceItem = (item, fallbackId)=>{
                if(!item || typeof item !== 'object') return null;
                const aliasLookup = buildAliasLookup(item);
                const findAliasValue = (aliases=[])=>{
                    for(const alias of aliases){
                        const entry = aliasLookup[alias];
                        if(entry && entry.value != null && entry.value !== '') return entry.value;
                    }
                    return undefined;
                };

                const normalized = { ...item };
                const providedId = normalized.id != null ? String(normalized.id) : undefined;
                normalized.id = providedId || (fallbackId != null ? String(fallbackId) : generateId());

                const assignString = (targetKey, group)=>{
                    if(normalized[targetKey] != null && String(normalized[targetKey]).trim() !== '') return;
                    const value = findAliasValue(aliasGroups[group] || []);
                    if(value != null && value !== '') normalized[targetKey] = String(value).trim();
                };

                const assignNumber = (targetKey, group, opts)=>{
                    const existing = parseNumber(normalized[targetKey], opts);
                    if(existing != null) { normalized[targetKey] = existing; return; }
                    const value = findAliasValue(aliasGroups[group] || []);
                    const parsed = parseNumber(value, opts);
                    if(parsed != null) normalized[targetKey] = parsed;
                };

                assignString('itemNumber','itemNumber');
                assignString('nombre','nombre');
                assignString('description','description');
                assignString('upc','upc');
                assignString('size','size');
                assignString('url','url');
                assignString('proveedor','proveedor');
                assignString('category','category');
                assignNumber('qty','qty',{ integer:true });
                assignNumber('costo','costo');

                if(!normalized.nombre || String(normalized.nombre).trim() === ''){
                    const fallbackName = normalized.description || findAliasValue(aliasGroups.description || []) || normalized.itemNumber;
                    if(fallbackName) normalized.nombre = String(fallbackName).trim();
                }

                const aliasDate = findAliasValue(aliasGroups.dateAdded || []);
                if(typeof normalized.dateAdded !== 'number'){
                    const parsedDate = typeof normalized.dateAdded === 'string' ? Date.parse(normalized.dateAdded) : undefined;
                    const parsedAliasDate = typeof aliasDate === 'number' ? aliasDate : (typeof aliasDate === 'string' ? Date.parse(aliasDate) : undefined);
                    normalized.dateAdded = Number.isFinite(parsedDate) ? parsedDate : (Number.isFinite(parsedAliasDate) ? parsedAliasDate : Date.now());
                }

                normalized.customFields = normalized.customFields && typeof normalized.customFields === 'object' && !Array.isArray(normalized.customFields)
                    ? { ...normalized.customFields }
                    : {};

                const recognized = new Set(['id','customfields','dateadded']);
                Object.values(aliasGroups).forEach((aliases)=> aliases.forEach((alias)=> recognized.add(alias)));

                Object.entries(item).forEach(([key, value])=>{
                    const canon = canonicalKey(key);
                    if(recognized.has(canon)) return;
                    if(value == null) return;
                    if(typeof value === 'object') return;
                    const safeKey = String(key).trim();
                    if(!safeKey) return;
                    normalized.customFields[safeKey] = String(value).trim();
                });

                return normalized;
            };

            if(typeof raw === 'string'){
                try{ return normalizeProducts(JSON.parse(raw)); }
                catch{ return []; }
            }

            const dedupe = (list)=>{
                const map = new Map();
                list.forEach((item)=>{ if(item && item.id){ map.set(item.id, item); } });
                return Array.from(map.values());
            };

            if(Array.isArray(raw)){
                const results = [];
                raw.forEach((item, index)=>{
                    if(item == null) return;
                    if(typeof item === 'string'){
                        results.push(...normalizeProducts(item));
                        return;
                    }
                    if(Array.isArray(item) || (typeof item === 'object' && !hasProductShape(item))){
                        results.push(...normalizeProducts(item));
                        return;
                    }
                    const normalized = coerceItem(item, index);
                    if(normalized) results.push(normalized);
                });
                return dedupe(results);
            }

            if(typeof raw === 'object'){
                const results = [];
                const containerKeys = ['products','items','data','records','list','entries','children','catalog','productos','articulos'];

                containerKeys.forEach((key)=>{
                    if(Object.prototype.hasOwnProperty.call(raw, key)){
                        const value = raw[key];
                        if(hasProductShape(value)){
                            const normalized = coerceItem(value, key);
                            if(normalized) results.push(normalized);
                        }else{
                            results.push(...normalizeProducts(value));
                        }
                    }
                });

                Object.entries(raw).forEach(([key, value])=>{
                    if(value == null || containerKeys.includes(key)) return;
                    if(typeof value === 'string'){
                        results.push(...normalizeProducts(value));
                        return;
                    }
                    if(Array.isArray(value) || (typeof value === 'object' && !hasProductShape(value))){
                        results.push(...normalizeProducts(value));
                        return;
                    }
                    const normalized = coerceItem(value, key);
                    if(normalized) results.push(normalized);
                });

                if(results.length === 0 && hasProductShape(raw)){
                    const normalized = coerceItem(raw);
                    if(normalized) results.push(normalized);
                }

                return dedupe(results);
            }

            return [];
        }
        function paginate(items, page, pageSize = PAGE_SIZE){ const start = (Math.max(page,1)-1)*pageSize; return items.slice(start, start+pageSize); }
        function renderPagination(container, currentPage, totalPages){
            if(!container) return;
            container.innerHTML = '';
            if(totalPages <= 1){ container.classList.add('hidden'); return; }
            container.classList.remove('hidden');

            const createButton = (label, page, disabled=false, isActive=false)=>{
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'px-3 py-1 rounded-md border border-gray-300 text-sm font-medium transition-colors';
                if(isActive){ button.classList.add('bg-indigo-600','text-white','border-indigo-600'); }
                else { button.classList.add('bg-white','text-gray-700','hover:bg-indigo-50'); }
                if(disabled){ button.classList.add('opacity-50','cursor-not-allowed'); button.disabled = true; }
                else { button.dataset.page = page; }
                return button;
            };

            container.appendChild(createButton('Anterior', currentPage-1, currentPage===1));

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
            let endPage = startPage + maxPagesToShow - 1;
            if(endPage > totalPages){ endPage = totalPages; startPage = Math.max(1, endPage - maxPagesToShow + 1); }

            for(let page=startPage; page<=endPage; page++){
                container.appendChild(createButton(String(page), page, false, page===currentPage));
            }

            container.appendChild(createButton('Siguiente', currentPage+1, currentPage===totalPages));
        }

        // === NUEVO: ¿producto es "NEW"? (7 días) ===
        function isNewProduct(product){
            if(!product || !product.dateAdded) return false;
            const sevenDays = 7*24*60*60*1000;
            return (Date.now() - product.dateAdded) < sevenDays;
        }

        // ==== Load & Save ====
        function loadData(){
            try{
                database.ref('products').on('value', (snapshot)=>{
                    products = normalizeProducts(snapshot.val());
                    renderAdminProducts();
                    renderPublicTabs();
                    showToast('Datos sincronizados desde Firebase.');
                });
            }catch(err){
                console.error('Firebase load error:', err);
                showToast('Error al cargar desde Firebase. Usando localStorage.', true);
                if(isLocalStorageAvailable()){
                    const stored = localStorage.getItem('products');
                    products = normalizeProducts(stored ? JSON.parse(stored) : []);
                    renderAdminProducts();
                    renderPublicTabs();
                } else { products = []; }
            }
        }
        function saveData(){
            try{ database.ref('products').set(products); }
            catch(err){
                console.error('Firebase save error:', err);
                showToast('Error al guardar en Firebase. Guardando en localStorage.', true);
                if(isLocalStorageAvailable()) localStorage.setItem('products', JSON.stringify(products));
            }
        }

        // ==== Render ADMIN (con selección Ctrl/Cmd + drag) ====
        function renderAdminProducts(){
            if(!productsContainer) return;
            productsContainer.innerHTML = '';
            const q = (searchInput?.value || '').toLowerCase();
            let filtered = [...products];
            if(q){
                filtered = filtered.filter(p=>{
                    try{
                        return p?.nombre?.toLowerCase().includes(q) || p?.itemNumber?.toLowerCase().includes(q) || p?.description?.toLowerCase().includes(q);
                    }catch{ return false; }
                });
            }
            if(filtered.length===0){
                productsContainer.innerHTML = `<div class="col-span-full text-center py-12"><svg xmlns='http://www.w3.org/2000/svg' class='h-16 w-16 mx-auto text-gray-400' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/></svg><h3 class='mt-4 text-lg font-medium text-gray-900'>No se encontraron productos</h3><p class='mt-1 text-gray-500'>Intenta con otra búsqueda o agrega nuevos productos.</p></div>`;
                if(adminPagination){ adminPagination.innerHTML=''; adminPagination.classList.add('hidden'); }
                updateDeleteButton();
                return;
            }
            const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
            if(adminCurrentPage > totalPages) adminCurrentPage = totalPages;
            if(adminCurrentPage < 1) adminCurrentPage = 1;
            const paginatedProducts = paginate(filtered, adminCurrentPage);
            paginatedProducts.forEach(product=>{
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover relative';
                card.dataset.id = product.id;
                if(selection.has(product.id)) card.classList.add('selected-card');
                card.innerHTML = `
                    <div class='product-image-container relative'>
                        <img loading='lazy' src='${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}' alt='${sanitizeInput(product.nombre || 'Producto')}' class='product-image' onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                    </div>
                    <div class='p-5'>
                        <h3 class='text-lg font-semibold text-gray-900 mb-2'>${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                        <div class='flex justify-center'>
                            <button class='view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all' data-id='${product.id}'>Ver detalles</button>
                        </div>
                    </div>`;
                // Selección Ctrl/Cmd
                card.addEventListener('click', (e)=>{
                    if(e.ctrlKey || e.metaKey){ e.preventDefault(); e.stopPropagation(); toggleSelection(product.id, card); return; }
                });
                productsContainer.appendChild(card);
            });
            renderPagination(adminPagination, adminCurrentPage, totalPages);
            updateDeleteButton();
        }

        // ==== Render PUBLIC (NEW solo aquí) ====
        function renderPublicTabs(searchTerm=''){
            publicTabs.innerHTML = '';
            publicTabContent.innerHTML = '';
            publicTabContent.className = 'mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';

            let filtered = [...products];
            if(searchTerm){
                const s = searchTerm.toLowerCase();
                filtered = filtered.filter(p=> p?.nombre?.toLowerCase().includes(s) || p?.upc?.toLowerCase().includes(s));
            }
            if(filtered.length===0){
                publicTabContent.innerHTML = `<div class='col-span-full text-center py-12'><svg xmlns='http://www.w3.org/2000/svg' class='h-16 w-16 mx-auto text-gray-400' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/></svg><h3 class='mt-4 text-lg font-medium text-gray-900'>No se encontraron productos</h3><p class='mt-1 text-gray-500'>Intenta con otra búsqueda.</p></div>`;
                if(publicPagination){ publicPagination.innerHTML=''; publicPagination.classList.add('hidden'); }
                return;
            }
            // Orden: nuevos primero, viejos aleatorios
            const newOnes = filtered.filter(isNewProduct);
            const oldOnes = filtered.filter(p=> !isNewProduct(p));
            for(let i=oldOnes.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [oldOnes[i], oldOnes[j]]=[oldOnes[j], oldOnes[i]]; }
            const ordered = [...newOnes, ...oldOnes];

            const totalPages = Math.max(1, Math.ceil(ordered.length / PAGE_SIZE));
            if(publicCurrentPage > totalPages) publicCurrentPage = totalPages;
            if(publicCurrentPage < 1) publicCurrentPage = 1;
            const paginated = paginate(ordered, publicCurrentPage);
            renderPublicProducts(paginated, publicTabContent);
            renderPagination(publicPagination, publicCurrentPage, totalPages);
        }

        function renderPublicProducts(list, container){
            container.innerHTML = '';
            list.forEach(product=>{
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover';
                card.innerHTML = `
                    <div class='product-image-container relative'>
                        ${isNewProduct(product) ? `<span class='absolute top-2 left-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md animate-pulse'>NEW</span>` : ''}
                        <img loading='lazy' src='${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}' alt='${sanitizeInput(product.nombre || 'Producto')}' class='product-image' onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                    </div>
                    <div class='p-5'>
                        <h3 class='text-lg font-semibold text-gray-900 mb-2'>${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                        <div class='flex justify-center'>
                            <button class='view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all' data-id='${product.id}'>Ver detalles</button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        // ==== Selección (admin) ====
        function toggleSelection(id, cardEl){ if(selection.has(id)) selection.delete(id); else selection.add(id); if(cardEl) cardEl.classList.toggle('selected-card'); updateDeleteButton(); }
        function clearSelection(){ selection.clear(); document.querySelectorAll('#productsContainer [data-id]').forEach(c=>c.classList.remove('selected-card')); updateDeleteButton(); }
        function updateDeleteButton(){ deleteSelected.disabled = selection.size===0; const total=document.querySelectorAll('#productsContainer [data-id]').length; const selected=document.querySelectorAll('#productsContainer .selected-card').length; selectAll.checked = total>0 && selected===total; }

        // ==== Detalles ====
        function showProductDetails(productId){
            const product = products.find(p=> p.id===productId);
            if(!product){ showToast('Producto no encontrado.', true); return; }
            try{
                modalProductTitle.textContent = sanitizeInput(product.nombre || 'Sin nombre');
                productItemNumber.textContent = sanitizeInput(product.itemNumber || 'N/A');
                productUpc.textContent = sanitizeInput(product.upc || 'N/A');
                productSize.textContent = sanitizeInput(product.size || 'N/A');
                productQty.textContent = sanitizeInput(String(product.qty ?? 'N/A'));
                productDescription.textContent = sanitizeInput(product.description || 'Sin descripción');
                productCosto.textContent = formatCurrency(product.costo || 0);

                if(product.url){
                    productImageSrc.src = product.url;
                    productImageSrc.onerror = ()=>{ productImageSrc.classList.add('hidden'); productImagePlaceholder.classList.remove('hidden'); };
                    productImageSrc.classList.remove('hidden');
                    productImagePlaceholder.classList.add('hidden');
                }else{
                    productImageSrc.classList.add('hidden');
                    productImagePlaceholder.classList.remove('hidden');
                }
                // Custom fields
                const customFieldsContainer = document.getElementById('customFields');
                customFieldsContainer.innerHTML = '';
                const customFields = product.customFields || {};
                Object.entries(customFields).forEach(([k,v])=>{
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${sanitizeInput(k)}:</strong> <span class='text-gray-700'>${sanitizeInput(v)}</span>`;
                    customFieldsContainer.appendChild(p);
                });
                deleteProductBtn.dataset.id = product.id;
                document.querySelectorAll('.admin-only').forEach(el=> el.style.display = currentView==='admin' ? '' : 'none');
                productDetailModal.classList.remove('hidden');
            }catch(e){ console.error('Error mostrando detalles:', e); showToast('Error al mostrar detalles.', true); }
        }
// ==== Import CSV ====
function importFromCSV(file) {
  try {
    if (!window.Papa) {
      showToast('Error: PapaParse no se cargó.', true);
      return;
    }

    importLoader.classList.remove('hidden');
    importSubmitBtn.disabled = true;

    const reader = new FileReader();

    reader.onload = function(e) {
      let text = e.target.result;

      // 💡 Eliminar BOM si viene de Numbers
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      // 🔍 Detectar delimitador automáticamente
      const firstLine = text.split('\n')[0];
      let delimiter = ';';
      if ((firstLine.match(/,/g) || []).length > (firstLine.match(/;/g) || []).length) delimiter = ',';
      if ((firstLine.match(/\t/g) || []).length > (firstLine.match(/;/g) || []).length) delimiter = '\t';

      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        delimiter: delimiter,
        transformHeader: (header) => header.trim().replace(/["']/g, '').toUpperCase(), // 💪 Limpieza total de encabezados
        complete: (results) => {
          const imported = [];
          let errors = 0;

          if (!results.data || results.data.length === 0) {
            showToast('El archivo está vacío o tiene formato incorrecto.', true);
            importLoader.classList.add('hidden');
            importSubmitBtn.disabled = false;
            return;
          }

          results.data.forEach((row, idx) => {
            try {
              if (!row || Object.values(row).every(v => v === '')) return;

              // Normalizamos las claves del objeto row
              const cleanRow = {};
              for (const [key, val] of Object.entries(row)) {
                cleanRow[key.trim().toUpperCase()] = val;
              }

              const newProduct = {
                id: generateId(),
                itemNumber: sanitizeInput(String(cleanRow['ITEM NUMBER'] || '').trim()),
                description: sanitizeInput(String(cleanRow['DESCRIPTION'] || '').trim()),
                upc: sanitizeInput(String(cleanRow['UPC'] || '').trim()),
                nombre: sanitizeInput(String(cleanRow['NOMBRE'] || '').trim()),
                size: cleanRow['SIZE'] ? sanitizeInput(String(cleanRow['SIZE']).trim()) : null,
                qty: cleanRow['QTY'] && !isNaN(cleanRow['QTY']) ? parseInt(cleanRow['QTY']) : 0,
                costo: cleanRow['COSTO'] && !isNaN(parseFloat(String(cleanRow['COSTO']).replace(',', '.')))
                  ? parseFloat(String(cleanRow['COSTO']).replace(',', '.'))
                  : 0,
                url: cleanRow['URL'] ? sanitizeInput(String(cleanRow['URL']).trim()) : '',
                proveedor: cleanRow['PALIMEX'] ? sanitizeInput(String(cleanRow['PALIMEX']).trim()) : '',
                customFields: {},
                dateAdded: Date.now()
              };

              // Guarda PALIMEX también como customField si existe
              if (cleanRow['PALIMEX']) {
                newProduct.customFields['PALIMEX'] = sanitizeInput(String(cleanRow['PALIMEX']).trim());
              }

              // Guardar campos extra como personalizados
              for (const [key, val] of Object.entries(cleanRow)) {
                if (!['ITEM NUMBER','DESCRIPTION','UPC','NOMBRE','SIZE','QTY','COSTO','URL','PALIMEX'].includes(key)) {
                  if (val != null && val !== '') {
                    newProduct.customFields[sanitizeInput(key)] = sanitizeInput(String(val).trim());
                  }
                }
              }

              // Actualizar o agregar producto
              const existing = products.find(p =>
                (p.itemNumber && p.itemNumber === newProduct.itemNumber) ||
                (p.upc && p.upc === newProduct.upc)
              );

              if (existing) {
                Object.assign(existing, { ...newProduct, dateAdded: existing.dateAdded || newProduct.dateAdded });
              } else {
                imported.push(newProduct);
              }

            } catch (e) {
              console.error(`Error en fila ${idx + 1}:`, e);
              errors++;
            }
          });

          products = [...products, ...imported];
          saveData();
          renderAdminProducts();
          renderPublicTabs();

          const msg = errors > 0
            ? `Importados ${imported.length} productos, ${errors} errores.`
            : `Importados ${imported.length} productos correctamente.`;
          showToast(msg, errors > 0);

          importModal.classList.add('hidden');
          importLoader.classList.add('hidden');
          importSubmitBtn.disabled = false;
        },
        error: (err) => {
          console.error('CSV parse error:', err);
          showToast('Error al procesar el CSV.', true);
          importLoader.classList.add('hidden');
          importSubmitBtn.disabled = false;
        }
      });
    };

    reader.readAsText(file, 'UTF-8');
  } catch (e) {
    console.error('Import error:', e);
    showToast('Error al importar CSV.', true);
    importLoader.classList.add('hidden');
    importSubmitBtn.disabled = false;
  }
}
        // ==== Validación + libs + vistas ====
        function validateForm(_, fields){
            let ok=true;
            fields.forEach(f=>{
                const el=document.getElementById(f.id); const errEl=document.getElementById(`${f.id}Error`);
                if(!el||!errEl) return; errEl.classList.add('hidden'); errEl.textContent='';
                if(f.required && !el.value.trim()){ errEl.textContent=`${f.label} es obligatorio.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.type==='number' && el.value && isNaN(parseFloat(el.value))){ errEl.textContent=`Ingresa un número válido para ${f.label}.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.type==='int' && el.value && !Number.isInteger(parseFloat(el.value))){ errEl.textContent=`${f.label} debe ser entero.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.min!=null && parseFloat(el.value)<f.min){ errEl.textContent=`${f.label} debe ser ≥ ${f.min}.`; errEl.classList.remove('hidden'); ok=false; }
            });
            return ok;
        }
        function checkLibraries(){ if(!window.Papa) showToast('Error: PapaParse no se cargó.', true); if(!window.jspdf || !window.html2canvas) showToast('Error: librerías PDF no cargadas.', true); }
        function showView(view){ currentView=view; if(view==='admin'){ adminView.classList.remove('hidden'); publicView.classList.add('hidden'); adminViewBtn.classList.add('bg-indigo-100'); publicViewBtn.classList.remove('bg-indigo-100'); adminButtons.style.display='flex'; } else { adminView.classList.add('hidden'); publicView.classList.remove('hidden'); adminViewBtn.classList.remove('bg-indigo-100'); publicViewBtn.classList.add('bg-indigo-100'); adminButtons.style.display='none'; } }

        // ==== Export PDF ====
        function exportToPDF(){
            try{
                if(!window.jspdf){ showToast('No se pudo cargar jsPDF.', true); return; }
                const { jsPDF } = window.jspdf;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<div class="loader inline-block"></div> Exportando...';
                const doc = new jsPDF();
                doc.autoTable({
                    head: [[ 'Nombre','Descripción','Número de Ítem','UPC','Tamaño','Cantidad','Costo' ]],
                    body: products.map(p=> [ sanitizeInput(p.nombre||'N/A'), sanitizeInput(p.description||'N/A'), sanitizeInput(p.itemNumber||'N/A'), sanitizeInput(p.upc||'N/A'), sanitizeInput(p.size||'N/A'), sanitizeInput(p.qty||'N/A'), formatCurrency(p.costo||0) ]),
                    theme: 'grid', headStyles:{ fillColor:[99,102,241] }, styles:{ font:'helvetica', fontSize:10 }, margin:{ top:20 },
                    didDrawPage: (data)=>{ if(data.pageNumber===1){ doc.setFontSize(18); doc.text('Catálogo de Productos', data.settings.margin.left, 10); doc.setFontSize(10); doc.text(`Generado el ${new Date().toLocaleDateString('es-MX')}`, data.settings.margin.left, 15); } }
                });
                doc.save('catalogo-productos.pdf');
                showToast('Catálogo exportado correctamente a PDF.');
            }catch(e){ console.error('PDF error:', e); showToast('Error al generar el PDF.', true); }
            finally{ exportBtn.disabled=false; exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>Exportar PDF`; }
        }

        // ==== Toast ====
        function showToast(message, isError=false){
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 flex items-center z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
            toast.classList.remove('translate-y-20','opacity-0');
            setTimeout(()=> toast.classList.add('translate-y-20','opacity-0'), 3000);
        }

        // ==== Eventos ====
        function setupEventListeners(){
            // Búsquedas
            if(searchInput) searchInput.addEventListener('input', debounce(()=>{ renderAdminProducts(); }, 300));
            publicSearchInput.addEventListener('input', debounce(()=>{ publicCurrentPage = 1; renderPublicTabs(sanitizeInput(publicSearchInput.value)); }, 300));

            // Paginación
            if(publicPagination){
                publicPagination.addEventListener('click', (e)=>{
                    const btn = e.target.closest('button[data-page]');
                    if(!btn) return;
                    publicCurrentPage = parseInt(btn.dataset.page, 10) || 1;
                    renderPublicTabs(sanitizeInput(publicSearchInput.value));
                });
            }

            // Cierre modales
            document.getElementById('closeDetailModal').addEventListener('click', ()=> productDetailModal.classList.add('hidden'));
            document.getElementById('closeFormModal').addEventListener('click', ()=> productFormModal.classList.add('hidden'));
            document.getElementById('cancelProductBtn').addEventListener('click', ()=> productFormModal.classList.add('hidden'));
            document.getElementById('closeImportModal').addEventListener('click', ()=> importModal.classList.add('hidden'));

            // Nuevo producto
            addProductBtn.addEventListener('click', ()=>{ productForm.reset(); productIdInput.value=''; formTitle.textContent='Nuevo Producto'; productFormModal.classList.remove('hidden'); });

            // Import CSV
            importBtn.addEventListener('click', ()=>{ importForm.reset(); fileNameText.textContent='Ningún archivo seleccionado'; importModal.classList.remove('hidden'); });
            importForm.addEventListener('submit', (e)=>{ e.preventDefault(); const f=csvFileInput.files?.[0]; if(f) importFromCSV(f); else showToast('Selecciona un archivo CSV.', true); });
            csvFileInput.addEventListener('change', (e)=>{ fileNameText.textContent = sanitizeInput(e.target.files[0]?.name || 'Ningún archivo seleccionado'); });

            // Export PDF
            exportBtn.addEventListener('click', exportToPDF);

            // Delegación ver detalles
            productsContainer.addEventListener('click', (e)=>{ const btn=e.target.closest('.view-details'); if(btn) showProductDetails(btn.dataset.id); });
            publicTabContent.addEventListener('click', (e)=>{ const btn=e.target.closest('.view-details'); if(btn) showProductDetails(btn.dataset.id); });

            // Eliminar individual desde modal
            deleteProductBtn.addEventListener('click', ()=>{
                const id = deleteProductBtn.dataset.id;
                if(confirm('¿Eliminar este producto?')){
                    products = products.filter(p=> p.id!==id);
                    saveData(); renderAdminProducts(); renderPublicTabs(); productDetailModal.classList.add('hidden'); showToast('Producto eliminado correctamente.');
                    if(selection.has(id)) selection.delete(id); updateDeleteButton();
                }
            });

            // Custom fields
            addCustomFieldBtn.addEventListener('click', ()=>{ customFieldForm.classList.remove('hidden'); addCustomFieldBtn.classList.add('hidden'); customKey.value=''; customValue.value=''; saveCustomField.disabled=true; });
            cancelCustomField.addEventListener('click', ()=>{ customFieldForm.classList.add('hidden'); addCustomFieldBtn.classList.remove('hidden'); });
            function updateSaveCustomButton(){ saveCustomField.disabled = !(customKey.value.trim() && customValue.value.trim()); }
            customKey.addEventListener('input', updateSaveCustomButton); customValue.addEventListener('input', updateSaveCustomButton);
            saveCustomField.addEventListener('click', ()=>{
                const key=sanitizeInput(customKey.value.trim()); const value=sanitizeInput(customValue.value.trim()); if(!key){ showToast('La clave es obligatoria.', true); return; }
                const id=deleteProductBtn.dataset.id; const product=products.find(p=> p.id===id);
                if(product){ if(!product.customFields) product.customFields={}; product.customFields[key]=value; saveData(); showProductDetails(id); customFieldForm.classList.add('hidden'); addCustomFieldBtn.classList.remove('hidden'); showToast('Campo personalizado agregado.'); renderAdminProducts(); renderPublicTabs(); }
            });

            // Vista admin/public
            adminViewBtn.addEventListener('click', ()=>{ passwordModal.classList.remove('hidden'); adminPasswordInput.focus(); });
            publicViewBtn.addEventListener('click', ()=> showView('public'));
            confirmPassword.addEventListener('click', ()=>{ if(adminPasswordInput.value===adminPassword){ passwordModal.classList.add('hidden'); showView('admin'); } else showToast('Contraseña incorrecta.', true); adminPasswordInput.value=''; });
            cancelPassword.addEventListener('click', ()=>{ passwordModal.classList.add('hidden'); adminPasswordInput.value=''; });
            adminPasswordInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') confirmPassword.click(); });

            // Seleccionar todos
            selectAll.addEventListener('change', (e)=>{
                const cards=document.querySelectorAll('#productsContainer [data-id]');
                if(e.target.checked){ cards.forEach(card=>{ const id=card.dataset.id; if(!selection.has(id)) selection.add(id); card.classList.add('selected-card'); }); }
                else { clearSelection(); }
                updateDeleteButton();
            });
            // Eliminar seleccionados
            deleteSelected.addEventListener('click', ()=>{ if(selection.size===0) return; if(!confirm(`¿Eliminar ${selection.size} productos seleccionados?`)) return; const ids=new Set(selection); products = products.filter(p=> !ids.has(p.id)); saveData(); renderAdminProducts(); renderPublicTabs(); clearSelection(); showToast('Productos eliminados correctamente.'); });

            // Cerrar modales clic fuera
            window.addEventListener('click', (e)=>{ if(e.target===productDetailModal) productDetailModal.classList.add('hidden'); if(e.target===productFormModal) productFormModal.classList.add('hidden'); if(e.target===importModal) importModal.classList.add('hidden'); if(e.target===passwordModal) passwordModal.classList.add('hidden'); });

            // Guardar producto (alta/edición)
            productForm.addEventListener('submit', (e)=>{
                e.preventDefault();
                const fields=[
                    { id:'itemNumber', label:'Número de Ítem', required:true },
                    { id:'upc', label:'UPC', required:true },
                    { id:'nombre', label:'Nombre', required:true },
                    { id:'size', label:'Tamaño', required:true },
                    { id:'qty', label:'Cantidad', required:true, type:'int', min:0 },
                    { id:'costo', label:'Costo', required:true, type:'number', min:0 },
                    { id:'description', label:'Descripción', required:true }
                ];
                if(!validateForm('productForm', fields)) return;
                const productId=productIdInput.value;
                const newProduct={
                    id: productId || generateId(),
                    itemNumber: sanitizeInput(itemNumberInput.value),
                    description: sanitizeInput(descriptionInput.value),
                    upc: sanitizeInput(upcInput.value),
                    nombre: sanitizeInput(nombreInput.value),
                    size: sanitizeInput(sizeInput.value),
                    qty: parseInt(qtyInput.value),
                    costo: parseFloat(costoInput.value),
                    url: urlInput.value || '',
                    customFields: {},
                    dateAdded: Date.now() // NUEVO: necesario para badge "NEW"
                };
                if(productId){
                    const p = products.find(x=> x.id===productId);
                    if(p){ newProduct.customFields = p.customFields || {}; newProduct.dateAdded = p.dateAdded || newProduct.dateAdded; Object.assign(p, newProduct); }
                } else { products.push(newProduct); }
                saveData(); renderAdminProducts(); renderPublicTabs(); showToast(productId ? 'Producto actualizado correctamente.' : 'Producto agregado correctamente.'); productFormModal.classList.add('hidden');
            });
        }

        // ==== Drag selection (admin) ====
        (function enableDragSelection(){
            let isDragging=false, startX=0, startY=0, selectionBox=null;
            const container = document.getElementById('productsContainer');
            if(!container) return;
            container.addEventListener('mousedown', (e)=>{
                if(e.target.closest('button') || e.target.closest('input') || e.target.closest('svg')) return;
                isDragging=true; startX=e.pageX; startY=e.pageY;
                selectionBox=document.createElement('div');
                Object.assign(selectionBox.style,{ position:'absolute', border:'2px solid rgba(59,130,246,0.7)', background:'rgba(59,130,246,0.2)', pointerEvents:'none', zIndex:'9999' });
                document.body.appendChild(selectionBox);
            });
            document.addEventListener('mousemove', (e)=>{
                if(!isDragging||!selectionBox) return; const x1=Math.min(e.pageX,startX), y1=Math.min(e.pageY,startY), x2=Math.max(e.pageX,startX), y2=Math.max(e.pageY,startY);
                selectionBox.style.left=`${x1}px`; selectionBox.style.top=`${y1}px`; selectionBox.style.width=`${x2-x1}px`; selectionBox.style.height=`${y2-y1}px`;
            });
            document.addEventListener('mouseup', ()=>{
                if(!isDragging) return; isDragging=false; if(selectionBox){ const rect=selectionBox.getBoundingClientRect(); document.querySelectorAll('#productsContainer [data-id]').forEach(card=>{ const cr=card.getBoundingClientRect(); const overlap = !(rect.right<cr.left || rect.left>cr.right || rect.bottom<cr.top || rect.top>cr.bottom); if(overlap){ const id=card.dataset.id; selection.add(id); card.classList.add('selected-card'); } }); updateDeleteButton(); document.body.removeChild(selectionBox); selectionBox=null; }
            });
            document.addEventListener('mouseleave', ()=>{ if(isDragging){ isDragging=false; if(selectionBox){ document.body.removeChild(selectionBox); selectionBox=null; } } });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && selectionBox){ isDragging=false; document.body.removeChild(selectionBox); selectionBox=null; } });
        })();

        // ==== Edición inline del Item Code (solo admin) ====
        (function enableInlineItemEdit(){
            const itemSpan = document.getElementById('productItemNumber'); if(!itemSpan) return;
            itemSpan.addEventListener('click', ()=>{
                if(currentView!=='admin') return;
                const currentValue=itemSpan.textContent.trim();
                const input=document.createElement('input'); input.type='text'; input.value=currentValue==='N/A' ? '' : currentValue; input.className='border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent'; input.style.width='100px';
                itemSpan.replaceWith(input); input.focus();
                const saveChange=()=>{
                    const newValue=input.value.trim()||'N/A'; const productId=deleteProductBtn.dataset.id; const product=products.find(p=> p.id===productId); if(!product) return; product.itemNumber=newValue; saveData(); const newSpan=document.createElement('span'); newSpan.id='productItemNumber'; newSpan.className='text-gray-700 cursor-pointer'; newSpan.textContent=newValue; input.replaceWith(newSpan); showToast('Item Code actualizado correctamente.'); renderAdminProducts(); renderPublicTabs(); enableInlineItemEdit();
                };
                input.addEventListener('blur', saveChange); input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') input.blur(); });
            });
        })();

        // ==== Init ====
        function init(){ loadData(); setupEventListeners(); checkLibraries(); showView('public'); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
