<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEXIQUENSE - Catálogo de Productos</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .product-image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Aspect ratio 1:1 for square */
        }
        .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Show full image without cropping */
            border-radius: 8px;
            background-color: #f9f9f9; /* Light background for transparency */
        }
        .department-card {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-4 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                        </svg>
                        <h1 class="text-2xl md:text-3xl font-bold">MEXIQUENSE</h1>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="adminViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Panel de Administración</button>
                        <button id="publicViewBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium transition-all">Productos</button>
                        <div id="adminButtons" class="flex flex-wrap gap-2">
                            <button id="importBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                                Importar CSV
                            </button>
                            <button id="exportBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Exportar PDF
                            </button>
                            <button id="addProductBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                Nuevo Producto
                            </button>
                            <button id="manageDepartmentsBtn" class="bg-white text-indigo-600 hover:bg-indigo-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                                </svg>
                                Gestionar Departamentos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Admin View (Panel de Administración) -->
        <section id="adminView" class="flex-grow container mx auto px-4 py-8 hidden">
            <!-- Search and Filter Bar -->
            <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                    <div class="flex-grow">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Buscar productos..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Actions -->
            <div class="flex items-center space-x-4 mb-4">
                <input type="checkbox" id="selectAll" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="selectAll" class="text-gray-700 font-medium">Seleccionar Todos</label>
                <button id="deleteSelected" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Eliminar Seleccionados</button>
            </div>
            <!-- Products Grid for Admin -->
            <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be dynamically inserted here -->
            </div>
        </section>
        <!-- Public View (Productos) -->
        <section id="publicView" class="flex-grow container mx auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4">Catálogo de Productos</h2>
                <!-- Search Bar for Public View -->
                <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                    <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex-grow">
                            <div class="relative">
                                <input id="publicSearchInput" type="text" placeholder="Buscar productos por nombre o UPC..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="departmentTabs" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Department cards will be dynamically inserted here -->
                </div>
                <div id="publicTabContent" class="mt-6">
                    <!-- Product grids for each department will be inserted here -->
                </div>
            </div>
        </section>
        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx auto px-4 text-center">
                <p>© 2025 MEXIQUENSE - Sistema de Catálogo</p>
            </div>
        </footer>
        <!-- Modal for Product Details (shared for both views, but no edit/delete in public) -->
        <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="modalProductTitle" class="text-xl font-bold">Detalles del Producto</h3>
                    <button id="closeDetailModal" class="text-white hover:text-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div id="productImage" class="bg-gray-100 rounded-lg h-64 flex items-center justify-center mb-4 overflow-hidden">
                                <img id="productImageSrc" src="" class="max-h-full max-w-full object-contain hidden" alt="Producto" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                                <svg id="productImagePlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="space-y-2" id="productFields">
                                <p><strong>Número de Ítem:</strong> <span id="productItemNumber" class="text-gray-700"></span></p>
                                <p><strong>UPC:</strong> <span id="productUpc" class="text-gray-700"></span></p>
                                <p><strong>Tamaño:</strong> <span id="productSize" class="text-gray-700"></span></p>
                                <p><strong>Cantidad:</strong> <span id="productQty" class="text-gray-700"></span></p>
                                <p class="admin-only"><strong>Departamento:</strong> <span id="productDepartment" class="text-gray-700"></span></p>
                                <div class="admin-only mt-4">
                                    <label for="departmentSelect" class="block text-sm font-medium text-gray-700 mb-1">Asignar Departamento</label>
                                    <select id="departmentSelect" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        <option value="">Sin Categoría</option>
                                        <!-- Options will be dynamically added -->
                                    </select>
                                    <button id="saveDepartmentBtn" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Guardar Departamento</button>
                                </div>
                            </div>
                            <div id="customFields" class="space-y-2 mt-4"></div>
                            <div class="mt-4 admin-only">
                                <button id="addCustomFieldBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Agregar Campo Personalizado</button>
                            </div>
                            <div id="customFieldForm" class="hidden mt-4 space-y-4 admin-only">
                                <div>
                                    <label for="customKey" class="block text-sm font-medium text-gray-700 mb-1">Clave (ej. Palimex):</label>
                                    <input type="text" id="customKey" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <p id="customKeyError" class="error-message hidden"></p>
                                </div>
                                <div>
                                    <label for="customValue" class="block text-sm font-medium text-gray-700 mb-1">Valor (ej. $3.80):</label>
                                    <input type="text" id="customValue" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button id="cancelCustomField" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                                    <button id="saveCustomField" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50" disabled>Guardar</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">Descripción</h4>
                            <p id="productDescription" class="text-gray-700 mb-4"></p>
                            <h4 class="text-lg font-semibold mb-2">Costo</h4>
                            <p id="productCosto" class="text-2xl font-bold text-indigo-600 mb-4"></p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 pt-0 admin-only">
                    <button id="deleteProductBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Eliminar</button>
                </div>
            </div>
        </div>
        <!-- Modal for Add/Edit Product (only for admin) -->
        <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="formTitle" class="text-xl font-bold">Nuevo Producto</h3>
                    <button id="closeFormModal" class="text-white hover:text-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <form id="productForm" class="space-y-4">
                        <input type="hidden" id="productId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="itemNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Ítem*</label>
                                <input type="text" id="itemNumber" name="itemNumber" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="itemNumberError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="upc" class="block text-sm font-medium text-gray-700 mb-1">UPC*</label>
                                <input type="text" id="upc" name="upc" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="upcError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre*</label>
                                <input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="nombreError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Tamaño*</label>
                                <input type="text" id="size" name="size" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="sizeError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                                <input type="number" id="qty" name="qty" required min="0" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="qtyError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="costo" class="block text-sm font-medium text-gray-700 mb-1">Costo*</label>
                                <input type="number" id="costo" name="costo" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <p id="costoError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div>
                            <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen (opcional)</label>
                            <input type="url" id="url" name="url" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción*</label>
                            <textarea id="description" name="description" required rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                            <p id="descriptionError" class="error-message hidden"></p>
                        </div>
                        <div class="pt-4 flex justify-end space-x-2">
                            <button type="button" id="cancelProductBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Guardar Producto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal for Import CSV (only for admin) -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                <div class="bg-indigo-600 text-white px-6 py-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Importar Productos desde CSV</h3>
                    <button id="closeImportModal" class="text-white hover:text-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">Sube un archivo CSV con los siguientes encabezados: ITEM NUMBER, DESCRIPTION, UPC, NOMBRE, SIZE, QTY, COSTO, URL (URL es opcional). Usa comas como separador.</p>
                    <form id="importForm" class="space-y-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="csvFile" name="csvFile" accept=".csv" class="hidden">
                            <label for="csvFile" class="cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <span class="mt-2 block text-sm font-medium text-indigo-600">Haz clic para seleccionar archivo</span>
                                <span id="fileName" class="mt-1 block text-sm text-gray-500">Ningún archivo seleccionado</span>
                            </label>
                        </div>
                        <div id="importLoader" class="hidden">
                            <div class="loader"></div>
                            <p class="text-gray-600 mt-2">Importando...</p>
                        </div>
                        <div class="pt-4 flex justify-end">
                            <button type="submit" id="importSubmitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Importar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
            <span id="toastMessage">Operación completada con éxito</span>
        </div>
        <!-- Modal for Admin Password -->
        <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-bold text-indigo-600 mb-4">Ingresar Contraseña para Administración</h3>
                <input type="password" id="adminPasswordInput" placeholder="Contraseña" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <div class="flex justify-end space-x-2">
                    <button id="cancelPassword" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                    <button id="confirmPassword" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Configuración de Firebase - REEMPLAZA ESTOS PLACEHOLDERS CON TUS VALORES REALES DE LA CONSOLA DE FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY_AQUI", // Ejemplo: "AIzaSyD...123"
            authDomain: "catalogomexiquense.firebaseapp.com", // Ejemplo: "tu-proyecto.firebaseapp.com"
            databaseURL: "https://catalogomexiquense-default-rtdb.firebaseio.com", // Este es el que mencionaste, sin :null
            projectId: "catalogomexiquense", // Ejemplo: "tu-proyecto-id"
            storageBucket: "catalogomexiquense.appspot.com", // Ejemplo: "tu-proyecto.appspot.com"
            messagingSenderId: "TU_SENDER_ID_AQUI", // Ejemplo: "123456789"
            appId: "TU_APP_ID_AQUI" // Ejemplo: "1:123456789:web:abcdef123456"
        };
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Asegurarse de que la variable products esté inicializada
        let products = [];

        // Load data from Firebase (sincronización en tiempo real)
        function loadData() {
            try {
                // Escuchar cambios en tiempo real en Firebase
                database.ref('products').on('value', (snapshot) => {
                    products = snapshot.val() || [];
                    renderAdminProducts();
                    renderPublicTabs();
                    showToast('Datos sincronizados desde Firebase.');
                });
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                showToast('Error al cargar los datos desde Firebase. Usando localStorage como fallback.', true);
                // Fallback a localStorage si Firebase falla
                if (isLocalStorageAvailable()) {
                    const storedProducts = localStorage.getItem('products');
                    products = storedProducts ? JSON.parse(storedProducts) : [];
                    renderAdminProducts();
                    renderPublicTabs();
                } else {
                    products = [];
                }
            }
        }

        // Save data to Firebase
        function saveData() {
            try {
                database.ref('products').set(products);
            } catch (error) {
                console.error('Error saving data to Firebase:', error);
                showToast('Error al guardar los datos en Firebase. Usando localStorage como fallback.', true);
                // Fallback a localStorage si Firebase falla
                if (isLocalStorageAvailable()) {
                    localStorage.setItem('products', JSON.stringify(products));
                }
            }
        }

        // Verificar si localStorage está disponible (para fallback)
        function isLocalStorageAvailable() {
            try {
                const test = '__test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        // DOM Elements
        const productsContainer = document.getElementById('productsContainer');
        const searchInput = document.getElementById('searchInput');
        const publicSearchInput = document.getElementById('publicSearchInput');
        const adminView = document.getElementById('adminView');
        const publicView = document.getElementById('publicView');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const publicViewBtn = document.getElementById('publicViewBtn');
        const publicTabs = document.getElementById('publicTabs');
        const publicTabContent = document.getElementById('publicTabContent');
        const adminButtons = document.getElementById('adminButtons');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        // Modals
        const productDetailModal = document.getElementById('productDetailModal');
        const productFormModal = document.getElementById('productFormModal');
        const importModal = document.getElementById('importModal');
        const passwordModal = document.getElementById('passwordModal');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const confirmPassword = document.getElementById('confirmPassword');
        const cancelPassword = document.getElementById('cancelPassword');
        // Buttons
        const selectAll = document.getElementById('selectAll');
        const deleteSelected = document.getElementById('deleteSelected');
        const deleteProductBtn = document.getElementById('deleteProductBtn');
        const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
        const cancelCustomField = document.getElementById('cancelCustomField');
        const saveCustomField = document.getElementById('saveCustomField');
        // Forms
        const productForm = document.getElementById('productForm');
        const importForm = document.getElementById('importForm');
        const customFieldForm = document.getElementById('customFieldForm');
        const customKey = document.getElementById('customKey');
        const customValue = document.getElementById('customValue');
        // Current view state
        let currentView = 'admin';
        // Initialize the application
        function init() {
            loadData();
            setupEventListeners();
            checkLibraries();
            showView('admin');
        }
        // Generate a unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        // Sanitize input to prevent XSS
        function sanitizeInput(input) {
            if (!input) return '';
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        }
        // Render products in admin grid
        function renderAdminProducts() {
            productsContainer.innerHTML = '';
            const searchTerm = sanitizeInput(searchInput.value.toLowerCase());
            let filteredProducts = [...products];
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => {
                    try {
                        return (
                            product.nombre?.toLowerCase().includes(searchTerm) ||
                            product.itemNumber?.toLowerCase().includes(searchTerm) ||
                            product.description?.toLowerCase().includes(searchTerm)
                        );
                    } catch (error) {
                        console.error('Error filtering product:', product, error);
                        return false;
                    }
                });
            }
            if (filteredProducts.length === 0) {
                productsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No se encontraron productos</h3>
                        <p class="mt-1 text-gray-500">Intenta con otra búsqueda o agrega nuevos productos.</p>
                    </div>
                `;
                return;
            }
            filteredProducts.forEach(product => {
                try {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover relative';
                    card.innerHTML = `
                        <input type="checkbox" class="product-checkbox absolute top-4 left-4 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded z-10" data-id="${product.id}">
                        <div class="product-image-container relative">
                            <img src="${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}" alt="${sanitizeInput(product.nombre || 'Producto')}" class="product-image" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                            <div class="flex justify-center">
                                <button class="view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all" data-id="${product.id}">
                                    Ver detalles
                                </button>
                            </div>
                        </div>
                    `;
                    productsContainer.appendChild(card);
                } catch (error) {
                    console.error('Error rendering product:', product, error);
                }
            });
            updateDeleteButton();
        }
        // Render public content without size tabs
        function renderPublicTabs(searchTerm = '') {
            publicTabs.innerHTML = ''; // Vaciar tabs, ya que no se usan
            publicTabContent.innerHTML = '';
            publicTabContent.className = 'mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'; // Ajuste para mostrar 2 columnas en móviles para ver más productos por pantalla
            let filteredProducts = [...products];
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => {
                    return (
                        product.nombre?.toLowerCase().includes(searchTerm) ||
                        product.upc?.toLowerCase().includes(searchTerm)
                    );
                });
            }
            if (filteredProducts.length === 0) {
                publicTabContent.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No se encontraron productos</h3>
                        <p class="mt-1 text-gray-500">Intenta con otra búsqueda.</p>
                    </div>
                `;
                return;
            }
            // Renderizar todos los productos en una sola cuadrícula
            renderPublicProducts(filteredProducts, publicTabContent);
        }
        // Helper to create tab button (no se usa ahora, pero se mantiene por si se necesita en futuro)
        function createTabButton(label, id, active = false) {
            const btn = document.createElement('button');
            btn.className = `public-tab-btn px-4 py-2 text-sm font-medium ${active ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}`;
            btn.textContent = label;
            btn.dataset.tab = id;
            return btn;
        }
        // Helper to create tab content div (no se usa ahora, pero se mantiene)
        function createTabContent(id, active = false) {
            const div = document.createElement('div');
            div.id = `tab-${id}`;
            div.className = `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 ${active ? '' : 'hidden'}`;
            return div;
        }
        // Render products in public view
        function renderPublicProducts(filteredProducts, container) {
            container.innerHTML = '';
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No hay productos en esta categoría</h3>
                    </div>
                `;
                return;
            }
            filteredProducts.forEach(product => {
                try {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover';
                    card.innerHTML = `
                        <div class="product-image-container relative">
                            <img src="${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}" alt="${sanitizeInput(product.nombre || 'Producto')}" class="product-image" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                            <div class="flex justify-center">
                                <button class="view-details bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all" data-id="${product.id}">
                                    Ver detalles
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                } catch (error) {
                    console.error('Error rendering public product:', product, error);
                }
            });
        }
        // Update delete selected button state (admin only)
        function updateDeleteButton() {
            const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
            deleteSelected.disabled = checkedCount === 0;
        }
        // Show product details in modal (shared, but hide admin elements in public view)
        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showToast('Producto no encontrado.', true);
                return;
            }
            try {
                document.getElementById('modalProductTitle').textContent = sanitizeInput(product.nombre || 'Sin nombre');
                document.getElementById('productItemNumber').textContent = sanitizeInput(product.itemNumber || 'N/A');
                document.getElementById('productUpc').textContent = sanitizeInput(product.upc || 'N/A');
                document.getElementById('productSize').textContent = sanitizeInput(product.size || 'N/A');
                document.getElementById('productQty').textContent = sanitizeInput(product.qty || 'N/A');
                document.getElementById('productDescription').textContent = sanitizeInput(product.description || 'Sin descripción');
                document.getElementById('productCosto').textContent = formatCurrency(product.costo || 0);
                const imageSrc = document.getElementById('productImageSrc');
                const imagePlaceholder = document.getElementById('productImagePlaceholder');
                if (product.url) {
                    imageSrc.src = product.url;
                    imageSrc.onerror = () => {
                        imageSrc.classList.add('hidden');
                        imagePlaceholder.classList.remove('hidden');
                    };
                    imageSrc.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                } else {
                    imageSrc.classList.add('hidden');
                    imagePlaceholder.classList.remove('hidden');
                }
                // Render custom fields
                const customFieldsContainer = document.getElementById('customFields');
                customFieldsContainer.innerHTML = '';
                const customFields = product.customFields || {};
                Object.entries(customFields).forEach(([key, value]) => {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${sanitizeInput(key)}:</strong> <span class="text-gray-700">${sanitizeInput(value)}</span>`;
                    customFieldsContainer.appendChild(p);
                });
                deleteProductBtn.dataset.id = product.id;
                // Hide admin-only elements if in public view
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = currentView === 'admin' ? '' : 'none');
                productDetailModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error showing product details:', error);
                showToast('Error al mostrar los detalles del producto.', true);
            }
        }
        // Import products from CSV
        function importFromCSV(file) {
            try {
                if (!window.Papa) {
                    showToast('Error: La biblioteca PapaParse no se cargó.', true);
                    return;
                }
                const importLoader = document.getElementById('importLoader');
                const importSubmitBtn = document.getElementById('importSubmitBtn');
                importLoader.classList.remove('hidden');
                importSubmitBtn.disabled = true;
                Papa.parse(file, {
                    header: true,
                    delimiter: ',',
                    skipEmptyLines: true,
                    complete: function(results) {
                        const importedProducts = [];
                        let errors = 0;
                        const requiredHeaders = ['ITEM NUMBER', 'DESCRIPTION', 'UPC', 'NOMBRE', 'SIZE', 'QTY', 'COSTO'];
                        const csvHeaders = Object.keys(results.data[0] || {});
                        const missingHeaders = requiredHeaders.filter(header => !csvHeaders.includes(header));
                        if (missingHeaders.length > 0) {
                            showToast(`Faltan encabezados en el CSV: ${missingHeaders.join(', ')}.`, true);
                            importLoader.classList.add('hidden');
                            importSubmitBtn.disabled = false;
                            return;
                        }
                        if (!results.data || results.data.length === 0) {
                            showToast('El archivo CSV está vacío.', true);
                            importLoader.classList.add('hidden');
                            importSubmitBtn.disabled = false;
                            return;
                        }
                        results.data.forEach((row, index) => {
                            try {
                                if (!row['ITEM NUMBER']?.trim() || !row['DESCRIPTION']?.trim() || !row['UPC']?.trim() ||
                                    !row['NOMBRE']?.trim() || !row['SIZE']?.trim() || !row['QTY']?.trim() || !row['COSTO']?.trim()) {
                                    errors++;
                                    return;
                                }
                                if (isNaN(parseInt(row['QTY'])) || isNaN(parseFloat(row['COSTO']))) {
                                    errors++;
                                    return;
                                }
                                const newProduct = {
                                    id: generateId(),
                                    itemNumber: sanitizeInput(row['ITEM NUMBER']),
                                    description: sanitizeInput(row['DESCRIPTION']),
                                    upc: sanitizeInput(row['UPC']),
                                    nombre: sanitizeInput(row['NOMBRE']),
                                    size: sanitizeInput(row['SIZE']),
                                    qty: parseInt(row['QTY']),
                                    costo: parseFloat(row['COSTO']),
                                    url: row['URL'] ? sanitizeInput(row['URL'].trim()) : '',
                                    customFields: {}
                                };
                                // Add extra columns as custom fields
                                for (let [k, v] of Object.entries(row)) {
                                    if (!['ITEM NUMBER', 'DESCRIPTION', 'UPC', 'NOMBRE', 'SIZE', 'QTY', 'COSTO', 'URL'].includes(k)) {
                                        newProduct.customFields[sanitizeInput(k)] = sanitizeInput(v?.trim() || '');
                                    }
                                }
                                const existingProduct = products.find(p => p.itemNumber === newProduct.itemNumber || p.upc === newProduct.upc);
                                if (existingProduct) {
                                    Object.assign(existingProduct, newProduct);
                                } else {
                                    importedProducts.push(newProduct);
                                }
                            } catch (error) {
                                console.error(`Error en fila ${index + 1}:`, row, error);
                                errors++;
                            }
                        });
                        products = [...products, ...importedProducts];
                        saveData();
                        renderAdminProducts();
                        renderPublicTabs();
                        const message = errors > 0
                            ? `Importación completada: ${importedProducts.length} productos nuevos, ${errors} errores.`
                            : `Importación completada: ${importedProducts.length} productos nuevos.`;
                        showToast(message, errors > 0);
                        importModal.classList.add('hidden');
                        importLoader.classList.add('hidden');
                        importSubmitBtn.disabled = false;
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        showToast('Error al procesar el archivo CSV.', true);
                        importLoader.classList.add('hidden');
                        importSubmitBtn.disabled = false;
                    }
                });
            } catch (error) {
                console.error('Error en importación de CSV:', error);
                showToast('Error al importar el archivo CSV.', true);
                importLoader.classList.add('hidden');
                importSubmitBtn.disabled = false;
            }
        }
        // Validate form inputs
        function validateForm(formId, fields) {
            let isValid = true;
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                const errorElement = document.getElementById(`${field.id}Error`);
                if (!element || !errorElement) return;
                errorElement.classList.add('hidden');
                errorElement.textContent = '';
                if (field.required && !element.value.trim()) {
                    errorElement.textContent = `${field.label} es obligatorio.`;
                    errorElement.classList.remove('hidden');
                    isValid = false;
                } else if (field.type === 'number' && element.value && isNaN(parseFloat(element.value))) {
                    errorElement.textContent = `Por favor ingresa un valor numérico válido para ${field.label}.`;
                    errorElement.classList.remove('hidden');
                    isValid = false;
                } else if (field.type === 'int' && element.value && !Number.isInteger(parseFloat(element.value))) {
                    errorElement.textContent = `${field.label} debe ser un número entero.`;
                    errorElement.classList.remove('hidden');
                    isValid = false;
                } else if (field.min && parseFloat(element.value) < field.min) {
                    errorElement.textContent = `${field.label} debe ser mayor o igual a ${field.min}.`;
                    errorElement.classList.remove('hidden');
                    isValid = false;
                }
            });
            return isValid;
        }
        // Check if required libraries are loaded
        function checkLibraries() {
            if (!window.Papa) {
                showToast('Error: La biblioteca PapaParse no se cargó.', true);
            }
            if (!window.jspdf || !window.html2canvas) {
                showToast('Error: Las bibliotecas para exportar PDF no se cargaron.', true);
            }
        }
        // Show specific view
        function showView(view) {
            currentView = view;
            if (view === 'admin') {
                adminView.classList.remove('hidden');
                publicView.classList.add('hidden');
                adminViewBtn.classList.add('bg-indigo-100');
                publicViewBtn.classList.remove('bg-indigo-100');
                adminButtons.style.display = 'flex';
            } else {
                adminView.classList.add('hidden');
                publicView.classList.remove('hidden');
                adminViewBtn.classList.remove('bg-indigo-100');
                publicViewBtn.classList.add('bg-indigo-100');
                adminButtons.style.display = 'none';
            }
        }
        // Setup event listeners
        function setupEventListeners() {
            try {
                searchInput.addEventListener('input', debounce(renderAdminProducts, 300));
                publicSearchInput.addEventListener('input', debounce(() => renderPublicTabs(sanitizeInput(publicSearchInput.value.toLowerCase())), 300));
                document.getElementById('closeDetailModal').addEventListener('click', () => productDetailModal.classList.add('hidden'));
                document.getElementById('closeFormModal').addEventListener('click', () => productFormModal.classList.add('hidden'));
                document.getElementById('cancelProductBtn').addEventListener('click', () => productFormModal.classList.add('hidden'));
                document.getElementById('closeImportModal').addEventListener('click', () => importModal.classList.add('hidden'));
                addProductBtn.addEventListener('click', () => {
                    productForm.reset();
                    document.getElementById('productId').value = '';
                    document.getElementById('formTitle').textContent = 'Nuevo Producto';
                    productFormModal.classList.remove('hidden');
                });
                importBtn.addEventListener('click', () => {
                    importForm.reset();
                    document.getElementById('fileName').textContent = 'Ningún archivo seleccionado';
                    importModal.classList.remove('hidden');
                });
                exportBtn.addEventListener('click', exportToPDF);
                productForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fields = [
                        { id: 'itemNumber', label: 'Número de Ítem', required: true },
                        { id: 'upc', label: 'UPC', required: true },
                        { id: 'nombre', label: 'Nombre', required: true },
                        { id: 'size', label: 'Tamaño', required: true },
                        { id: 'qty', label: 'Cantidad', required: true, type: 'int', min: 0 },
                        { id: 'costo', label: 'Costo', required: true, type: 'number', min: 0 },
                        { id: 'description', label: 'Descripción', required: true }
                    ];
                    if (!validateForm('productForm', fields)) return;
                    const productId = document.getElementById('productId').value;
                    const newProduct = {
                        id: productId || generateId(),
                        itemNumber: sanitizeInput(document.getElementById('itemNumber').value),
                        upc: sanitizeInput(document.getElementById('upc').value),
                        nombre: sanitizeInput(document.getElementById('nombre').value),
                        size: sanitizeInput(document.getElementById('size').value),
                        qty: parseInt(document.getElementById('qty').value),
                        costo: parseFloat(document.getElementById('costo').value),
                        url: document.getElementById('url').value || '',
                        description: sanitizeInput(document.getElementById('description').value),
                        customFields: {}
                    };
                    if (productId) {
                        const product = products.find(p => p.id === productId);
                        if (product) {
                            Object.assign(product, newProduct);
                            // Preserve existing customFields if any
                            newProduct.customFields = product.customFields || {};
                        }
                    } else {
                        products.push(newProduct);
                    }
                    saveData();
                    renderAdminProducts();
                    renderPublicTabs();
                    showToast(productId ? 'Producto actualizado correctamente.' : 'Producto agregado correctamente.');
                    productFormModal.classList.add('hidden');
                });
                importForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('csvFile');
                    if (fileInput.files.length > 0) importFromCSV(fileInput.files[0]);
                    else showToast('Por favor selecciona un archivo CSV.', true);
                });
                document.getElementById('csvFile').addEventListener('change', (e) => {
                    const fileName = e.target.files[0]?.name || 'Ningún archivo seleccionado';
                    document.getElementById('fileName').textContent = sanitizeInput(fileName);
                });
                window.addEventListener('click', (e) => {
                    if (e.target === productDetailModal) productDetailModal.classList.add('hidden');
                    if (e.target === productFormModal) productFormModal.classList.add('hidden');
                    if (e.target === importModal) importModal.classList.add('hidden');
                });
                // Select all checkbox (admin)
                selectAll.addEventListener('change', (e) => {
                    document.querySelectorAll('.product-checkbox').forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                    updateDeleteButton();
                });
                // Delete selected (admin)
                deleteSelected.addEventListener('click', () => {
                    if (!confirm('¿Eliminar los productos seleccionados?')) return;
                    const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.dataset.id);
                    products = products.filter(p => !selectedIds.includes(p.id));
                    saveData();
                    renderAdminProducts();
                    renderPublicTabs();
                    showToast('Productos eliminados correctamente.');
                    selectAll.checked = false;
                });
                // Checkbox change for update button state (admin)
                productsContainer.addEventListener('change', (e) => {
                    if (e.target.classList.contains('product-checkbox')) {
                        updateDeleteButton();
                        const allChecked = document.querySelectorAll('.product-checkbox').length === document.querySelectorAll('.product-checkbox:checked').length;
                        selectAll.checked = allChecked;
                    }
                });
                // Event delegation for view details in admin
                productsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-details')) {
                        showProductDetails(e.target.dataset.id);
                    }
                });
                // Event delegation for view details in public
                publicTabContent.addEventListener('click', (e) => {
                    if (e.target.classList.contains('view-details')) {
                        showProductDetails(e.target.dataset.id);
                    }
                });
                // Delete from modal (admin)
                deleteProductBtn.addEventListener('click', () => {
                    const productId = deleteProductBtn.dataset.id;
                    if (confirm('¿Eliminar este producto?')) {
                        products = products.filter(p => p.id !== productId);
                        saveData();
                        renderAdminProducts();
                        renderPublicTabs();
                        productDetailModal.classList.add('hidden');
                        showToast('Producto eliminado correctamente.');
                    }
                });
                // Custom fields event listeners (admin)
                addCustomFieldBtn.addEventListener('click', () => {
                    customFieldForm.classList.remove('hidden');
                    addCustomFieldBtn.classList.add('hidden');
                    customKey.value = '';
                    customValue.value = '';
                    saveCustomField.disabled = true; // Asegurar que esté disabled al abrir
                });
                cancelCustomField.addEventListener('click', () => {
                    customFieldForm.classList.add('hidden');
                    addCustomFieldBtn.classList.remove('hidden');
                });
                saveCustomField.addEventListener('click', () => {
                    const key = sanitizeInput(customKey.value.trim());
                    const value = sanitizeInput(customValue.value.trim());
                    if (!key) {
                        showToast('La clave es obligatoria.', true);
                        return;
                    }
                    const productId = deleteProductBtn.dataset.id;
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        if (!product.customFields) product.customFields = {};
                        product.customFields[key] = value;
                        saveData();
                        showProductDetails(productId);
                        customFieldForm.classList.add('hidden');
                        addCustomFieldBtn.classList.remove('hidden');
                        showToast('Campo personalizado agregado correctamente.');
                        renderAdminProducts();
                        renderPublicTabs();
                    }
                });
                // Nueva función para actualizar el estado del botón Guardar
                function updateSaveCustomButton() {
                    saveCustomField.disabled = !(customKey.value.trim() && customValue.value.trim());
                }
                // Listeners para habilitar el botón al escribir
                customKey.addEventListener('input', updateSaveCustomButton);
                customValue.addEventListener('input', updateSaveCustomButton);
                // View switching
                adminViewBtn.addEventListener('click', () => {
                    passwordModal.classList.remove('hidden');
                    adminPasswordInput.focus();
                });
                publicViewBtn.addEventListener('click', () => showView('public'));
                // Confirmar contraseña
                confirmPassword.addEventListener('click', () => {
                    if (adminPasswordInput.value === adminPassword) {
                        passwordModal.classList.add('hidden');
                        showView('admin');
                    } else {
                        showToast('Contraseña incorrecta.', true);
                    }
                    adminPasswordInput.value = '';
                });
                // Cancelar contraseña
                cancelPassword.addEventListener('click', () => {
                    passwordModal.classList.add('hidden');
                    adminPasswordInput.value = '';
                });
                // Permitir enter para confirmar contraseña
                adminPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmPassword.click();
                    }
                });
            } catch (error) {
                console.error('Error setting up event listeners:', error);
                showToast('Error al inicializar la aplicación.', true);
            }
        }
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // Export catalog to PDF
        function exportToPDF() {
            try {
                if (!window.jspdf) {
                    showToast('Error: No se pudieron cargar las bibliotecas para exportar PDF.', true);
                    return;
                }
                const { jsPDF } = window.jspdf;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<div class="loader inline-block"></div> Exportando...';
                const doc = new jsPDF();
                doc.autoTable({
                    head: [['Nombre', 'Descripción', 'Número de Ítem', 'UPC', 'Tamaño', 'Cantidad', 'Costo']],
                    body: products.map(product => [
                        sanitizeInput(product.nombre || 'N/A'),
                        sanitizeInput(product.description || 'N/A'),
                        sanitizeInput(product.itemNumber || 'N/A'),
                        sanitizeInput(product.upc || 'N/A'),
                        sanitizeInput(product.size || 'N/A'),
                        sanitizeInput(product.qty || 'N/A'),
                        formatCurrency(product.costo || 0)
                    ]),
                    theme: 'grid',
                    headStyles: { fillColor: [99, 102, 241] }, // indigo
                    styles: { font: 'helvetica', fontSize: 10 },
                    margin: { top: 20 },
                    didDrawPage: function (data) {
                        // Add title on first page
                        if (data.pageNumber === 1) {
                            doc.setFontSize(18);
                            doc.text('Catálogo de Productos', data.settings.margin.left, 10);
                            doc.setFontSize(10);
                            doc.text(`Generado el ${new Date().toLocaleDateString('es-MX')}`, data.settings.margin.left, 15);
                        }
                    }
                });
                doc.save('catalogo-productos.pdf');
                showToast('Catálogo exportado correctamente a PDF.');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error al generar el PDF.', true);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Exportar PDF
                `;
            }
        }
        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 flex items-center z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        // Initialize the application on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
