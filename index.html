<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MEXIQUENSE - Catálogo de Productos (V4)</title>

    <!-- Tailwind + fuentes -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- jsPDF / html2canvas / PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging-compat.js"></script>

    <!-- Apple Touch Icon (opcional) -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }
        .error-message { color: #dc2626; font-size: 0.875rem; margin-top: 0.25rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .product-image-container { position: relative; width: 100%; padding-top: 100%; }
        .product-image { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: contain; border-radius:8px; background:#f9f9f9; }
        /* Selección múltiple (admin) */
        .selected-card { outline: 2px solid rgb(59 130 246); background: rgb(239 246 255); }
        /* Mexican colors */
        .bg-mexican-green { background-color: #006847; }
        .bg-mexican-red { background-color: #CE1126; }
        .border-mexican-green { border-color: #006847; }
        .border-mexican-red { border-color: #CE1126; }
        .text-mexican-green { color: #006847; }
        .text-mexican-red { color: #CE1126; }
        /* Credit urgency borders */
        .credit-ok { border-left: 4px solid #86efac; }
        .credit-warning { border-left: 4px solid #fde047; }
        .credit-urgent { border-left: 4px solid #ef4444; }
        /* Hamburger menu - always visible */
        .hamburger-menu { display: block; }
        /* Hide desktop menu completely */
        .desktop-menu { display: none !important; }
        /* Mobile menu styles */
        #mobileMenu { display: none; }
        #mobileMenu.mobile-menu-open { display: flex; flex-direction: column; }
        /* Photo preview */
        .photo-preview { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 8px; }
        .photo-thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        /* Especiales section styles */
        .especiales-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; transition: all 0.3s ease; }
        .especiales-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .price-indicator { width: 16px; height: 16px; border-radius: 50%; background-color: #ef4444; display: inline-block; margin-left: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Truck Loader Styles */
        .truck-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }
        .truck-loader-overlay.fade-out {
            opacity: 0;
        }
        .truck-loader-overlay.hidden {
            display: none !important;
        }
        .truck-loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .truck-loader-text {
            color: #006847;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 2px;
            animation: truckPulse 2s infinite;
        }
        @keyframes truckPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .truck { --width: 220; }
        .truck * { transition: all 0.25s ease; }
        .truck { position: relative; width: calc(var(--width) * 1px); height: calc(var(--width) * 0.33px); }
        .truck:after { content: ""; height: 5%; width: 100%; background: #000; position: absolute; left: 0; bottom: 5%; border-radius: 100%; filter: blur(10px); }
        .truck__indicator { height: 2%; width: 3%; position: absolute; right: 1.5%; background: #915d08; top: 64%; opacity: 0.45; z-index: 10; }
        .truck__foglight { height: 2%; width: 1%; position: absolute; left: 2%; background: #911308; top: 58%; opacity: 0.45; z-index: 10; }
        .truck__taillight { height: 2%; width: 1%; background: radial-gradient(circle at center, #ffebeb, #f00), #f00; box-shadow: 0 0 30px 5px #f33; position: absolute; top: 25%; z-index: 10; left: 0; }
        .truck__taillight:after { content: ""; height: 100%; width: 800%; background: #ff4d4d; position: absolute; right: 0; top: 0; border-radius: 25%; filter: blur(8px); box-shadow: 0 0 60px 5px #ff8080; }
        .truck__headlight { height: 5%; width: 4%; position: absolute; right: 0; border-radius: 25%; top: 42%; z-index: 10; transform: rotate(4deg); background: #fff; box-shadow: 0 0 40px 5px #9bf, 0 0 2px 2px #b3ccff inset; }
        .truck__wheel { position: absolute; }
        .truck__wheel--front { height: 57%; width: 21%; bottom: 0; left: 75%; z-index: 4; transform: rotate(2deg); }
        .truck__wheel--rear { height: 57%; width: 21%; bottom: 2%; left: 10%; z-index: 4; transform: rotate(2deg); }
        .truck-wheel { border-radius: 100%; height: calc(var(--width) * 0.15px); width: calc(var(--width) * 0.15px); background: #242424; border-top: 1px solid #ccc; position: absolute; bottom: 0; left: 52%; transform: translate(-50%, 0); }
        .truck-wheel__rim { height: 60%; width: 60%; background: radial-gradient(circle at center, transparent, #666), #0d0d0d; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 100%; animation: wheelSpin 0.35s infinite linear; }
        .truck-wheel__rim:after { content: ""; height: 35%; width: 35%; background: radial-gradient(circle at center, #0d0d0d, #0d0d0d 40%, transparent 40%), radial-gradient(circle at center, #262626, #262626 40%, transparent), #8c8c8c; border: 1px solid #1a1a1a; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 100%; z-index: 2; }
        @keyframes wheelSpin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        .truck-wheel__spoke { position: absolute; height: 60%; width: 20%; background: linear-gradient(0deg, transparent, #1a1a1a 50%), #808080; border-left: 1px solid #4d4d4d; border-right: 1px solid #333; border-radius: 0 0 25% 25%; top: 50%; left: 50%; transform-origin: top center; transform: translate(-50%, 0) rotate(calc(360 / 7 * var(--index) * 1deg)); }
        .truck__wheel-arch { background: #080808; position: absolute; top: 0; left: 0; right: 1%; height: 54%; -webkit-clip-path: polygon(0 100%, 23% 0, 81% 0%, 95% 60%, 95% 100%); clip-path: polygon(0 100%, 23% 0, 81% 0%, 95% 60%, 95% 100%); }
        .truck__wheel-arch-trim { position: absolute; }
        .truck__wheel-arch-trim--top { top: 0; left: 25%; background: #8c8c8c; height: 5%; width: 53%; z-index: 2; }
        .truck__wheel-arch-trim--left { top: 0; left: -20%; background: linear-gradient(160deg, transparent, #666), #333; height: 5%; width: 44%; transform-origin: top right; transform: rotate(-60deg); }
        .truck__wheel-arch-trim--right { top: 0; left: 79%; background: linear-gradient(-158deg, transparent, #666), #333; height: 5%; width: 35%; transform-origin: top left; transform: rotate(58deg); }
        .truck__body { position: absolute; height: 100%; width: 100%; }
        .truck__body--top { background: linear-gradient(90deg, #f4f1f1, #bfbfbf 50%), #e8e3e3; height: 33%; width: 100%; top: 0; transform: rotate(3deg); -webkit-clip-path: polygon(0 100%, 58% 0, 98% 100%); clip-path: polygon(0 100%, 58% 0, 98% 100%); }
        .truck__body--top:before { --groove: #999; content: ""; background: linear-gradient(95deg, transparent, transparent 2%, var(--groove) 2%, var(--groove) 3%, transparent 3%), linear-gradient(75deg, transparent, transparent 47%, var(--groove) 47%, var(--groove) 48%, transparent 48%), linear-gradient(78deg, transparent, transparent 95%, var(--groove) 95%, var(--groove) 96%, transparent 96%); position: absolute; height: 55%; width: 40%; left: 36%; bottom: 0; -webkit-clip-path: polygon(0 100%, 0 0, 100% 58%, 100% 100%); clip-path: polygon(0 100%, 0 0, 100% 58%, 100% 100%); }
        .truck__body--mid { position: absolute; width: 100%; height: 36%; top: 25%; transform: rotate(3deg); transform-origin: top left; z-index: 2; }
        .truck__body--mid:after { content: ""; position: absolute; background: #1f1f1f; height: 20%; width: 5%; bottom: 20%; right: -0.25%; opacity: 1; border-left: 1px solid #1a1a1a; }
        .truck__body--mid:before { content: ""; position: absolute; background: #0f0f0f; height: 20%; width: 5%; bottom: 5%; right: 0%; border-radius: 0 0 50% 25%; border-left: 1px solid #141414; }
        .truck__body--bottom { top: 50%; height: 32%; }
        .truck__rear-bumper { position: absolute; height: 1px; width: 9%; background: #808080; top: 38%; left: 2.5%; transform-origin: top left; transform: rotate(3deg); }
        .truck__side-skirt { height: 1px; width: 43%; position: absolute; bottom: 19%; left: 32%; transform-origin: top left; transform: rotate(1deg); background: #808080; }
        .truck__underpanel { background: #080808; height: 65%; width: 100%; position: absolute; bottom: 0; -webkit-clip-path: polygon(2% 0, 14% 100%, 88% 100%, 99% 60%, 99% 40%); clip-path: polygon(2% 0, 14% 100%, 88% 100%, 99% 60%, 99% 40%); }
        .truck__mid-body { --groove: #262626; height: 100%; width: 100%; background: linear-gradient(84deg, transparent, transparent 36.75%, var(--groove) 36.75%, var(--groove) 37.25%, transparent 37.25%), linear-gradient(83deg, transparent, transparent 55.75%, var(--groove) 55.75%, var(--groove) 56.25%, transparent 56.25%), linear-gradient(88deg, transparent, transparent 75%, var(--groove) 75%, var(--groove) 75.5%, transparent 75.5%), linear-gradient(90deg, transparent, transparent 96%, #1f1f1f 96%), linear-gradient(90deg, transparent, #262626), #333; -webkit-clip-path: polygon(0 0, 3% 100%, 80% 84%, 99.5% 78%, 100% 10%, 98% 0); clip-path: polygon(0 0, 3% 100%, 80% 84%, 99.5% 78%, 100% 10%, 98% 0); }
        .truck__mid-body:after, .truck__mid-body:before { content: ""; position: absolute; width: 4%; height: 4%; left: 38%; top: 6%; border: 1px solid #4d4d4d; border-radius: 25%; }
        .truck__mid-body:before { left: 58%; }
        .truck__window { --window-black: rgba(0, 0, 0, 0.85); --window-white: rgba(255, 255, 255, 0.3); position: absolute; height: 80%; width: 60%; background: #000; left: 37%; transform: skew(-5deg); -webkit-clip-path: polygon(0 100%, 0 55%, 34.5% 11%, 85% 108%); clip-path: polygon(0 100%, 0 55%, 34.5% 11%, 85% 108%); }
        .truck__window-glass { background: linear-gradient(0deg, var(--window-black) 0, var(--window-black) 15%, transparent 15%), linear-gradient(90deg, transparent, var(--window-black) 90%), linear-gradient(90deg, var(--window-white), transparent 80%), linear-gradient(68deg, transparent, transparent 30%, var(--window-black) 30%, var(--window-black) 31%, transparent 31%, transparent 55%, var(--window-black) 55%, var(--window-black) 56%, transparent 56%), var(--window-white); position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); height: 88%; width: 98%; -webkit-clip-path: polygon(0 100%, 0 55%, 34.5% 11%, 85% 105%); clip-path: polygon(0 100%, 0 55%, 34.5% 11%, 85% 105%); }
        .truck__window:before { content: ""; background: #000; position: absolute; height: 10%; width: 100%; bottom: 0; transform: rotate(2deg); z-index: -1; -webkit-clip-path: polygon(40% 100%, 100% -100%, 100% 100%); clip-path: polygon(40% 100%, 100% -100%, 100% 100%); }
    </style>
</head>
<body>
    <!-- Truck Loader -->
    <div id="truckLoader" class="truck-loader-overlay">
        <div class="truck-loader-container">
            <div class="truck">
                <div class="truck__body">
                    <div class="truck__body truck__body--top">
                        <div class="truck__window">
                            <div class="truck__window-glass"></div>
                        </div>
                    </div>
                    <div class="truck__body truck__body--mid">
                        <div class="truck__mid-body"></div>
                    </div>
                    <div class="truck__body truck__body--bottom">
                        <div class="truck__underpanel"></div>
                        <div class="truck__rear-bumper"></div>
                        <div class="truck__side-skirt"></div>
                    </div>
                </div>
                <div class="truck__wheel truck__wheel--front">
                    <div class="truck__wheel-arch"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--top"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--left"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--right"></div>
                    <div class="truck-wheel">
                        <div class="truck-wheel__rim">
                            <div style="--index: 0;" class="truck-wheel__spoke"></div>
                            <div style="--index: 1;" class="truck-wheel__spoke"></div>
                            <div style="--index: 2;" class="truck-wheel__spoke"></div>
                            <div style="--index: 3;" class="truck-wheel__spoke"></div>
                            <div style="--index: 4;" class="truck-wheel__spoke"></div>
                            <div style="--index: 5;" class="truck-wheel__spoke"></div>
                            <div style="--index: 6;" class="truck-wheel__spoke"></div>
                        </div>
                    </div>
                </div>
                <div class="truck__wheel truck__wheel--rear">
                    <div class="truck__wheel-arch"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--top"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--left"></div>
                    <div class="truck__wheel-arch-trim truck__wheel-arch-trim--right"></div>
                    <div class="truck-wheel">
                        <div class="truck-wheel__rim">
                            <div style="--index: 0;" class="truck-wheel__spoke"></div>
                            <div style="--index: 1;" class="truck-wheel__spoke"></div>
                            <div style="--index: 2;" class="truck-wheel__spoke"></div>
                            <div style="--index: 3;" class="truck-wheel__spoke"></div>
                            <div style="--index: 4;" class="truck-wheel__spoke"></div>
                            <div style="--index: 5;" class="truck-wheel__spoke"></div>
                            <div style="--index: 6;" class="truck-wheel__spoke"></div>
                        </div>
                    </div>
                </div>
                <div class="truck__headlight"></div>
                <div class="truck__taillight"></div>
                <div class="truck__indicator"></div>
                <div class="truck__foglight"></div>
            </div>
            <p class="truck-loader-text">Cargando...</p>
        </div>
    </div>
    
    <div id="mainContent" class="min-h-screen flex flex-col" style="visibility: hidden;">
        <!-- Header -->
        <header class="bg-gradient-to-r from-mexican-green via-white to-mexican-red text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-4 md:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3 text-mexican-green" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                        </svg>
                        <h1 class="text-2xl md:text-3xl font-bold text-mexican-green">MEXIQUENSE</h1>
                    </div>
                    <!-- Hamburger menu (always visible) -->
                    <button id="mobileMenuBtn" class="hamburger-menu bg-mexican-green text-white px-4 py-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <!-- Hamburger dropdown menu -->
                    <div id="mobileMenu" class="hidden w-full mt-4 flex-col gap-2">
                        <button id="publicViewBtnMobile" class="bg-mexican-green text-white hover:bg-opacity-90 px-4 py-2 rounded-lg font-medium transition-all w-full">Productos</button>
                        <button id="especialesViewBtnMobile" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium transition-all w-full">Especiales</button>
                        <button id="especialesEnTiendaBtnMobile" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium transition-all w-full">Especiales en Tienda</button>
                        <button id="creditosViewBtnMobile" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium transition-all w-full">Créditos</button>
                        <a href="factura.html" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium transition-all w-full text-center block">Facturas</a>
                        <button id="adminViewBtnMobile" class="bg-mexican-red text-white hover:bg-opacity-90 px-4 py-2 rounded-lg font-medium transition-all w-full">Panel de Administración</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin View -->
        <section id="adminView" class="flex-grow container mx-auto px-4 py-8 hidden">
            <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                    <div class="flex-grow">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Buscar productos..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="importBtn" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                            Importar CSV
                        </button>
                        <button id="exportBtn" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                            Exportar PDF
                        </button>
                        <button id="addProductBtn" class="bg-white text-mexican-green hover:bg-gray-100 px-4 py-2 rounded-lg font-medium flex items-center transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                            Nuevo Producto
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 gap-3 mb-4">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="selectAll" class="h-5 w-5 text-mexican-green focus:ring-mexican-green border-gray-300 rounded" />
                    <label for="selectAll" class="text-gray-700 font-medium">Seleccionar Todos</label>
                </div>
                <button id="deleteSelected" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Eliminar Seleccionados
                </button>
                <div class="text-sm text-gray-600">Mantén <b>Ctrl</b> (Windows) o <b>Cmd</b> (Mac) y haz clic en los productos para seleccionar varios. También puedes arrastrar para seleccionar.</div>
            </div>

            <div id="productsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>

        <!-- Public View -->
        <section id="publicView" class="flex-grow container mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                <h2 class="text-2xl font-bold text-mexican-green mb-4">Catálogo de Productos</h2>
                <div class="bg-white rounded-xl shadow-md p-4 mb-8">
                    <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex-grow">
                            <div class="relative">
                                <input id="publicSearchInput" type="text" placeholder="Buscar productos por nombre o UPC..." aria-label="Buscar productos" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="publicTabs" class="flex space-x-4 border-b border-gray-200"></div>
                <div id="publicTabContent" class="mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
                <!-- Pagination Controls -->
                <div id="paginationControls" class="mt-8 flex justify-center items-center gap-2">
                    <button id="prevPage" class="bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Anterior
                    </button>
                    <div id="pageNumbers" class="flex gap-2"></div>
                    <button id="nextPage" class="bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        Siguiente
                    </button>
                </div>
            </div>
        </section>

        <!-- Especiales View -->
        <section id="especialesView" class="flex-grow container mx-auto px-4 py-8 hidden">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-mexican-green mb-2">Especiales</h2>
                        <p class="text-sm text-gray-600">Registra productos en especial con su precio anterior para no olvidar los precios originales</p>
                    </div>
                    <button id="addEspecialBtn" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-medium flex items-center transition-all mt-4 md:mt-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                        Agregar Nuevo Especial
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-grow">
                        <div class="relative">
                            <input id="especialesSearchInput" type="text" placeholder="Buscar por nombre o UPC..." aria-label="Buscar precios especiales" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                        </div>
                    </div>
                </div>
            </div>
            <div id="especialesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Créditos View -->
        <section id="creditosView" class="flex-grow container mx-auto px-4 py-8 hidden">
            <!-- Pending Credits View -->
            <div id="creditosPending" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <h2 class="text-2xl font-bold text-mexican-green mb-4 md:mb-0">Créditos Pendientes</h2>
                        <button id="newCreditBtn" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-medium flex items-center transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>
                            Registrar Nuevo Crédito
                        </button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-grow">
                            <div class="relative">
                                <input id="creditSearchInput" type="text" placeholder="Buscar por proveedor, descripción, dígitos o notas..." aria-label="Buscar créditos" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                        <div>
                            <select id="creditFilterSelect" aria-label="Filtrar créditos por tiempo" class="w-full md:w-auto px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent">
                                <option value="all">Todos</option>
                                <option value="week1">Menos de 1 semana</option>
                                <option value="week2">1-2 semanas</option>
                                <option value="week3">Más de 2 semanas</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="pendingCreditsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Register New Credit View -->
            <div id="creditosRegister" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-2xl font-bold text-mexican-green mb-6">Registrar Nuevo Crédito</h2>
                    <form id="newCreditForm" class="space-y-6">
                        <div>
                            <label for="creditProvider" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proveedor (opcional)</label>
                            <input type="text" id="creditProvider" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        
                        <div id="productsFieldsContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Productos</label>
                            <div id="productsList"></div>
                            <button type="button" id="addProductField" class="mt-4 bg-white border-2 border-mexican-green text-mexican-green hover:bg-mexican-green hover:text-white px-4 py-2 rounded-lg font-medium transition-all">
                                + Agregar Otro Producto
                            </button>
                        </div>

                        <div>
                            <label for="creditDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Crédito*</label>
                            <input type="date" id="creditDate" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>

                        <div>
                            <label for="creditNotes" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales (opcional, máx 200 caracteres)</label>
                            <textarea id="creditNotes" maxlength="200" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent"></textarea>
                            <p class="text-sm text-gray-500 mt-1"><span id="creditNotesCount">0</span>/200 caracteres</p>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button type="button" id="cancelNewCredit" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="flex-1 bg-mexican-green hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-medium transition-all">Registrar Crédito</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Mark as Delivered View -->
            <div id="creditosDeliver" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-2xl font-bold text-mexican-green mb-6">Marcar como Entregado</h2>
                    <div id="creditSummary" class="mb-6 p-4 bg-gray-50 rounded-lg"></div>
                    <form id="deliverCreditForm" class="space-y-6">
                        <input type="hidden" id="deliverCreditId" />
                        
                        <div>
                            <label for="deliveryDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Entrega*</label>
                            <input type="date" id="deliveryDate" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>

                        <div>
                            <label for="deliveryNotes" class="block text-sm font-medium text-gray-700 mb-1">Notas de Entrega (opcional, máx 200 caracteres)</label>
                            <textarea id="deliveryNotes" maxlength="200" rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent"></textarea>
                            <p class="text-sm text-gray-500 mt-1"><span id="deliveryNotesCount">0</span>/200 caracteres</p>
                        </div>

                        <div>
                            <label for="deliveryPhoto" class="block text-sm font-medium text-gray-700 mb-1">Subir Foto Opcional (JPG/PNG, máx 5MB)</label>
                            <input type="file" id="deliveryPhoto" accept="image/jpeg,image/png" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                            <div id="deliveryPhotoPreview" class="mt-2"></div>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button type="button" id="cancelDelivery" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="flex-1 bg-mexican-green hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-medium transition-all">Confirmar Entrega</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Delivery History View -->
            <div id="creditosHistory" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-mexican-green mb-4">Historial de Entregas</h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <div class="flex-grow">
                            <div class="relative">
                                <input id="historySearchInput" type="text" placeholder="Buscar por proveedor, descripción o dígitos..." aria-label="Buscar historial" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                        <button id="exportHistoryBtn" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-3 rounded-lg font-medium transition-all">Exportar CSV</button>
                        <button id="backToPendingBtn" class="bg-white border-2 border-mexican-green text-mexican-green hover:bg-mexican-green hover:text-white px-6 py-3 rounded-lg font-medium transition-all">Volver a Pendientes</button>
                    </div>
                </div>
                <div id="historyCreditsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4 text-center">
                <p>© 2025 MEXIQUENSE - Sistema de Catálogo</p>
            </div>
        </footer>

        <!-- Modal Detalle -->
        <div id="productDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-mexican-green text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="modalProductTitle" class="text-xl font-bold">Detalles del Producto</h3>
                    <button id="closeDetailModal" class="text-white hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div id="productImage" class="bg-gray-100 rounded-lg h-64 flex items-center justify-center mb-4 overflow-hidden">
                                <img id="productImageSrc" src="" class="max-h-full max-w-full object-contain hidden" alt="Producto" onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';" />
                                <svg id="productImagePlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            </div>
                            <div class="space-y-2" id="productFields">
                                <p><strong>Número de Ítem:</strong> <span id="productItemNumber" class="text-gray-700 cursor-pointer"></span></p>
                                <p><strong>UPC:</strong> <span id="productUpc" class="text-gray-700"></span></p>
                                <p><strong>Tamaño:</strong> <span id="productSize" class="text-gray-700"></span></p>
                                <p><strong>Cantidad:</strong> <span id="productQty" class="text-gray-700"></span></p>
                            </div>
                            <div id="customFields" class="space-y-2 mt-4"></div>
                            <div class="mt-4 admin-only">
                                <button id="addCustomFieldBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all">Agregar Campo Personalizado</button>
                            </div>
                            <div id="customFieldForm" class="hidden mt-4 space-y-4 admin-only">
                                <div>
                                    <label for="customKey" class="block text-sm font-medium text-gray-700 mb-1">Clave (ej. Palimex):</label>
                                    <input type="text" id="customKey" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                    <p id="customKeyError" class="error-message hidden"></p>
                                </div>
                                <div>
                                    <label for="customValue" class="block text-sm font-medium text-gray-700 mb-1">Valor (ej. $3.80):</label>
                                    <input type="text" id="customValue" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button id="cancelCustomField" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                                    <button id="saveCustomField" class="bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium transition-all disabled:opacity-50" disabled>Guardar</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">Descripción</h4>
                            <p id="productDescription" class="text-gray-700 mb-4"></p>
                            <h4 class="text-lg font-semibold mb-2">Costo</h4>
                            <p id="productCosto" class="text-2xl font-bold text-mexican-green mb-4"></p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-6 pt-0 admin-only">
                    <button id="deleteProductBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-all">Eliminar</button>
                </div>
            </div>
        </div>

        <!-- Modal Formulario Producto -->
        <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-mexican-green text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="formTitle" class="text-xl font-bold">Nuevo Producto</h3>
                    <button id="closeFormModal" class="text-white hover:text-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <form id="productForm" class="space-y-4">
                        <input type="hidden" id="productId" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="itemNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Ítem*</label>
                                <input type="text" id="itemNumber" name="itemNumber" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="itemNumberError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="upc" class="block text-sm font-medium text-gray-700 mb-1">UPC*</label>
                                <input type="text" id="upc" name="upc" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="upcError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre*</label>
                                <input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="nombreError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Tamaño*</label>
                                <input type="text" id="size" name="size" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="sizeError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="qty" class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                                <input type="number" id="qty" name="qty" required min="0" step="any" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="qtyError" class="error-message hidden"></p>
                            </div>
                            <div>
                                <label for="costo" class="block text-sm font-medium text-gray-700 mb-1">Costo*</label>
                                <input type="number" id="costo" name="costo" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                                <p id="costoError" class="error-message hidden"></p>
                            </div>
                        </div>
                        <div>
                            <label for="url" class="block text-sm font-medium text-gray-700 mb-1">URL de Imagen (opcional)</label>
                            <input type="url" id="url" name="url" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción*</label>
                            <textarea id="description" name="description" required rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent"></textarea>
                            <p id="descriptionError" class="error-message hidden"></p>
                        </div>
                        <div class="pt-4 flex justify-end space-x-2">
                            <button type="button" id="cancelProductBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-2 rounded-lg font-medium transition-all">Guardar Producto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Import CSV -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                <div class="bg-mexican-green text-white px-6 py-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Importar Productos desde CSV</h3>
                    <button id="closeImportModal" class="text-white hover:text-indigo-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">Sube un archivo CSV con los siguientes encabezados: ITEM NUMBER, DESCRIPTION, UPC, NOMBRE, SIZE, QTY, COSTO, URL (URL es opcional). Usa comas como separador.</p>
                    <form id="importForm" class="space-y-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="csvFile" name="csvFile" accept=".csv" class="hidden" />
                            <label for="csvFile" class="cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                <span class="mt-2 block text-sm font-medium text-mexican-green">Haz clic para seleccionar archivo</span>
                                <span id="fileName" class="mt-1 block text-sm text-gray-500">Ningún archivo seleccionado</span>
                            </label>
                        </div>
                        <div id="importLoader" class="hidden"><div class="loader"></div><p class="text-gray-600 mt-2">Importando...</p></div>
                        <div class="pt-4 flex justify-end"><button type="submit" id="importSubmitBtn" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-2 rounded-lg font-medium transition-all">Importar</button></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50"><span id="toastMessage">Operación completada con éxito</span></div>

        <!-- Modal Password Admin -->
        <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-xl font-bold text-mexican-green mb-4">Ingresar Contraseña para Administración</h3>
                <input type="password" id="adminPasswordInput" placeholder="Contraseña" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent mb-4" />
                <div class="flex justify-end space-x-2">
                    <button id="cancelPassword" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                    <button id="confirmPassword" class="bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium transition-all">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Photo Modal -->
        <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
            <div class="relative max-w-4xl max-h-[90vh] p-4">
                <button id="closePhotoModal" class="absolute top-2 right-2 bg-white rounded-full p-2 hover:bg-gray-200 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <img id="photoModalImage" src="" alt="Foto ampliada" class="max-w-full max-h-[85vh] object-contain rounded-lg" />
            </div>
        </div>

        <!-- Modal Add/Edit Especial -->
        <div id="especialFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                <div class="bg-mexican-green text-white px-6 py-4 flex justify-between items-center">
                    <h3 id="especialFormTitle" class="text-xl font-bold">Nuevo Especial</h3>
                    <button id="closeEspecialFormModal" class="text-white hover:text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <form id="especialForm" class="space-y-4">
                        <input type="hidden" id="especialId" />
                        <div>
                            <label for="especialNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre*</label>
                            <input type="text" id="especialNombre" name="especialNombre" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        <div>
                            <label for="especialUpc" class="block text-sm font-medium text-gray-700 mb-1">UPC*</label>
                            <input type="text" id="especialUpc" name="especialUpc" required class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        <div>
                            <label for="especialAntes" class="block text-sm font-medium text-gray-700 mb-1">Precio Antes*</label>
                            <input type="number" id="especialAntes" name="especialAntes" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        <div>
                            <label for="especialPrice" class="block text-sm font-medium text-gray-700 mb-1">Precio Especial*</label>
                            <input type="number" id="especialPrice" name="especialPrice" required min="0" step="0.01" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent" />
                        </div>
                        <div class="pt-4 flex justify-end space-x-2">
                            <button type="button" id="cancelEspecialBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-medium transition-all">Cancelar</button>
                            <button type="submit" class="bg-mexican-green hover:bg-opacity-90 text-white px-6 py-2 rounded-lg font-medium transition-all">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==== Firebase (reemplaza con tus credenciales reales) ====
        let database = null;
        try {
            const firebaseConfig = {
                apiKey: "TU_API_KEY_AQUI",
                authDomain: "catalogomexiquense.firebaseapp.com",
                databaseURL: "https://catalogomexiquense-default-rtdb.firebaseio.com",
                projectId: "catalogomexiquense",
                storageBucket: "catalogomexiquense.appspot.com",
                messagingSenderId: "TU_SENDER_ID_AQUI",
                appId: "TU_APP_ID_AQUI"
            };
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            }
        } catch(err) {
            console.warn('Firebase not available, using localStorage only', err);
        }

        // ==== Estado ====
        const adminPassword = 'admin123';
        let products = [];
        const selection = new Set();
        let currentView = 'public';
        let currentPage = 1;
        const itemsPerPage = 20;

        // ==== DOM ====
        const productsContainer = document.getElementById('productsContainer');
        const searchInput = document.getElementById('searchInput');
        const publicSearchInput = document.getElementById('publicSearchInput');
        const adminView = document.getElementById('adminView');
        const publicView = document.getElementById('publicView');
        // Mobile menu buttons (now the primary navigation)
        const adminViewBtn = document.getElementById('adminViewBtnMobile');
        const publicViewBtn = document.getElementById('publicViewBtnMobile');
        const publicTabs = document.getElementById('publicTabs');
        const publicTabContent = document.getElementById('publicTabContent');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const addProductBtn = document.getElementById('addProductBtn');
        const passwordModal = document.getElementById('passwordModal');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const confirmPassword = document.getElementById('confirmPassword');
        const cancelPassword = document.getElementById('cancelPassword');

        // Modales
        const productDetailModal = document.getElementById('productDetailModal');
        const productFormModal = document.getElementById('productFormModal');
        const importModal = document.getElementById('importModal');

        // Botones/controles admin
        const selectAll = document.getElementById('selectAll');
        const deleteSelected = document.getElementById('deleteSelected');
        const deleteProductBtn = document.getElementById('deleteProductBtn');

        // Campos personalizados
        const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
        const cancelCustomField = document.getElementById('cancelCustomField');
        const saveCustomField = document.getElementById('saveCustomField');

        // Formularios
        const productForm = document.getElementById('productForm');
        const importForm = document.getElementById('importForm');
        const customFieldForm = document.getElementById('customFieldForm');
        const customKey = document.getElementById('customKey');
        const customValue = document.getElementById('customValue');

        // Campos del modal de detalles
        const modalProductTitle = document.getElementById('modalProductTitle');
        const productItemNumber = document.getElementById('productItemNumber');
        const productUpc = document.getElementById('productUpc');
        const productSize = document.getElementById('productSize');
        const productQty = document.getElementById('productQty');
        const productDescription = document.getElementById('productDescription');
        const productCosto = document.getElementById('productCosto');
        const productImageSrc = document.getElementById('productImageSrc');
        const productImagePlaceholder = document.getElementById('productImagePlaceholder');

        // Formulario agregar/editar
        const productIdInput = document.getElementById('productId');
        const itemNumberInput = document.getElementById('itemNumber');
        const upcInput = document.getElementById('upc');
        const nombreInput = document.getElementById('nombre');
        const sizeInput = document.getElementById('size');
        const qtyInput = document.getElementById('qty');
        const costoInput = document.getElementById('costo');
        const urlInput = document.getElementById('url');
        const descriptionInput = document.getElementById('description');
        const formTitle = document.getElementById('formTitle');

        // Import CSV
        const csvFileInput = document.getElementById('csvFile');
        const fileNameText = document.getElementById('fileName');
        const importLoader = document.getElementById('importLoader');
        const importSubmitBtn = document.getElementById('importSubmitBtn');

        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // Pagination
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageNumbers = document.getElementById('pageNumbers');
        const paginationControls = document.getElementById('paginationControls');

        // ==== Utils ====
        function generateId(){ return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function sanitizeInput(input){ if (!input) return ''; const div=document.createElement('div'); div.textContent=input; return div.innerHTML; }
        function formatCurrency(amount){ return new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(amount); }
        function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
        function isLocalStorageAvailable(){ try{ localStorage.setItem('__t','__t'); localStorage.removeItem('__t'); return true; }catch{ return false; } }

        // === NUEVO: ¿producto es "NEW"? (7 días) ===
        function isNewProduct(product){
            if(!product || !product.dateAdded) return false;
            const sevenDays = 7*24*60*60*1000;
            return (Date.now() - product.dateAdded) < sevenDays;
        }

        // ==== Load & Save ====
        function loadData(){
            try{
                if(database){
                    database.ref('products').on('value', (snapshot)=>{
                        products = snapshot.val() || [];
                        renderAdminProducts();
                        renderPublicTabs();
                        showToast('Datos sincronizados desde Firebase.');
                    });
                } else {
                    throw new Error('Firebase not available');
                }
            }catch(err){
                console.warn('Using localStorage for products', err);
                if(isLocalStorageAvailable()){
                    const stored = localStorage.getItem('products');
                    products = stored ? JSON.parse(stored) : [];
                    renderAdminProducts();
                    renderPublicTabs();
                } else { products = []; }
            }
        }
        function saveData(){
            return new Promise((resolve) => {
                try{ 
                    if(database) {
                        database.ref('products').set(products)
                            .then(() => {
                                console.log('Products saved to Firebase successfully');
                                if(isLocalStorageAvailable()) {
                                    localStorage.setItem('products', JSON.stringify(products));
                                }
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error, using localStorage as fallback', err);
                                if(isLocalStorageAvailable()) {
                                    localStorage.setItem('products', JSON.stringify(products));
                                }
                                resolve(); // Resolve with localStorage fallback instead of rejecting
                            });
                    } else {
                        if(isLocalStorageAvailable()) {
                            localStorage.setItem('products', JSON.stringify(products));
                        }
                        resolve();
                    }
                }
                catch(err){
                    console.error('Error saving products:', err);
                    if(isLocalStorageAvailable()) {
                        localStorage.setItem('products', JSON.stringify(products));
                    }
                    resolve(); // Resolve to prevent UI from hanging on error
                }
            });
        }

        // ==== Render ADMIN (con selección Ctrl/Cmd + drag) ====
        function renderAdminProducts(){
            if(!productsContainer) return;
            productsContainer.innerHTML = '';
            const q = (searchInput?.value || '').toLowerCase();
            let filtered = [...products];
            if(q){
                filtered = filtered.filter(p=>{
                    try{
                        return p?.nombre?.toLowerCase().includes(q) || p?.itemNumber?.toLowerCase().includes(q) || p?.description?.toLowerCase().includes(q);
                    }catch{ return false; }
                });
            }
            if(filtered.length===0){
                productsContainer.innerHTML = `<div class="col-span-full text-center py-12"><svg xmlns='http://www.w3.org/2000/svg' class='h-16 w-16 mx-auto text-gray-400' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/></svg><h3 class='mt-4 text-lg font-medium text-gray-900'>No se encontraron productos</h3><p class='mt-1 text-gray-500'>Intenta con otra búsqueda o agrega nuevos productos.</p></div>`;
                updateDeleteButton();
                return;
            }
            filtered.forEach(product=>{
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover relative';
                card.dataset.id = product.id;
                if(selection.has(product.id)) card.classList.add('selected-card');
                card.innerHTML = `
                    <div class='product-image-container relative'>
                        <img src='${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}' alt='${sanitizeInput(product.nombre || 'Producto')}' class='product-image' onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                    </div>
                    <div class='p-5'>
                        <h3 class='text-lg font-semibold text-gray-900 mb-2'>${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                        <div class='flex justify-center'>
                            <button class='view-details bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all' data-id='${product.id}'>Ver detalles</button>
                        </div>
                    </div>`;
                // Selección Ctrl/Cmd
                card.addEventListener('click', (e)=>{
                    if(e.ctrlKey || e.metaKey){ e.preventDefault(); e.stopPropagation(); toggleSelection(product.id, card); return; }
                });
                productsContainer.appendChild(card);
            });
            updateDeleteButton();
        }

        // ==== Render PUBLIC (NEW solo aquí) ====
        function renderPublicTabs(searchTerm=''){
            publicTabs.innerHTML = '';
            publicTabContent.innerHTML = '';
            publicTabContent.className = 'mt-6 grid grid-cols-2 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';

            let filtered = [...products];
            if(searchTerm){
                const s = searchTerm.toLowerCase();
                filtered = filtered.filter(p=> p?.nombre?.toLowerCase().includes(s) || p?.upc?.toLowerCase().includes(s));
            }
            if(filtered.length===0){
                publicTabContent.innerHTML = `<div class='col-span-full text-center py-12'><svg xmlns='http://www.w3.org/2000/svg' class='h-16 w-16 mx-auto text-gray-400' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'/></svg><h3 class='mt-4 text-lg font-medium text-gray-900'>No se encontraron productos</h3><p class='mt-1 text-gray-500'>Intenta con otra búsqueda.</p></div>`;
                paginationControls.style.display = 'none';
                return;
            }
            // Orden: nuevos primero, viejos aleatorios
            const newOnes = filtered.filter(isNewProduct);
            const oldOnes = filtered.filter(p=> !isNewProduct(p));
            for(let i=oldOnes.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [oldOnes[i], oldOnes[j]]=[oldOnes[j], oldOnes[i]]; }
            const ordered = [...newOnes, ...oldOnes];

            // Pagination logic
            const totalPages = Math.ceil(ordered.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = ordered.slice(startIndex, endIndex);

            renderPublicProducts(paginatedProducts, publicTabContent);
            renderPagination(totalPages, ordered.length);
        }

        function renderPublicProducts(list, container){
            container.innerHTML = '';
            list.forEach(product=>{
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover';
                card.innerHTML = `
                    <div class='product-image-container relative'>
                        ${isNewProduct(product) ? `<span class='absolute top-2 left-2 bg-mexican-green text-white text-xs font-bold px-2 py-1 rounded-full shadow-md animate-pulse'>NEW</span>` : ''}
                        <img src='${product.url || 'https://placehold.co/300x200/png?text=Sin+Imagen'}' alt='${sanitizeInput(product.nombre || 'Producto')}' class='product-image' onerror="this.onerror=null; this.src='https://placehold.co/300x200/png?text=Error+al+cargar';">
                    </div>
                    <div class='p-5'>
                        <h3 class='text-lg font-semibold text-gray-900 mb-2'>${sanitizeInput(product.nombre || 'Sin nombre')}</h3>
                        <div class='flex justify-center'>
                            <button class='view-details bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all' data-id='${product.id}'>Ver detalles</button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function renderPagination(totalPages, totalItems){
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }
            
            paginationControls.style.display = 'flex';
            
            // Update prev/next buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            // Render page numbers
            pageNumbers.innerHTML = '';
            
            // Show page info
            const pageInfo = document.createElement('div');
            pageInfo.className = 'flex items-center gap-2 px-4 py-2 text-gray-700 font-medium';
            pageInfo.textContent = `Página ${currentPage} de ${totalPages} (${totalItems} productos)`;
            pageNumbers.appendChild(pageInfo);
            
            // Show max 5 page numbers around current page
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page and ellipsis if needed
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 text-gray-500';
                    ellipsis.textContent = '...';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // Add last page and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 text-gray-500';
                    ellipsis.textContent = '...';
                    pageNumbers.appendChild(ellipsis);
                }
                addPageButton(totalPages);
            }
        }
        
        function addPageButton(pageNum) {
            const btn = document.createElement('button');
            btn.className = `px-4 py-2 rounded-lg font-medium transition-all ${
                pageNum === currentPage 
                    ? 'bg-mexican-green text-white' 
                    : 'bg-white text-mexican-green hover:bg-gray-100 border border-mexican-green'
            }`;
            btn.textContent = pageNum;
            btn.addEventListener('click', () => {
                currentPage = pageNum;
                renderPublicTabs(publicSearchInput?.value || '');
                // Scroll to top of products
                publicView.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
            pageNumbers.appendChild(btn);
        }

        // ==== Selección (admin) ====
        function toggleSelection(id, cardEl){ if(selection.has(id)) selection.delete(id); else selection.add(id); if(cardEl) cardEl.classList.toggle('selected-card'); updateDeleteButton(); }
        function clearSelection(){ selection.clear(); document.querySelectorAll('#productsContainer [data-id]').forEach(c=>c.classList.remove('selected-card')); updateDeleteButton(); }
        function updateDeleteButton(){ deleteSelected.disabled = selection.size===0; const total=document.querySelectorAll('#productsContainer [data-id]').length; const selected=document.querySelectorAll('#productsContainer .selected-card').length; selectAll.checked = total>0 && selected===total; }

        // ==== Detalles ====
        function showProductDetails(productId){
            const product = products.find(p=> p.id===productId);
            if(!product){ showToast('Producto no encontrado.', true); return; }
            try{
                modalProductTitle.textContent = sanitizeInput(product.nombre || 'Sin nombre');
                productItemNumber.textContent = sanitizeInput(product.itemNumber || 'N/A');
                productUpc.textContent = sanitizeInput(product.upc || 'N/A');
                productSize.textContent = sanitizeInput(product.size || 'N/A');
                productQty.textContent = sanitizeInput(String(product.qty ?? 'N/A'));
                productDescription.textContent = sanitizeInput(product.description || 'Sin descripción');
                productCosto.textContent = formatCurrency(product.costo || 0);

                if(product.url){
                    productImageSrc.src = product.url;
                    productImageSrc.onerror = ()=>{ productImageSrc.classList.add('hidden'); productImagePlaceholder.classList.remove('hidden'); };
                    productImageSrc.classList.remove('hidden');
                    productImagePlaceholder.classList.add('hidden');
                }else{
                    productImageSrc.classList.add('hidden');
                    productImagePlaceholder.classList.remove('hidden');
                }
                // Custom fields
                const customFieldsContainer = document.getElementById('customFields');
                customFieldsContainer.innerHTML = '';
                const customFields = product.customFields || {};
                Object.entries(customFields).forEach(([k,v])=>{
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${sanitizeInput(k)}:</strong> <span class='text-gray-700'>${sanitizeInput(v)}</span>`;
                    customFieldsContainer.appendChild(p);
                });
                deleteProductBtn.dataset.id = product.id;
                document.querySelectorAll('.admin-only').forEach(el=> el.style.display = currentView==='admin' ? '' : 'none');
                productDetailModal.classList.remove('hidden');
            }catch(e){ console.error('Error mostrando detalles:', e); showToast('Error al mostrar detalles.', true); }
        }
// ==== Import CSV ====
function importFromCSV(file) {
  try {
    if (!window.Papa) {
      showToast('Error: PapaParse no se cargó.', true);
      return;
    }

    importLoader.classList.remove('hidden');
    importSubmitBtn.disabled = true;

    const reader = new FileReader();

    reader.onload = function(e) {
      let text = e.target.result;

      // 💡 Eliminar BOM si viene de Numbers
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      // 🔍 Detectar delimitador automáticamente
      const firstLine = text.split('\n')[0];
      let delimiter = ';';
      if ((firstLine.match(/,/g) || []).length > (firstLine.match(/;/g) || []).length) delimiter = ',';
      if ((firstLine.match(/\t/g) || []).length > (firstLine.match(/;/g) || []).length) delimiter = '\t';

      Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        delimiter: delimiter,
        transformHeader: (header) => header.trim().replace(/["']/g, '').toUpperCase(), // 💪 Limpieza total de encabezados
        complete: (results) => {
          const imported = [];
          let updated = 0;
          let errors = 0;

          if (!results.data || results.data.length === 0) {
            showToast('El archivo está vacío o tiene formato incorrecto.', true);
            importLoader.classList.add('hidden');
            importSubmitBtn.disabled = false;
            return;
          }

          results.data.forEach((row, idx) => {
            try {
              if (!row || Object.values(row).every(v => v === '')) return;

              // Normalizamos las claves del objeto row
              const cleanRow = {};
              for (const [key, val] of Object.entries(row)) {
                cleanRow[key.trim().toUpperCase()] = val;
              }

              const newProduct = {
                id: generateId(),
                itemNumber: sanitizeInput(String(cleanRow['ITEM NUMBER'] || '').trim()),
                description: sanitizeInput(String(cleanRow['DESCRIPTION'] || '').trim()),
                upc: sanitizeInput(String(cleanRow['UPC'] || '').trim()),
                nombre: sanitizeInput(String(cleanRow['NOMBRE'] || '').trim()),
                size: cleanRow['SIZE'] ? sanitizeInput(String(cleanRow['SIZE']).trim()) : null,
                qty: cleanRow['QTY'] && !isNaN(cleanRow['QTY']) ? parseFloat(cleanRow['QTY']) : 0,
                costo: cleanRow['COSTO'] && !isNaN(parseFloat(String(cleanRow['COSTO']).replace(',', '.')))
                  ? parseFloat(String(cleanRow['COSTO']).replace(',', '.'))
                  : 0,
                url: cleanRow['URL'] ? sanitizeInput(String(cleanRow['URL']).trim()) : '',
                proveedor: cleanRow['PALIMEX'] ? sanitizeInput(String(cleanRow['PALIMEX']).trim()) : '',
                customFields: {},
                dateAdded: Date.now()
              };

              // Guarda PALIMEX también como customField si existe
              if (cleanRow['PALIMEX']) {
                newProduct.customFields['PALIMEX'] = sanitizeInput(String(cleanRow['PALIMEX']).trim());
              }

              // Guardar campos extra como personalizados
              for (const [key, val] of Object.entries(cleanRow)) {
                if (!['ITEM NUMBER','DESCRIPTION','UPC','NOMBRE','SIZE','QTY','COSTO','URL','PALIMEX'].includes(key)) {
                  if (val != null && val !== '') {
                    newProduct.customFields[sanitizeInput(key)] = sanitizeInput(String(val).trim());
                  }
                }
              }

              // Actualizar o agregar producto
              // First check in existing products array
              let existing = products.find(p =>
                (p.itemNumber && p.itemNumber === newProduct.itemNumber) ||
                (p.upc && p.upc === newProduct.upc)
              );
              
              // Also check in already imported products (to handle duplicates within the CSV)
              if (!existing) {
                existing = imported.find(p =>
                  (p.itemNumber && p.itemNumber === newProduct.itemNumber) ||
                  (p.upc && p.upc === newProduct.upc)
                );
              }

              if (existing) {
                // Preserve the existing ID and merge customFields
                const existingId = existing.id;
                const existingDateAdded = existing.dateAdded || newProduct.dateAdded;
                const mergedCustomFields = { ...existing.customFields, ...newProduct.customFields };
                Object.assign(existing, newProduct);
                existing.id = existingId;
                existing.dateAdded = existingDateAdded;
                existing.customFields = mergedCustomFields;
                updated++;
              } else {
                imported.push(newProduct);
              }

            } catch (e) {
              console.error(`Error en fila ${idx + 1}:`, e);
              errors++;
            }
          });

          products = [...products, ...imported];
          saveData();
          renderAdminProducts();
          renderPublicTabs();

          // Build comprehensive message showing new, updated, and errors
          const totalProcessed = imported.length + updated;
          let msg = '';
          if (errors > 0) {
            msg = `Procesados ${totalProcessed} productos (${imported.length} nuevos, ${updated} actualizados), ${errors} errores.`;
          } else if (updated > 0 && imported.length > 0) {
            msg = `Importados ${imported.length} productos nuevos y ${updated} actualizados correctamente.`;
          } else if (updated > 0) {
            msg = `Actualizados ${updated} productos correctamente.`;
          } else {
            msg = `Importados ${imported.length} productos correctamente.`;
          }
          showToast(msg, errors > 0);

          importModal.classList.add('hidden');
          importLoader.classList.add('hidden');
          importSubmitBtn.disabled = false;
        },
        error: (err) => {
          console.error('CSV parse error:', err);
          showToast('Error al procesar el CSV.', true);
          importLoader.classList.add('hidden');
          importSubmitBtn.disabled = false;
        }
      });
    };

    reader.readAsText(file, 'UTF-8');
  } catch (e) {
    console.error('Import error:', e);
    showToast('Error al importar CSV.', true);
    importLoader.classList.add('hidden');
    importSubmitBtn.disabled = false;
  }
}
        // ==== Validación + libs + vistas ====
        function validateForm(_, fields){
            let ok=true;
            fields.forEach(f=>{
                const el=document.getElementById(f.id); const errEl=document.getElementById(`${f.id}Error`);
                if(!el||!errEl) return; errEl.classList.add('hidden'); errEl.textContent='';
                if(f.required && !el.value.trim()){ errEl.textContent=`${f.label} es obligatorio.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.type==='number' && el.value && isNaN(parseFloat(el.value))){ errEl.textContent=`Ingresa un número válido para ${f.label}.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.type==='int' && el.value && !Number.isInteger(parseFloat(el.value))){ errEl.textContent=`${f.label} debe ser entero.`; errEl.classList.remove('hidden'); ok=false; }
                else if(f.min!=null && parseFloat(el.value)<f.min){ errEl.textContent=`${f.label} debe ser ≥ ${f.min}.`; errEl.classList.remove('hidden'); ok=false; }
            });
            return ok;
        }
        function checkLibraries(){ if(!window.Papa) showToast('Error: PapaParse no se cargó.', true); if(!window.jspdf || !window.html2canvas) showToast('Error: librerías PDF no cargadas.', true); }
        function showView(view){ 
            currentView=view; 
            document.getElementById('creditosView').classList.add('hidden');
            document.getElementById('especialesView').classList.add('hidden');
            if(view==='admin'){ 
                adminView.classList.remove('hidden'); 
                publicView.classList.add('hidden'); 
            } else { 
                adminView.classList.add('hidden'); 
                publicView.classList.remove('hidden'); 
            }
            updateHeaderButtons();
        }

        // ==== Export PDF ====
        function exportToPDF(){
            try{
                if(!window.jspdf){ showToast('No se pudo cargar jsPDF.', true); return; }
                const { jsPDF } = window.jspdf;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<div class="loader inline-block"></div> Exportando...';
                const doc = new jsPDF();
                doc.autoTable({
                    head: [[ 'Nombre','Descripción','Número de Ítem','UPC','Tamaño','Cantidad','Costo' ]],
                    body: products.map(p=> [ sanitizeInput(p.nombre||'N/A'), sanitizeInput(p.description||'N/A'), sanitizeInput(p.itemNumber||'N/A'), sanitizeInput(p.upc||'N/A'), sanitizeInput(p.size||'N/A'), sanitizeInput(p.qty||'N/A'), formatCurrency(p.costo||0) ]),
                    theme: 'grid', headStyles:{ fillColor:[99,102,241] }, styles:{ font:'helvetica', fontSize:10 }, margin:{ top:20 },
                    didDrawPage: (data)=>{ if(data.pageNumber===1){ doc.setFontSize(18); doc.text('Catálogo de Productos', data.settings.margin.left, 10); doc.setFontSize(10); doc.text(`Generado el ${new Date().toLocaleDateString('es-MX')}`, data.settings.margin.left, 15); } }
                });
                doc.save('catalogo-productos.pdf');
                showToast('Catálogo exportado correctamente a PDF.');
            }catch(e){ console.error('PDF error:', e); showToast('Error al generar el PDF.', true); }
            finally{ exportBtn.disabled=false; exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>Exportar PDF`; }
        }

        // ==== Toast ====
        function showToast(message, isError=false){
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 flex items-center z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white`;
            toast.classList.remove('translate-y-20','opacity-0');
            setTimeout(()=> toast.classList.add('translate-y-20','opacity-0'), 3000);
        }

        // ==== Eventos ====
        function setupEventListeners(){
            // Búsquedas
            if(searchInput) searchInput.addEventListener('input', debounce(renderAdminProducts, 300));
            publicSearchInput.addEventListener('input', debounce(()=> {
                currentPage = 1; // Reset to first page on new search
                renderPublicTabs(sanitizeInput(publicSearchInput.value));
            }, 300));

            // Pagination
            if(prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderPublicTabs(publicSearchInput?.value || '');
                        publicView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
            if(nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    if (!nextPageBtn.disabled) {
                        currentPage++;
                        renderPublicTabs(publicSearchInput?.value || '');
                        publicView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }

            // Cierre modales
            document.getElementById('closeDetailModal').addEventListener('click', ()=> productDetailModal.classList.add('hidden'));
            document.getElementById('closeFormModal').addEventListener('click', ()=> productFormModal.classList.add('hidden'));
            document.getElementById('cancelProductBtn').addEventListener('click', ()=> productFormModal.classList.add('hidden'));
            document.getElementById('closeImportModal').addEventListener('click', ()=> importModal.classList.add('hidden'));

            // Nuevo producto
            addProductBtn.addEventListener('click', ()=>{ productForm.reset(); productIdInput.value=''; formTitle.textContent='Nuevo Producto'; productFormModal.classList.remove('hidden'); });

            // Import CSV
            importBtn.addEventListener('click', ()=>{ importForm.reset(); fileNameText.textContent='Ningún archivo seleccionado'; importModal.classList.remove('hidden'); });
            importForm.addEventListener('submit', (e)=>{ e.preventDefault(); const f=csvFileInput.files?.[0]; if(f) importFromCSV(f); else showToast('Selecciona un archivo CSV.', true); });
            csvFileInput.addEventListener('change', (e)=>{ fileNameText.textContent = sanitizeInput(e.target.files[0]?.name || 'Ningún archivo seleccionado'); });

            // Export PDF
            exportBtn.addEventListener('click', exportToPDF);

            // Delegación ver detalles
            productsContainer.addEventListener('click', (e)=>{ const btn=e.target.closest('.view-details'); if(btn) showProductDetails(btn.dataset.id); });
            publicTabContent.addEventListener('click', (e)=>{ const btn=e.target.closest('.view-details'); if(btn) showProductDetails(btn.dataset.id); });

            // Eliminar individual desde modal
            deleteProductBtn.addEventListener('click', ()=>{
                const id = deleteProductBtn.dataset.id;
                if(confirm('¿Eliminar este producto?')){
                    products = products.filter(p=> p.id!==id);
                    saveData(); renderAdminProducts(); renderPublicTabs(); productDetailModal.classList.add('hidden'); showToast('Producto eliminado correctamente.');
                    if(selection.has(id)) selection.delete(id); updateDeleteButton();
                }
            });

            // Custom fields
            addCustomFieldBtn.addEventListener('click', ()=>{ customFieldForm.classList.remove('hidden'); addCustomFieldBtn.classList.add('hidden'); customKey.value=''; customValue.value=''; saveCustomField.disabled=true; });
            cancelCustomField.addEventListener('click', ()=>{ customFieldForm.classList.add('hidden'); addCustomFieldBtn.classList.remove('hidden'); });
            function updateSaveCustomButton(){ saveCustomField.disabled = !(customKey.value.trim() && customValue.value.trim()); }
            customKey.addEventListener('input', updateSaveCustomButton); customValue.addEventListener('input', updateSaveCustomButton);
            saveCustomField.addEventListener('click', ()=>{
                const key=sanitizeInput(customKey.value.trim()); const value=sanitizeInput(customValue.value.trim()); if(!key){ showToast('La clave es obligatoria.', true); return; }
                const id=deleteProductBtn.dataset.id; const product=products.find(p=> p.id===id);
                if(product){ if(!product.customFields) product.customFields={}; product.customFields[key]=value; saveData(); showProductDetails(id); customFieldForm.classList.add('hidden'); addCustomFieldBtn.classList.remove('hidden'); showToast('Campo personalizado agregado.'); renderAdminProducts(); renderPublicTabs(); }
            });

            // Vista admin/public
            adminViewBtn.addEventListener('click', ()=>{ passwordModal.classList.remove('hidden'); adminPasswordInput.focus(); closeMobileMenu(); });
            publicViewBtn.addEventListener('click', ()=> { showView('public'); closeMobileMenu(); });
            confirmPassword.addEventListener('click', ()=>{ if(adminPasswordInput.value===adminPassword){ passwordModal.classList.add('hidden'); showView('admin'); } else showToast('Contraseña incorrecta.', true); adminPasswordInput.value=''; });
            cancelPassword.addEventListener('click', ()=>{ passwordModal.classList.add('hidden'); adminPasswordInput.value=''; });
            adminPasswordInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') confirmPassword.click(); });

            // Seleccionar todos
            selectAll.addEventListener('change', (e)=>{
                const cards=document.querySelectorAll('#productsContainer [data-id]');
                if(e.target.checked){ cards.forEach(card=>{ const id=card.dataset.id; if(!selection.has(id)) selection.add(id); card.classList.add('selected-card'); }); }
                else { clearSelection(); }
                updateDeleteButton();
            });
            // Eliminar seleccionados
            deleteSelected.addEventListener('click', ()=>{ if(selection.size===0) return; if(!confirm(`¿Eliminar ${selection.size} productos seleccionados?`)) return; const ids=new Set(selection); products = products.filter(p=> !ids.has(p.id)); saveData(); renderAdminProducts(); renderPublicTabs(); clearSelection(); showToast('Productos eliminados correctamente.'); });

            // Cerrar modales clic fuera
            window.addEventListener('click', (e)=>{ if(e.target===productDetailModal) productDetailModal.classList.add('hidden'); if(e.target===productFormModal) productFormModal.classList.add('hidden'); if(e.target===importModal) importModal.classList.add('hidden'); if(e.target===passwordModal) passwordModal.classList.add('hidden'); });

            // Guardar producto (alta/edición)
            productForm.addEventListener('submit', (e)=>{
                e.preventDefault();
                const fields=[
                    { id:'itemNumber', label:'Número de Ítem', required:true },
                    { id:'upc', label:'UPC', required:true },
                    { id:'nombre', label:'Nombre', required:true },
                    { id:'size', label:'Tamaño', required:true },
                    { id:'qty', label:'Cantidad', required:true, type:'number', min:0 },
                    { id:'costo', label:'Costo', required:true, type:'number', min:0 },
                    { id:'description', label:'Descripción', required:true }
                ];
                if(!validateForm('productForm', fields)) return;
                const productId=productIdInput.value;
                const newProduct={
                    id: productId || generateId(),
                    itemNumber: sanitizeInput(itemNumberInput.value),
                    description: sanitizeInput(descriptionInput.value),
                    upc: sanitizeInput(upcInput.value),
                    nombre: sanitizeInput(nombreInput.value),
                    size: sanitizeInput(sizeInput.value),
                    qty: parseFloat(qtyInput.value),
                    costo: parseFloat(costoInput.value),
                    url: urlInput.value || '',
                    customFields: {},
                    dateAdded: Date.now() // NUEVO: necesario para badge "NEW"
                };
                if(productId){
                    const p = products.find(x=> x.id===productId);
                    if(p){ newProduct.customFields = p.customFields || {}; newProduct.dateAdded = p.dateAdded || newProduct.dateAdded; Object.assign(p, newProduct); }
                } else { products.push(newProduct); }
                saveData(); renderAdminProducts(); renderPublicTabs(); showToast(productId ? 'Producto actualizado correctamente.' : 'Producto agregado correctamente.'); productFormModal.classList.add('hidden');
            });
        }

        // ==== Drag selection (admin) ====
        (function enableDragSelection(){
            let isDragging=false, startX=0, startY=0, selectionBox=null;
            const container = document.getElementById('productsContainer');
            if(!container) return;
            container.addEventListener('mousedown', (e)=>{
                if(e.target.closest('button') || e.target.closest('input') || e.target.closest('svg')) return;
                isDragging=true; startX=e.pageX; startY=e.pageY;
                selectionBox=document.createElement('div');
                Object.assign(selectionBox.style,{ position:'absolute', border:'2px solid rgba(59,130,246,0.7)', background:'rgba(59,130,246,0.2)', pointerEvents:'none', zIndex:'9999' });
                document.body.appendChild(selectionBox);
            });
            document.addEventListener('mousemove', (e)=>{
                if(!isDragging||!selectionBox) return; const x1=Math.min(e.pageX,startX), y1=Math.min(e.pageY,startY), x2=Math.max(e.pageX,startX), y2=Math.max(e.pageY,startY);
                selectionBox.style.left=`${x1}px`; selectionBox.style.top=`${y1}px`; selectionBox.style.width=`${x2-x1}px`; selectionBox.style.height=`${y2-y1}px`;
            });
            document.addEventListener('mouseup', ()=>{
                if(!isDragging) return; isDragging=false; if(selectionBox){ const rect=selectionBox.getBoundingClientRect(); document.querySelectorAll('#productsContainer [data-id]').forEach(card=>{ const cr=card.getBoundingClientRect(); const overlap = !(rect.right<cr.left || rect.left>cr.right || rect.bottom<cr.top || rect.top>cr.bottom); if(overlap){ const id=card.dataset.id; selection.add(id); card.classList.add('selected-card'); } }); updateDeleteButton(); document.body.removeChild(selectionBox); selectionBox=null; }
            });
            document.addEventListener('mouseleave', ()=>{ if(isDragging){ isDragging=false; if(selectionBox){ document.body.removeChild(selectionBox); selectionBox=null; } } });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && selectionBox){ isDragging=false; document.body.removeChild(selectionBox); selectionBox=null; } });
        })();

        // ==== Edición inline del Item Code (solo admin) ====
        (function enableInlineItemEdit(){
            const itemSpan = document.getElementById('productItemNumber'); if(!itemSpan) return;
            itemSpan.addEventListener('click', ()=>{
                if(currentView!=='admin') return;
                const currentValue=itemSpan.textContent.trim();
                const input=document.createElement('input'); input.type='text'; input.value=currentValue==='N/A' ? '' : currentValue; input.className='border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-mexican-green focus:border-transparent'; input.style.width='100px';
                itemSpan.replaceWith(input); input.focus();
                const saveChange=()=>{
                    const newValue=input.value.trim()||'N/A'; const productId=deleteProductBtn.dataset.id; const product=products.find(p=> p.id===productId); if(!product) return; product.itemNumber=newValue; saveData(); const newSpan=document.createElement('span'); newSpan.id='productItemNumber'; newSpan.className='text-gray-700 cursor-pointer'; newSpan.textContent=newValue; input.replaceWith(newSpan); showToast('Item Code actualizado correctamente.'); renderAdminProducts(); renderPublicTabs(); enableInlineItemEdit();
                };
                input.addEventListener('blur', saveChange); input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') input.blur(); });
            });
        })();

        // ==== ESPECIALES FUNCTIONALITY ====
        let especiales = [];

        // Load especiales from Firebase with localStorage fallback
        function loadEspeciales() {
            try {
                if (database) {
                    database.ref('especiales').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data && Array.isArray(data) && data.length > 0) {
                            especiales = data;
                        } else {
                            // Initialize with simulated data
                            especiales = [
                                {
                                    id_price: 1,
                                    id_provider: 101,
                                    provider: 'Avocado',
                                    product: 'Pozole Juanitas',
                                    price: 5.99
                                },
                                {
                                    id_price: 2,
                                    id_provider: 102,
                                    provider: 'La Costeña',
                                    product: 'Frijoles Negros Refritos',
                                    price: 3.50
                                },
                                {
                                    id_price: 3,
                                    id_provider: 103,
                                    provider: 'Herdez',
                                    product: 'Salsa Verde 7oz',
                                    price: 2.99
                                },
                                {
                                    id_price: 4,
                                    id_provider: 101,
                                    provider: 'Avocado',
                                    product: 'Aguacate Fresco Orgánico',
                                    price: 4.25
                                },
                                {
                                    id_price: 5,
                                    id_provider: 104,
                                    provider: 'Maseca',
                                    product: 'Harina de Maíz 2kg',
                                    price: 6.99
                                },
                                {
                                    id_price: 6,
                                    id_provider: 105,
                                    provider: 'Bimbo',
                                    product: 'Pan Blanco Grande',
                                    price: 3.75
                                },
                                {
                                    id_price: 7,
                                    id_provider: 102,
                                    provider: 'La Costeña',
                                    product: 'Jalapeños en Rajas',
                                    price: 2.49
                                },
                                {
                                    id_price: 8,
                                    id_provider: 106,
                                    provider: 'Jumex',
                                    product: 'Néctar de Mango 1L',
                                    price: 1.99
                                }
                            ];
                            saveEspeciales();
                        }
                        // Render if we're in especiales view
                        if (currentView === 'especiales') {
                            renderEspeciales(document.getElementById('especialesSearchInput')?.value || '');
                        }
                        console.log('Especiales synchronized from Firebase.');
                    });
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (err) {
                console.warn('Using localStorage for especiales', err);
                if (isLocalStorageAvailable()) {
                    const stored = localStorage.getItem('especiales');
                    if (stored) {
                        especiales = JSON.parse(stored);
                    } else {
                        // Initialize with simulated data
                        especiales = [
                            {
                                id_price: 1,
                                id_provider: 101,
                                provider: 'Avocado',
                                product: 'Pozole Juanitas',
                                price: 5.99
                            },
                            {
                                id_price: 2,
                                id_provider: 102,
                                provider: 'La Costeña',
                                product: 'Frijoles Negros Refritos',
                                price: 3.50
                            },
                            {
                                id_price: 3,
                                id_provider: 103,
                                provider: 'Herdez',
                                product: 'Salsa Verde 7oz',
                                price: 2.99
                            },
                            {
                                id_price: 4,
                                id_provider: 101,
                                provider: 'Avocado',
                                product: 'Aguacate Fresco Orgánico',
                                price: 4.25
                            },
                            {
                                id_price: 5,
                                id_provider: 104,
                                provider: 'Maseca',
                                product: 'Harina de Maíz 2kg',
                                price: 6.99
                            },
                            {
                                id_price: 6,
                                id_provider: 105,
                                provider: 'Bimbo',
                                product: 'Pan Blanco Grande',
                                price: 3.75
                            },
                            {
                                id_price: 7,
                                id_provider: 102,
                                provider: 'La Costeña',
                                product: 'Jalapeños en Rajas',
                                price: 2.49
                            },
                            {
                                id_price: 8,
                                id_provider: 106,
                                provider: 'Jumex',
                                product: 'Néctar de Mango 1L',
                                price: 1.99
                            }
                        ];
                        saveEspeciales();
                    }
                }
            }
        }

        // Save especiales to Firebase and localStorage
        function saveEspeciales() {
            return new Promise((resolve) => {
                try {
                    if (database) {
                        database.ref('especiales').set(especiales)
                            .then(() => {
                                console.log('Especiales saved to Firebase successfully');
                                if (isLocalStorageAvailable()) {
                                    localStorage.setItem('especiales', JSON.stringify(especiales));
                                }
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error for especiales, using localStorage as fallback', err);
                                if (isLocalStorageAvailable()) {
                                    localStorage.setItem('especiales', JSON.stringify(especiales));
                                }
                                resolve(); // Resolve with localStorage fallback instead of rejecting
                            });
                    } else {
                        if (isLocalStorageAvailable()) {
                            localStorage.setItem('especiales', JSON.stringify(especiales));
                        }
                        resolve();
                    }
                } catch (err) {
                    console.error('Error saving especiales:', err);
                    if (isLocalStorageAvailable()) {
                        localStorage.setItem('especiales', JSON.stringify(especiales));
                    }
                    resolve(); // Resolve to prevent UI from hanging on error
                }
            });
        }

        // Show especiales view
        function showEspecialesView() {
            currentView = 'especiales';
            
            // Hide all main sections
            adminView.classList.add('hidden');
            publicView.classList.add('hidden');
            document.getElementById('creditosView').classList.add('hidden');
            document.getElementById('especialesView').classList.remove('hidden');
            
            renderEspeciales();
            updateHeaderButtons();
        }

        // Render especiales
        function renderEspeciales(searchTerm = '') {
            const container = document.getElementById('especialesContainer');
            container.innerHTML = '';
            
            let filtered = [...especiales];
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(e => 
                    (e.nombre && e.nombre.toLowerCase().includes(term)) ||
                    (e.upc && e.upc.toLowerCase().includes(term)) ||
                    (e.provider && e.provider.toLowerCase().includes(term)) ||
                    (e.product && e.product.toLowerCase().includes(term))
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No se encontraron precios especiales</h3>
                        <p class="mt-1 text-gray-500">Intenta con otra búsqueda.</p>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(especial => {
                const card = document.createElement('div');
                card.className = 'especiales-card';
                
                // Show discount percentage if we have both prices
                let discountHTML = '';
                if (especial.antes && especial.price) {
                    const discount = ((especial.antes - especial.price) / especial.antes * 100).toFixed(0);
                    discountHTML = `<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full ml-2">-${discount}%</span>`;
                }
                
                card.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-mexican-green mb-1">${sanitizeInput(especial.nombre || especial.product || 'Sin nombre')}</h3>
                                ${especial.upc ? `<p class="text-sm text-gray-500 mb-2">UPC: ${sanitizeInput(especial.upc)}</p>` : ''}
                            </div>
                            <button class="delete-especial bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-all" data-id="${especial.id_price}" title="Eliminar especial">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="pt-3 border-t border-gray-200">
                        ${especial.antes ? `
                            <div class="mb-3">
                                <span class="text-sm text-gray-600">Precio Antes:</span>
                                <span class="text-lg font-semibold text-gray-500 line-through ml-2">${formatCurrency(especial.antes)}</span>
                            </div>
                        ` : ''}
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-2">Precio Especial:</span>
                                <span class="text-2xl font-bold text-mexican-green">${formatCurrency(especial.price)}</span>
                                ${discountHTML}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Setup delete button event listeners
            container.querySelectorAll('.delete-especial').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const especialId = parseInt(e.currentTarget.dataset.id, 10);
                    // Validate that the parse was successful and ID is positive
                    if (isNaN(especialId) || especialId <= 0) {
                        showToast('Error: ID de especial inválido', true);
                        return;
                    }
                    deleteEspecial(especialId);
                });
            });
        }

        // Helper function to get next ID from array
        function getNextId(array, idField, defaultStart = 1) {
            const validIds = array.filter(item => typeof item[idField] === 'number' && !isNaN(item[idField])).map(item => item[idField]);
            return validIds.length > 0 ? Math.max(...validIds) + 1 : defaultStart;
        }
        
        // Add new especial
        async function addEspecial(nombre, upc, antes, precio) {
            const newEspecial = {
                id_price: getNextId(especiales, 'id_price', 1),
                nombre: nombre,
                upc: upc,
                antes: parseFloat(antes),
                price: parseFloat(precio)
            };
            
            especiales.push(newEspecial);
            
            // Wait for save to complete
            await saveEspeciales();
            
            renderEspeciales(document.getElementById('especialesSearchInput')?.value || '');
            showToast('Especial agregado correctamente');
        }
        
        // Delete especial
        async function deleteEspecial(especialId) {
            // Validate that especialId is a valid positive number
            if (typeof especialId !== 'number' || isNaN(especialId) || especialId <= 0) {
                showToast('Error: ID de especial inválido', true);
                return;
            }
            
            const especial = especiales.find(e => e.id_price === especialId);
            if (!especial) {
                showToast('Error: Especial no encontrado', true);
                return;
            }
            
            const nombreProducto = especial.nombre || especial.product || 'este producto';
            if (!confirm(`¿Estás seguro de eliminar el especial de "${nombreProducto}"?`)) {
                return;
            }
            
            especiales = especiales.filter(e => e.id_price !== especialId);
            
            // Wait for save to complete
            await saveEspeciales();
            
            renderEspeciales(document.getElementById('especialesSearchInput')?.value || '');
            showToast('Especial eliminado correctamente');
        }
        
        // Setup especiales event listeners
        function setupEspecialesEventListeners() {
            // Navigation button
            const especialesViewBtnMobile = document.getElementById('especialesViewBtnMobile');
            if (especialesViewBtnMobile) {
                especialesViewBtnMobile.addEventListener('click', () => {
                    showEspecialesView();
                    closeMobileMenu();
                });
            }
            
            // Especiales en Tienda navigation button
            const especialesEnTiendaBtnMobile = document.getElementById('especialesEnTiendaBtnMobile');
            if (especialesEnTiendaBtnMobile) {
                especialesEnTiendaBtnMobile.addEventListener('click', () => {
                    showEspecialesView();
                    closeMobileMenu();
                });
            }
            
            // Search functionality
            const especialesSearchInput = document.getElementById('especialesSearchInput');
            if (especialesSearchInput) {
                especialesSearchInput.addEventListener('input', debounce(() => {
                    renderEspeciales(especialesSearchInput.value);
                }, 300));
            }
            
            // Add especial button
            const addEspecialBtn = document.getElementById('addEspecialBtn');
            const especialFormModal = document.getElementById('especialFormModal');
            const closeEspecialFormModal = document.getElementById('closeEspecialFormModal');
            const cancelEspecialBtn = document.getElementById('cancelEspecialBtn');
            const especialForm = document.getElementById('especialForm');
            
            if (addEspecialBtn) {
                addEspecialBtn.addEventListener('click', () => {
                    document.getElementById('especialFormTitle').textContent = 'Nuevo Especial';
                    document.getElementById('especialId').value = '';
                    document.getElementById('especialNombre').value = '';
                    document.getElementById('especialUpc').value = '';
                    document.getElementById('especialAntes').value = '';
                    document.getElementById('especialPrice').value = '';
                    especialFormModal.classList.remove('hidden');
                });
            }
            
            if (closeEspecialFormModal) {
                closeEspecialFormModal.addEventListener('click', () => {
                    especialFormModal.classList.add('hidden');
                });
            }
            
            if (cancelEspecialBtn) {
                cancelEspecialBtn.addEventListener('click', () => {
                    especialFormModal.classList.add('hidden');
                });
            }
            
            if (especialForm) {
                especialForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Guardando...';
                    
                    try {
                        const nombre = document.getElementById('especialNombre').value.trim();
                        const upc = document.getElementById('especialUpc').value.trim();
                        const antes = document.getElementById('especialAntes').value;
                        const precio = document.getElementById('especialPrice').value;
                        
                        // Validate all required fields
                        if (!nombre || !upc || !antes || !precio) {
                            showToast('Por favor completa todos los campos obligatorios', true);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        
                        // Validate prices are valid positive numbers
                        const antesNum = parseFloat(antes);
                        const precioNum = parseFloat(precio);
                        if (isNaN(antesNum) || antesNum < 0) {
                            showToast('Por favor ingresa un precio antes válido (mayor o igual a 0)', true);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        if (isNaN(precioNum) || precioNum < 0) {
                            showToast('Por favor ingresa un precio especial válido (mayor o igual a 0)', true);
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        
                        await addEspecial(nombre, upc, antes, precio);
                        especialFormModal.classList.add('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    } catch (error) {
                        console.error('Error saving especial:', error);
                        showToast('Error al guardar el especial. Por favor, intenta de nuevo.', true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Close modal on outside click
            if (especialFormModal) {
                especialFormModal.addEventListener('click', (e) => {
                    if (e.target === especialFormModal) {
                        especialFormModal.classList.add('hidden');
                    }
                });
            }
        }

        // ==== CRÉDITOS FUNCTIONALITY ====
        let credits = [];
        let currentCreditView = 'pending';
        let creditNotificationInterval = null;

        // Load credits from Firebase with localStorage fallback
        function loadCredits() {
            try {
                if (database) {
                    database.ref('credits').on('value', (snapshot) => {
                        credits = snapshot.val() || [];
                        // Render current view if we're in credits section
                        if (currentView === 'creditos') {
                            if (currentCreditView === 'pending') {
                                renderPendingCredits();
                            } else if (currentCreditView === 'history') {
                                renderHistoryCredits();
                            }
                        }
                        console.log('Credits synchronized from Firebase.');
                    });
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (err) {
                console.warn('Using localStorage for credits', err);
                if (isLocalStorageAvailable()) {
                    const stored = localStorage.getItem('credits');
                    credits = stored ? JSON.parse(stored) : [];
                }
            }
        }

        // Save credits to Firebase and localStorage
        function saveCredits() {
            return new Promise((resolve) => {
                try {
                    if (database) {
                        database.ref('credits').set(credits)
                            .then(() => {
                                console.log('Credits saved to Firebase successfully');
                                if (isLocalStorageAvailable()) {
                                    localStorage.setItem('credits', JSON.stringify(credits));
                                }
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error for credits, using localStorage as fallback', err);
                                if (isLocalStorageAvailable()) {
                                    localStorage.setItem('credits', JSON.stringify(credits));
                                }
                                resolve(); // Resolve with localStorage fallback instead of rejecting
                            });
                    } else {
                        if (isLocalStorageAvailable()) {
                            localStorage.setItem('credits', JSON.stringify(credits));
                        }
                        resolve();
                    }
                } catch (err) {
                    console.error('Error saving credits:', err);
                    if (isLocalStorageAvailable()) {
                        localStorage.setItem('credits', JSON.stringify(credits));
                    }
                    resolve(); // Resolve to prevent UI from hanging on error
                }
            });
        }

        // Generate unique ID for credits
        function generateCreditId() {
            return 'CR-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // Calculate days elapsed
        function getDaysElapsed(dateStr) {
            const creditDate = new Date(dateStr);
            const now = new Date();
            const diff = now - creditDate;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // Get time elapsed text
        function getTimeElapsedText(days) {
            if (days === 0) return 'Hoy';
            if (days === 1) return 'Hace 1 día';
            if (days < 7) return `Hace ${days} días`;
            if (days < 14) return `Hace ${Math.floor(days / 7)} semana${Math.floor(days / 7) > 1 ? 's' : ''}`;
            return `Hace ${Math.floor(days / 7)} semanas`;
        }

        // Get urgency class
        function getUrgencyClass(days) {
            if (days < 7) return 'credit-ok';
            if (days < 14) return 'credit-warning';
            return 'credit-urgent';
        }

        // Convert image to base64
        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Show credits view
        function showCreditsView(subView) {
            currentView = 'creditos';
            currentCreditView = subView;
            
            // Hide all main sections
            adminView.classList.add('hidden');
            publicView.classList.add('hidden');
            document.getElementById('creditosView').classList.remove('hidden');
            
            // Hide all credit subsections
            document.getElementById('creditosPending').classList.add('hidden');
            document.getElementById('creditosRegister').classList.add('hidden');
            document.getElementById('creditosDeliver').classList.add('hidden');
            document.getElementById('creditosHistory').classList.add('hidden');
            
            // Show requested subsection
            if (subView === 'pending') {
                document.getElementById('creditosPending').classList.remove('hidden');
                renderPendingCredits();
            } else if (subView === 'register') {
                document.getElementById('creditosRegister').classList.remove('hidden');
                initializeProductFields();
            } else if (subView === 'deliver') {
                document.getElementById('creditosDeliver').classList.remove('hidden');
            } else if (subView === 'history') {
                document.getElementById('creditosHistory').classList.remove('hidden');
                renderHistoryCredits();
            }
            
            // Update header buttons
            updateHeaderButtons();
        }

        // Update header button styles (mobile menu only)
        function updateHeaderButtons() {
            const publicBtn = document.getElementById('publicViewBtnMobile');
            const especialesBtn = document.getElementById('especialesViewBtnMobile');
            const creditosBtn = document.getElementById('creditosViewBtnMobile');
            const adminBtn = document.getElementById('adminViewBtnMobile');
            
            if (!publicBtn || !especialesBtn || !creditosBtn || !adminBtn) return;
            
            publicBtn.classList.remove('bg-mexican-green', 'text-white');
            especialesBtn.classList.remove('bg-mexican-green', 'text-white');
            creditosBtn.classList.remove('bg-mexican-green', 'text-white');
            adminBtn.classList.remove('bg-mexican-green', 'text-white', 'bg-mexican-red');
            
            publicBtn.classList.add('bg-white', 'text-mexican-green');
            especialesBtn.classList.add('bg-white', 'text-mexican-green');
            creditosBtn.classList.add('bg-white', 'text-mexican-green');
            adminBtn.classList.add('bg-white', 'text-mexican-green');
            
            if (currentView === 'public') {
                publicBtn.classList.remove('bg-white', 'text-mexican-green');
                publicBtn.classList.add('bg-mexican-green', 'text-white');
            } else if (currentView === 'especiales') {
                especialesBtn.classList.remove('bg-white', 'text-mexican-green');
                especialesBtn.classList.add('bg-mexican-green', 'text-white');
            } else if (currentView === 'creditos') {
                creditosBtn.classList.remove('bg-white', 'text-mexican-green');
                creditosBtn.classList.add('bg-mexican-green', 'text-white');
            } else if (currentView === 'admin') {
                adminBtn.classList.remove('bg-white', 'text-mexican-green');
                adminBtn.classList.add('bg-mexican-red', 'text-white');
            }
        }

        // Initialize product fields
        function initializeProductFields() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';
            addProductFieldToForm();
        }

        // Add product field to form
        function addProductFieldToForm() {
            const productsList = document.getElementById('productsList');
            const fieldIndex = productsList.children.length;
            
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'product-field p-4 mb-4 border-2 border-gray-200 rounded-lg';
            fieldDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-700">Producto ${fieldIndex + 1}</h4>
                    ${fieldIndex > 0 ? `<button type="button" class="remove-product-field bg-mexican-red text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-90">Eliminar</button>` : ''}
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad*</label>
                        <input type="number" class="product-qty w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green" required min="0.01" step="any" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripción* (máx 100 caracteres)</label>
                        <input type="text" class="product-desc w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green" required maxlength="100" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Últimos 4 Dígitos UPC* (solo números)</label>
                        <input type="text" pattern="[0-9]{4}" class="product-digits w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green" required maxlength="4" placeholder="0000" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Foto (Opcional - JPG/PNG, máx 5MB)</label>
                        <input type="file" accept="image/jpeg,image/png" class="product-photo w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green" />
                        <div class="product-photo-preview mt-2"></div>
                    </div>
                </div>
            `;
            
            productsList.appendChild(fieldDiv);
            
            // Setup photo preview
            const photoInput = fieldDiv.querySelector('.product-photo');
            const previewDiv = fieldDiv.querySelector('.product-photo-preview');
            
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('La foto debe ser menor a 5MB', true);
                        e.target.value = '';
                        return;
                    }
                    const base64 = await imageToBase64(file);
                    previewDiv.innerHTML = `<img src="${base64}" class="photo-preview" alt="Vista previa" />`;
                }
            });
            
            // Setup remove button
            if (fieldIndex > 0) {
                const removeBtn = fieldDiv.querySelector('.remove-product-field');
                removeBtn.addEventListener('click', () => {
                    fieldDiv.remove();
                    updateProductNumbers();
                });
            }
        }

        // Update product numbers
        function updateProductNumbers() {
            const fields = document.querySelectorAll('.product-field');
            fields.forEach((field, index) => {
                field.querySelector('h4').textContent = `Producto ${index + 1}`;
            });
        }

        // Render pending credits
        function renderPendingCredits(searchTerm = '', filter = 'all') {
            const container = document.getElementById('pendingCreditsContainer');
            container.innerHTML = '';
            
            let filtered = credits.filter(c => c.status === 'pending');
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(c => 
                    (c.provider || '').toLowerCase().includes(term) ||
                    c.products.some(p => 
                        p.desc.toLowerCase().includes(term) || 
                        p.digits.includes(term)
                    ) ||
                    (c.notes || '').toLowerCase().includes(term)
                );
            }
            
            // Apply time filter
            if (filter !== 'all') {
                filtered = filtered.filter(c => {
                    const days = getDaysElapsed(c.date);
                    if (filter === 'week1') return days < 7;
                    if (filter === 'week2') return days >= 7 && days < 14;
                    if (filter === 'week3') return days >= 14;
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No hay créditos pendientes</h3>
                        <p class="mt-1 text-gray-500">Registra un nuevo crédito para comenzar.</p>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(credit => {
                const days = getDaysElapsed(credit.date);
                const urgencyClass = getUrgencyClass(days);
                const timeText = getTimeElapsedText(days);
                const totalProducts = credit.products.reduce((sum, p) => sum + (parseFloat(p.qty) || 0), 0);
                const firstPhoto = credit.products[0]?.photo;
                
                // Build products list HTML
                const productsListHTML = credit.products.map(p => `
                    <li class="text-sm bg-gray-50 p-2 rounded">
                        <strong>${p.qty}x</strong> ${sanitizeInput(p.desc)}
                        <br/><span class="text-gray-600">Últimos 4 dígitos: ${sanitizeInput(p.digits)}</span>
                        ${p.photo ? `<br/><img src="${p.photo}" class="photo-thumbnail mt-1 view-photo-modal" alt="Producto" data-photo="${p.photo}" />` : ''}
                    </li>
                `).join('');
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover ${urgencyClass}`;
                card.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-grow">
                                <p class="text-sm text-gray-500">ID: ${credit.id}</p>
                                <h3 class="text-lg font-bold text-gray-900">${sanitizeInput(credit.provider || 'Sin proveedor')}</h3>
                            </div>
                            <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-3 py-1 rounded-full">Pendiente</span>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <p class="text-sm"><strong>Total Productos:</strong> ${totalProducts}</p>
                            <p class="text-sm"><strong>Fecha:</strong> ${new Date(credit.date).toLocaleDateString('es-MX')}</p>
                            <p class="text-sm"><strong>Tiempo:</strong> ${timeText}</p>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm font-semibold mb-2">Productos:</p>
                            <ul class="space-y-2">
                                ${productsListHTML}
                            </ul>
                        </div>
                        
                        ${credit.notes ? `
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm"><strong>Notas:</strong> ${sanitizeInput(credit.notes)}</p>
                            </div>
                        ` : ''}
                        
                        <button class="mark-delivered w-full bg-mexican-green hover:bg-opacity-90 text-white px-4 py-2 rounded-lg font-medium transition-all" data-credit-id="${credit.id}">
                            Marcar como Entregado
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Setup event listeners for mark delivered buttons
            container.querySelectorAll('.mark-delivered').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const creditId = e.target.dataset.creditId;
                    const credit = credits.find(c => c.id === creditId);
                    if (!credit) return;
                    
                    // Show confirmation dialog
                    const totalProducts = credit.products.reduce((sum, p) => sum + (parseFloat(p.qty) || 0), 0);
                    const confirmMsg = `¿Deseas marcar como entregado el crédito?\n\nID: ${credit.id}\nProveedor: ${credit.provider || 'Sin proveedor'}\nTotal Productos: ${totalProducts}\n\nPresiona "Aceptar" para continuar o "Cancelar" para volver.`;
                    
                    if (confirm(confirmMsg)) {
                        showDeliverForm(creditId);
                    }
                });
            });
            
            // Setup event listeners for photo thumbnails
            container.querySelectorAll('.view-photo-modal').forEach(img => {
                img.addEventListener('click', (e) => {
                    showPhotoModal(e.target.dataset.photo);
                });
            });
        }

        // Show deliver form
        function showDeliverForm(creditId) {
            const credit = credits.find(c => c.id === creditId);
            if (!credit) return;
            
            document.getElementById('deliverCreditId').value = creditId;
            document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deliveryNotes').value = '';
            document.getElementById('deliveryPhoto').value = '';
            document.getElementById('deliveryPhotoPreview').innerHTML = '';
            
            // Show credit summary with all details
            const totalProducts = credit.products.reduce((sum, p) => sum + (parseFloat(p.qty) || 0), 0);
            
            // Build products list HTML with all details
            const productsListHTML = credit.products.map(p => `
                <li class="bg-gray-50 p-3 rounded mb-2">
                    <div class="text-sm">
                        <strong>${p.qty}x</strong> ${sanitizeInput(p.desc)}
                        <br/><span class="text-gray-600">Últimos 4 dígitos: ${sanitizeInput(p.digits)}</span>
                    </div>
                    ${p.photo ? `
                        <div class="mt-2">
                            <img src="${p.photo}" class="photo-thumbnail view-photo-modal" alt="Producto" data-photo="${p.photo}" />
                        </div>
                    ` : ''}
                </li>
            `).join('');
            
            const summaryDiv = document.getElementById('creditSummary');
            summaryDiv.innerHTML = `
                <h3 class="text-lg font-bold mb-4">Resumen del Crédito</h3>
                <div class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="mb-2"><strong>ID:</strong> ${credit.id}</p>
                            <p class="mb-2"><strong>Proveedor:</strong> ${sanitizeInput(credit.provider || 'Sin proveedor')}</p>
                            <p class="mb-2"><strong>Fecha Registro:</strong> ${new Date(credit.date).toLocaleDateString('es-MX')}</p>
                            <p class="mb-2"><strong>Total Productos:</strong> ${totalProducts}</p>
                        </div>
                    </div>
                    
                    ${credit.notes ? `
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm"><strong>Notas del Crédito:</strong> ${sanitizeInput(credit.notes)}</p>
                        </div>
                    ` : ''}
                    
                    <div>
                        <p class="font-semibold mb-2">Productos:</p>
                        <ul class="space-y-2">
                            ${productsListHTML}
                        </ul>
                    </div>
                </div>
            `;
            
            // Setup photo modal for summary
            summaryDiv.querySelectorAll('.view-photo-modal').forEach(img => {
                img.addEventListener('click', (e) => {
                    showPhotoModal(e.target.dataset.photo);
                });
            });
            
            showCreditsView('deliver');
        }

        // Render history credits
        function renderHistoryCredits(searchTerm = '') {
            const container = document.getElementById('historyCreditsContainer');
            container.innerHTML = '';
            
            let filtered = credits.filter(c => c.status === 'delivered');
            
            // Apply search filter
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(c => 
                    (c.provider || '').toLowerCase().includes(term) ||
                    c.products.some(p => 
                        p.desc.toLowerCase().includes(term) || 
                        p.digits.includes(term)
                    )
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">No hay entregas registradas</h3>
                    </div>
                `;
                return;
            }
            
            filtered.forEach(credit => {
                // Build products list HTML with photos
                const productsListHTML = credit.products.map(p => `
                    <li class="text-sm bg-gray-50 p-2 rounded">
                        <strong>${p.qty}x</strong> ${sanitizeInput(p.desc)}
                        <br/><span class="text-gray-600">Últimos 4 dígitos: ${sanitizeInput(p.digits)}</span>
                        ${p.photo ? `<br/><img src="${p.photo}" class="photo-thumbnail mt-1 view-photo-modal" alt="Producto" data-photo="${p.photo}" />` : ''}
                    </li>
                `).join('');
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 card-hover';
                card.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-grow">
                                <p class="text-sm text-gray-500">ID: ${credit.id}</p>
                                <h3 class="text-lg font-bold text-gray-900">${sanitizeInput(credit.provider || 'Sin proveedor')}</h3>
                            </div>
                            <span class="bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">Entregado</span>
                        </div>
                        
                        <div class="space-y-2 mb-4">
                            <p class="text-sm"><strong>Fecha Registro:</strong> ${new Date(credit.date).toLocaleDateString('es-MX')}</p>
                            <p class="text-sm"><strong>Fecha Entrega:</strong> ${new Date(credit.deliveryDate).toLocaleDateString('es-MX')}</p>
                        </div>
                        
                        ${credit.notes ? `
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm"><strong>Notas del Crédito:</strong> ${sanitizeInput(credit.notes)}</p>
                            </div>
                        ` : ''}
                        
                        ${credit.deliveryNotes ? `
                            <div class="mb-4 p-3 bg-green-50 rounded-lg">
                                <p class="text-sm"><strong>Notas de Entrega:</strong> ${sanitizeInput(credit.deliveryNotes)}</p>
                            </div>
                        ` : ''}
                        
                        <div class="mb-4">
                            <p class="text-sm font-semibold mb-2">Productos:</p>
                            <ul class="space-y-2">
                                ${productsListHTML}
                            </ul>
                        </div>
                        
                        ${credit.deliveryPhoto ? `
                            <div class="mt-4">
                                <p class="text-sm font-semibold mb-2">Foto de entrega:</p>
                                <img src="${credit.deliveryPhoto}" class="photo-thumbnail mx-auto view-photo-modal" alt="Entrega" data-photo="${credit.deliveryPhoto}" />
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Setup event listeners for photo thumbnails
            container.querySelectorAll('.view-photo-modal').forEach(img => {
                img.addEventListener('click', (e) => {
                    showPhotoModal(e.target.dataset.photo);
                });
            });
        }

        // Show photo modal
        function showPhotoModal(photoUrl) {
            const modal = document.getElementById('photoModal');
            const img = document.getElementById('photoModalImage');
            img.src = photoUrl;
            modal.classList.remove('hidden');
        }

        // Check for overdue credits
        function checkOverdueCredits() {
            const overdue = credits.filter(c => {
                if (c.status !== 'pending') return false;
                const days = getDaysElapsed(c.date);
                return days > 7;
            });
            
            if (overdue.length > 0) {
                alert(`⚠️ Tienes ${overdue.length} crédito${overdue.length > 1 ? 's' : ''} con más de 7 días pendiente${overdue.length > 1 ? 's' : ''}.`);
            }
        }

        // Start notification interval
        function startCreditNotifications() {
            if (creditNotificationInterval) {
                clearInterval(creditNotificationInterval);
            }
            // Check every minute (60000 ms)
            creditNotificationInterval = setInterval(checkOverdueCredits, 60000);
        }

        // Stop notification interval
        function stopCreditNotifications() {
            if (creditNotificationInterval) {
                clearInterval(creditNotificationInterval);
                creditNotificationInterval = null;
            }
        }

        // Export history to CSV
        function exportHistoryToCSV() {
            const delivered = credits.filter(c => c.status === 'delivered');
            
            if (delivered.length === 0) {
                showToast('No hay entregas para exportar', true);
                return;
            }
            
            let csv = 'ID,Proveedor,Fecha Registro,Fecha Entrega,Productos,Notas Entrega\n';
            
            delivered.forEach(credit => {
                const products = credit.products.map(p => `${p.qty}x ${p.desc} (${p.digits})`).join('; ');
                csv += `"${credit.id}","${credit.provider || ''}","${credit.date}","${credit.deliveryDate}","${products}","${credit.deliveryNotes || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historial-creditos-${Date.now()}.csv`;
            link.click();
            
            showToast('Historial exportado correctamente');
        }

        // Setup credits event listeners
        function setupCreditsEventListeners() {
            // Navigation buttons
            const creditosViewBtnMobile = document.getElementById('creditosViewBtnMobile');
            const newCreditBtn = document.getElementById('newCreditBtn');
            const cancelNewCredit = document.getElementById('cancelNewCredit');
            const cancelDelivery = document.getElementById('cancelDelivery');
            const backToPendingBtn = document.getElementById('backToPendingBtn');
            const exportHistoryBtn = document.getElementById('exportHistoryBtn');
            
            if (creditosViewBtnMobile) {
                creditosViewBtnMobile.addEventListener('click', () => {
                    showCreditsView('pending');
                    closeMobileMenu();
                });
            }
            
            if (newCreditBtn) {
                newCreditBtn.addEventListener('click', () => {
                    showCreditsView('register');
                });
            }
            
            if (cancelNewCredit) {
                cancelNewCredit.addEventListener('click', () => {
                    showCreditsView('pending');
                });
            }
            
            if (cancelDelivery) {
                cancelDelivery.addEventListener('click', () => {
                    showCreditsView('pending');
                });
            }
            
            if (backToPendingBtn) {
                backToPendingBtn.addEventListener('click', () => {
                    showCreditsView('pending');
                });
            }
            
            if (exportHistoryBtn) {
                exportHistoryBtn.addEventListener('click', exportHistoryToCSV);
            }
            
            // Add product field button
            const addProductFieldBtn = document.getElementById('addProductField');
            if (addProductFieldBtn) {
                addProductFieldBtn.addEventListener('click', addProductFieldToForm);
            }
            
            // New credit form
            const newCreditForm = document.getElementById('newCreditForm');
            if (newCreditForm) {
                newCreditForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Guardando...';
                    
                    try {
                        const provider = document.getElementById('creditProvider').value.trim();
                        const date = document.getElementById('creditDate').value;
                        const notes = document.getElementById('creditNotes').value.trim();
                        
                        // Collect products
                        const productFields = document.querySelectorAll('.product-field');
                        const products = [];
                        
                        for (const field of productFields) {
                            const qty = field.querySelector('.product-qty').value;
                            const desc = field.querySelector('.product-desc').value.trim();
                            const digits = field.querySelector('.product-digits').value.trim();
                            const photoInput = field.querySelector('.product-photo');
                            
                            if (!qty || !desc || !digits) {
                                showToast('Completa todos los campos obligatorios del producto', true);
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            let photo = null;
                            if (photoInput.files[0]) {
                                photo = await imageToBase64(photoInput.files[0]);
                            }
                            
                            products.push({
                                qty: parseFloat(qty),
                                desc,
                                digits,
                                photo
                            });
                        }
                        
                        const newCredit = {
                            id: generateCreditId(),
                            provider,
                            products,
                            date,
                            notes,
                            status: 'pending'
                        };
                        
                        credits.push(newCredit);
                        
                        // Wait for save to complete before showing success
                        await saveCredits();
                        
                        showToast('Crédito registrado correctamente');
                        
                        // Add visual transition before showing credits view
                        setTimeout(() => {
                            showCreditsView('pending');
                        }, 500);
                    } catch (error) {
                        console.error('Error saving credit:', error);
                        showToast('Error al guardar el crédito. Por favor, intenta de nuevo.', true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Deliver credit form
            const deliverCreditForm = document.getElementById('deliverCreditForm');
            if (deliverCreditForm) {
                deliverCreditForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Guardando...';
                    
                    try {
                        const creditId = document.getElementById('deliverCreditId').value;
                        const deliveryDate = document.getElementById('deliveryDate').value;
                        const deliveryNotes = document.getElementById('deliveryNotes').value.trim();
                        const deliveryPhotoInput = document.getElementById('deliveryPhoto');
                        
                        const credit = credits.find(c => c.id === creditId);
                        if (!credit) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            return;
                        }
                        
                        credit.status = 'delivered';
                        credit.deliveryDate = deliveryDate;
                        credit.deliveryNotes = deliveryNotes;
                        
                        if (deliveryPhotoInput.files[0]) {
                            credit.deliveryPhoto = await imageToBase64(deliveryPhotoInput.files[0]);
                        }
                        
                        // Wait for save to complete before showing success
                        await saveCredits();
                        
                        showToast('Crédito marcado como entregado');
                        
                        // Add visual transition before showing credits view
                        setTimeout(() => {
                            showCreditsView('pending');
                        }, 500);
                    } catch (error) {
                        console.error('Error saving delivery:', error);
                        showToast('Error al marcar como entregado. Por favor, intenta de nuevo.', true);
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Credit date input - set default to today
            const creditDateInput = document.getElementById('creditDate');
            if (creditDateInput) {
                creditDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Search and filter
            const creditSearchInput = document.getElementById('creditSearchInput');
            const creditFilterSelect = document.getElementById('creditFilterSelect');
            const historySearchInput = document.getElementById('historySearchInput');
            
            if (creditSearchInput) {
                creditSearchInput.addEventListener('input', debounce(() => {
                    renderPendingCredits(creditSearchInput.value, creditFilterSelect?.value || 'all');
                }, 300));
            }
            
            if (creditFilterSelect) {
                creditFilterSelect.addEventListener('change', () => {
                    renderPendingCredits(creditSearchInput?.value || '', creditFilterSelect.value);
                });
            }
            
            if (historySearchInput) {
                historySearchInput.addEventListener('input', debounce(() => {
                    renderHistoryCredits(historySearchInput.value);
                }, 300));
            }
            
            // Character counters
            const creditNotesInput = document.getElementById('creditNotes');
            const deliveryNotesInput = document.getElementById('deliveryNotes');
            
            if (creditNotesInput) {
                creditNotesInput.addEventListener('input', (e) => {
                    document.getElementById('creditNotesCount').textContent = e.target.value.length;
                });
            }
            
            if (deliveryNotesInput) {
                deliveryNotesInput.addEventListener('input', (e) => {
                    document.getElementById('deliveryNotesCount').textContent = e.target.value.length;
                });
            }
            
            // Delivery photo preview
            const deliveryPhotoInput = document.getElementById('deliveryPhoto');
            if (deliveryPhotoInput) {
                deliveryPhotoInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    const previewDiv = document.getElementById('deliveryPhotoPreview');
                    
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            showToast('La foto debe ser menor a 5MB', true);
                            e.target.value = '';
                            previewDiv.innerHTML = '';
                            return;
                        }
                        const base64 = await imageToBase64(file);
                        previewDiv.innerHTML = `<img src="${base64}" class="photo-preview" alt="Vista previa" />`;
                    } else {
                        previewDiv.innerHTML = '';
                    }
                });
            }
            
            // Photo modal
            const closePhotoModal = document.getElementById('closePhotoModal');
            const photoModal = document.getElementById('photoModal');
            
            if (closePhotoModal) {
                closePhotoModal.addEventListener('click', () => {
                    photoModal.classList.add('hidden');
                });
            }
            
            if (photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.add('hidden');
                    }
                });
            }
            
            // Mobile menu
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                    mobileMenu.classList.toggle('mobile-menu-open');
                });
            }
            
            // Update public view button click handlers
            const publicViewBtnMobile = document.getElementById('publicViewBtnMobile');
            if (publicViewBtnMobile) {
                publicViewBtnMobile.addEventListener('click', () => {
                    showView('public');
                    closeMobileMenu();
                });
            }
            
            // Update admin view button click handlers
            const adminViewBtnMobile = document.getElementById('adminViewBtnMobile');
            if (adminViewBtnMobile) {
                adminViewBtnMobile.addEventListener('click', () => {
                    passwordModal.classList.remove('hidden');
                    adminPasswordInput.focus();
                    closeMobileMenu();
                });
            }
        }

        // Close mobile menu
        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.add('hidden');
                mobileMenu.classList.remove('mobile-menu-open');
            }
        }

        // ==== Truck Loader Control ====
        function hideTruckLoader() {
            const loader = document.getElementById('truckLoader');
            const mainContent = document.getElementById('mainContent');
            if (!loader) return;
            
            // Add fade-out class to trigger opacity transition
            loader.classList.add('fade-out');
            
            // After fade-out animation completes, hide the loader and show content
            setTimeout(() => {
                loader.classList.add('hidden');
                if (mainContent) {
                    mainContent.style.visibility = 'visible';
                }
            }, 800); // Match the CSS transition duration
        }

        // Initialize loader control
        (function() {
            const minDisplayTime = 3500; // 3.5 seconds minimum display time
            const startTime = Date.now();
            let hasHidden = false;
            
            function hideAfterMinTime() {
                if (hasHidden) return;
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, minDisplayTime - elapsed);
                
                setTimeout(() => {
                    hasHidden = true;
                    hideTruckLoader();
                }, remaining);
            }
            
            // Try to use 'load' event first (waits for all resources)
            window.addEventListener('load', hideAfterMinTime);
            
            // Fallback: Use DOMContentLoaded in case external resources are blocked
            document.addEventListener('DOMContentLoaded', () => {
                // Wait a bit for potential resources to load
                setTimeout(hideAfterMinTime, 500);
            });
            
            // Safety fallback: Always hide after max 5 seconds regardless
            setTimeout(() => {
                if (!hasHidden) {
                    hasHidden = true;
                    hideTruckLoader();
                }
            }, 5000);
        })();

        // ==== Init ====
        function init(){ 
            loadData(); 
            loadEspeciales();
            loadCredits();
            setupEventListeners(); 
            setupEspecialesEventListeners();
            setupCreditsEventListeners();
            checkLibraries(); 
            showView('public');
            startCreditNotifications();
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
