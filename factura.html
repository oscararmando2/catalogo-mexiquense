<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n - MEXIQUENSE MARKET LLC</title>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles - A4 Invoice Design */
        .invoice-header {
            background: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        
        .logo-section {
            margin-bottom: 15px;
        }
        
        .logo-section img {
            height: 60px;
            max-width: 200px;
            object-fit: contain;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .left-section {
            flex: 1;
        }
        
        .invoice-badge {
            display: inline-block;
            background: #c00;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 8px;
        }
        
        .company-info {
            color: #000;
        }
        
        .company-info h1 {
            font-size: 16px;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .company-info p {
            font-size: 13px;
            margin: 2px 0;
            color: #000;
        }
        
        .company-info .invoice-date {
            margin-top: 8px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .right-section {
            flex: 1;
            text-align: left;
        }
        
        .bill-to-header {
            font-size: 14px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }
        
        .bill-to-fields input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .bill-to-fields input:focus {
            outline: none;
            border-color: #006847;
            box-shadow: 0 0 3px rgba(0, 104, 71, 0.3);
        }
        
        /* Bill To Section - Removed as it's now in header */
        
        /* Actions Bar */
        .actions-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border: 1px solid #ddd;
            border-top: none;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #006847;
            color: white;
        }
        
        .btn-primary:hover {
            background: #004d35;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        /* Invoice Table */
        .invoice-table-container {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            overflow: visible;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .invoice-table th {
            background: #006847;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .invoice-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .invoice-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .invoice-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .invoice-table input:focus {
            outline: none;
            border-color: #006847;
        }
        
        .invoice-table input[type="number"] {
            text-align: right;
        }
        
        .invoice-table .upc-cell {
            position: relative;
            min-width: 150px;
        }
        
        .invoice-table .qty-cell {
            width: 80px;
        }
        
        .invoice-table .product-cell {
            position: relative;
            min-width: 200px;
        }
        
        /* Product Name Dropdown */
        .product-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .product-dropdown.show {
            display: block;
        }
        
        .product-dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .product-dropdown-item:hover {
            background: #f0f0f0;
        }
        
        .product-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .product-dropdown-item .product-name-match {
            font-weight: bold;
            color: #006847;
        }
        
        .product-dropdown-item .product-upc-info {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }
        
        .invoice-table .price-cell,
        .invoice-table .total-cell {
            width: 100px;
        }
        
        .invoice-table .delete-cell {
            width: 50px;
            text-align: center;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        /* UPC Dropdown */
        .upc-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .upc-dropdown.show {
            display: block;
        }
        
        .upc-dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .upc-dropdown-item:hover {
            background: #f0f0f0;
        }
        
        .upc-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .upc-dropdown-item .upc-code {
            font-weight: bold;
            color: #006847;
        }
        
        .upc-dropdown-item .product-name {
            color: #666;
            font-size: 12px;
            margin-top: 2px;
        }
        
        /* Total Section */
        .total-section {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
            text-align: right;
            border-radius: 0 0 8px 8px;
        }
        
        .total-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            margin: 10px 0;
        }
        
        .total-label {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: #006847;
            min-width: 150px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #006847;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #006847;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* File Input */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input {
            display: none;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: #28a745;
        }
        
        .toast.error {
            background: #dc3545;
        }
        
        /* Navigation back */
        .nav-back {
            margin-bottom: 20px;
        }
        
        .nav-back a {
            color: #006847;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        
        .nav-back a:hover {
            text-decoration: underline;
        }
        
        /* Print Styles */
        @media print {
            @page {
                size: letter;
                margin: 0.5in;
            }
            
            body {
                background: white;
                font-size: 11pt;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
            }
            
            .nav-back,
            .actions-bar,
            .delete-btn,
            .delete-cell,
            .btn {
                display: none !important;
            }
            
            .invoice-header {
                position: static;
                background: white;
                border: none;
                border-radius: 0;
            }
            
            .invoice-badge {
                background: #c00 !important;
                color: white !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .bill-to-fields input {
                border: none;
                padding: 3px 0;
                font-weight: 500;
            }
            
            .invoice-table-container {
                border: 1px solid #333;
            }
            
            .invoice-table th {
                background: #f0f0f0 !important;
                color: black !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .invoice-table input {
                border: none;
                padding: 5px;
                text-align: inherit;
            }
            
            .invoice-table .qty-cell input,
            .invoice-table .price-cell input,
            .invoice-table .total-cell input {
                text-align: right;
            }
            
            .total-section {
                border: 1px solid #333;
                border-top: none;
            }
            
            .total-amount {
                color: black;
            }
            
            .modal {
                display: none !important;
            }
            
            .toast {
                display: none !important;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                text-align: center;
            }
            
            .left-section,
            .right-section {
                text-align: center;
            }
            
            .actions-bar {
                justify-content: center;
            }
            
            .total-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Products Database Modal Styles */
        .modal-content-wide {
            max-width: 800px;
        }
        
        .products-db-search-container {
            margin-bottom: 15px;
        }
        
        .products-db-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .products-db-search:focus {
            outline: none;
            border-color: #006847;
        }
        
        .products-db-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .products-db-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-db-table th {
            background: #006847;
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .products-db-table th.text-right {
            text-align: right;
        }
        
        .products-db-table th.text-center {
            text-align: center;
        }
        
        .products-db-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .products-db-table td.text-right {
            text-align: right;
        }
        
        .products-db-table td.text-center {
            text-align: center;
        }
        
        .products-db-empty {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .products-db-empty p.sub-text {
            font-size: 13px;
            margin-top: 8px;
        }
        
        .products-db-count {
            color: #666;
            font-size: 13px;
            margin-right: auto;
        }
        
        .price-edit-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: right;
            font-size: 13px;
        }
        
        .price-edit-input:focus {
            outline: none;
            border-color: #006847;
        }
        
        .btn-save-price {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Add to Database Modal Styles */
        .confirm-product-value {
            font-weight: bold;
            color: #006847;
            margin: 0;
        }
        
        .confirm-modal-intro {
            margin-bottom: 15px;
        }
        
        /* Pending Invoices Modal Styles */
        .pending-invoices-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pending-invoice-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pending-invoice-item:hover {
            background: #e9ecef;
            border-color: #006847;
        }
        
        .pending-invoice-item.active {
            background: #d4edda;
            border-color: #28a745;
            border-width: 2px;
        }
        
        .pending-invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .pending-invoice-number {
            font-weight: bold;
            font-size: 16px;
            color: #006847;
        }
        
        .pending-invoice-date {
            color: #666;
            font-size: 13px;
        }
        
        .pending-invoice-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }
        
        .pending-invoice-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pending-invoice-total {
            font-weight: bold;
            color: #28a745;
        }
        
        .pending-invoices-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.saving {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-badge.saved {
            background: #d4edda;
            color: #155724;
        }
        
        /* Badge counter */
        .badge-counter {
            display: inline-block;
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
            min-width: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Back -->
        <div class="nav-back">
            <a href="index.html">‚Üê Volver al Cat√°logo</a>
        </div>
        
        <!-- Invoice Header - A4 Design -->
        <header class="invoice-header">
            <div class="logo-section">
                <img src="mexiquense market.png" alt="Mexiquense Market Logo">
            </div>
            <div class="header-top">
                <div class="left-section">
                    <div class="invoice-badge">
                        INVOICE #<span id="invoiceNumber">31</span>
                        <span class="status-badge pending" id="invoiceStatus">Pendiente</span>
                    </div>
                    <div class="company-info">
                        <h1>MEXIQUENSE MARKET LLC</h1>
                        <p>9525 LACKLAND RD</p>
                        <p>OVERLAND MO 63114</p>
                        <p class="invoice-date" id="invoiceDate"></p>
                    </div>
                </div>
                <div class="right-section">
                    <div class="bill-to-header">BILL TO:</div>
                    <div class="bill-to-fields">
                        <input type="text" id="clientName" placeholder="Nombre del cliente" value="Ayala Restaurant LLC">
                        <input type="text" id="clientAddress" placeholder="Direcci√≥n del cliente" value="9519 Lackland Rd, St. Louis,">
                        <input type="text" id="clientCity" placeholder="Ciudad, Estado, ZIP" value="MO 63114.">
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Actions Bar -->
        <div class="actions-bar">
            <button class="btn btn-primary" id="addRowBtn">
                + Agregar Fila
            </button>
            <button class="btn btn-success" id="newInvoiceBtn">
                Nueva Factura
            </button>
            <button class="btn btn-info" id="printBtn">
                Descargar PDF
            </button>
            <div class="file-input-wrapper">
                <input type="file" id="csvInput" class="file-input" accept=".csv">
                <button class="btn btn-secondary" id="loadCsvBtn">
                    Cargar CSV
                </button>
            </div>
            <button class="btn btn-primary" id="addProductBtn">
                + Nuevo Producto
            </button>
            <button class="btn btn-info" id="showProductsDbBtn">
                Productos
            </button>
            <button class="btn btn-secondary" id="changeInvoiceNumberBtn">
                Cambiar # Factura
            </button>
            <button class="btn btn-info" id="showPendingInvoicesBtn">
                üìã Facturas Pendientes<span class="badge-counter" id="pendingInvoicesBadge" style="display: none;">0</span>
            </button>
            <button class="btn btn-success" id="completeInvoiceBtn">
                ‚úÖ Terminar Factura
            </button>
        </div>
        
        <!-- Invoice Table -->
        <div class="invoice-table-container">
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>UPC</th>
                        <th>QTY</th>
                        <th>PRODUCT</th>
                        <th>PRICE</th>
                        <th>TOTAL</th>
                        <th class="delete-cell"></th>
                    </tr>
                </thead>
                <tbody id="invoiceBody">
                    <!-- Invoice rows will be added here -->
                </tbody>
            </table>
        </div>
        
        <!-- Total Section -->
        <section class="total-section">
            <div class="total-row">
                <span class="total-label">TOTAL GENERAL:</span>
                <span class="total-amount" id="grandTotal">$0.00</span>
            </div>
        </section>
    </div>
    
    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Nuevo Producto</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProductUpc">UPC *</label>
                    <input type="text" id="newProductUpc" placeholder="Ej: 070038372868">
                </div>
                <div class="form-group">
                    <label for="newProductName">Nombre del Producto *</label>
                    <input type="text" id="newProductName" placeholder="Ej: Best Choice Grade A Large 18 ct.">
                </div>
                <div class="form-group">
                    <label for="newProductPrice">Precio *</label>
                    <input type="number" id="newProductPrice" placeholder="Ej: 2.79" step="0.01" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelProductBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveProductBtn">Guardar Producto</button>
            </div>
        </div>
    </div>
    
    <!-- Products Database Modal -->
    <div class="modal" id="productsDbModal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h3>Base de Datos de Productos</h3>
                <button class="modal-close" id="closeProductsDbModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="products-db-search-container">
                    <input type="text" id="productsDbSearch" class="products-db-search" placeholder="Buscar por UPC o Nombre...">
                </div>
                <div id="productsDbTableContainer" class="products-db-table-container">
                    <table class="products-db-table">
                        <thead>
                            <tr>
                                <th>UPC</th>
                                <th>Nombre</th>
                                <th class="text-right">Precio</th>
                                <th class="text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="productsDbBody">
                            <!-- Products will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="productsDbEmpty" class="products-db-empty">
                    <p>No hay productos en la base de datos.</p>
                    <p class="sub-text">Carga un archivo CSV o agrega productos manualmente.</p>
                </div>
            </div>
            <div class="modal-footer">
                <span id="productsDbCount" class="products-db-count"></span>
                <button class="btn btn-secondary" id="closeProductsDbBtn">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Add Product to Database Confirmation Modal -->
    <div class="modal" id="addToDbModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>¬øAgregar producto a base de datos?</h3>
                <button class="modal-close" id="closeAddToDbModal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="confirm-modal-intro">Este producto no est√° en la base de datos. ¬øDeseas agregarlo para futuras facturas?</p>
                <div class="form-group">
                    <label>UPC:</label>
                    <p id="confirmProductUpc" class="confirm-product-value"></p>
                </div>
                <div class="form-group">
                    <label>Nombre del Producto:</label>
                    <p id="confirmProductName" class="confirm-product-value"></p>
                </div>
                <div class="form-group">
                    <label>Precio:</label>
                    <p id="confirmProductPrice" class="confirm-product-value"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddToDbBtn">No, gracias</button>
                <button class="btn btn-success" id="confirmAddToDbBtn">S√≠, agregar</button>
            </div>
        </div>
    </div>
    
    <!-- Change Invoice Number Modal -->
    <div class="modal" id="changeInvoiceNumberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cambiar N√∫mero de Factura</h3>
                <button class="modal-close" id="closeChangeInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="confirm-modal-intro">Ingresa el nuevo n√∫mero de factura. El pr√≥ximo n√∫mero autom√°tico ser√° este valor + 1.</p>
                <div class="form-group">
                    <label for="newInvoiceNumber">Nuevo N√∫mero de Factura *</label>
                    <input type="number" id="newInvoiceNumber" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-mexican-green" min="1" required />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelChangeInvoiceBtn">Cancelar</button>
                <button class="btn btn-success" id="confirmChangeInvoiceBtn">Cambiar N√∫mero</button>
            </div>
        </div>
    </div>
    
    <!-- Pending Invoices Modal -->
    <div class="modal" id="pendingInvoicesModal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h3>Facturas Pendientes</h3>
                <button class="modal-close" id="closePendingInvoicesModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pendingInvoicesList" class="pending-invoices-list">
                    <!-- Invoices will be added here dynamically -->
                </div>
                <div id="pendingInvoicesEmpty" class="pending-invoices-empty">
                    <p>No hay facturas pendientes.</p>
                    <p class="sub-text">Las facturas se guardan autom√°ticamente al trabajar en ellas.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closePendingInvoicesBtn">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // SISTEMA DE FACTURACI√ìN - MEXIQUENSE MARKET LLC
        // ============================================
        
        // ==== Firebase Configuration ====
        let database = null;
        try {
            const firebaseConfig = {
                apiKey: "TU_API_KEY_AQUI",
                authDomain: "catalogomexiquense.firebaseapp.com",
                databaseURL: "https://catalogomexiquense-default-rtdb.firebaseio.com",
                projectId: "catalogomexiquense",
                storageBucket: "catalogomexiquense.appspot.com",
                messagingSenderId: "TU_SENDER_ID_AQUI",
                appId: "TU_APP_ID_AQUI"
            };
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase initialized successfully for factura.html');
            }
        } catch(err) {
            console.warn('Firebase not available, using localStorage only', err);
        }
        
        // State
        let products = [];
        let invoiceNumber = 31;
        let invoiceRows = [];
        let pendingProductToAdd = null; // Stores product info for "add to database" confirmation
        let pendingInvoices = {}; // Stores all pending invoices
        let currentInvoiceId = null; // Current invoice being edited
        let autoSaveTimeout = null; // Debounce timeout for auto-save
        
        // Constants
        const MIN_VALID_PRICE = 0; // Minimum valid price to trigger add-to-database prompt
        const AUTOSAVE_DELAY = 1000; // Delay in ms before auto-saving
        
        // DOM Elements
        const invoiceBody = document.getElementById('invoiceBody');
        const grandTotalEl = document.getElementById('grandTotal');
        const invoiceNumberEl = document.getElementById('invoiceNumber');
        const invoiceDateEl = document.getElementById('invoiceDate');
        const addRowBtn = document.getElementById('addRowBtn');
        const newInvoiceBtn = document.getElementById('newInvoiceBtn');
        const printBtn = document.getElementById('printBtn');
        const loadCsvBtn = document.getElementById('loadCsvBtn');
        const csvInput = document.getElementById('csvInput');
        const addProductBtn = document.getElementById('addProductBtn');
        const addProductModal = document.getElementById('addProductModal');
        const closeModal = document.getElementById('closeModal');
        const cancelProductBtn = document.getElementById('cancelProductBtn');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const toast = document.getElementById('toast');
        
        // Products Database Modal Elements
        const showProductsDbBtn = document.getElementById('showProductsDbBtn');
        const productsDbModal = document.getElementById('productsDbModal');
        const closeProductsDbModal = document.getElementById('closeProductsDbModal');
        const closeProductsDbBtn = document.getElementById('closeProductsDbBtn');
        const productsDbBody = document.getElementById('productsDbBody');
        const productsDbSearch = document.getElementById('productsDbSearch');
        const productsDbCount = document.getElementById('productsDbCount');
        const productsDbEmpty = document.getElementById('productsDbEmpty');
        const productsDbTableContainer = document.getElementById('productsDbTableContainer');
        
        // Add to Database Confirmation Modal Elements
        const addToDbModal = document.getElementById('addToDbModal');
        const closeAddToDbModal = document.getElementById('closeAddToDbModal');
        const cancelAddToDbBtn = document.getElementById('cancelAddToDbBtn');
        const confirmAddToDbBtn = document.getElementById('confirmAddToDbBtn');
        const confirmProductUpc = document.getElementById('confirmProductUpc');
        const confirmProductName = document.getElementById('confirmProductName');
        const confirmProductPrice = document.getElementById('confirmProductPrice');
        
        // Change Invoice Number Modal Elements
        const changeInvoiceNumberModal = document.getElementById('changeInvoiceNumberModal');
        const closeChangeInvoiceModal = document.getElementById('closeChangeInvoiceModal');
        const cancelChangeInvoiceBtn = document.getElementById('cancelChangeInvoiceBtn');
        const confirmChangeInvoiceBtn = document.getElementById('confirmChangeInvoiceBtn');
        const newInvoiceNumberInput = document.getElementById('newInvoiceNumber');
        const changeInvoiceNumberBtn = document.getElementById('changeInvoiceNumberBtn');
        
        // Pending Invoices Modal Elements
        const pendingInvoicesModal = document.getElementById('pendingInvoicesModal');
        const closePendingInvoicesModal = document.getElementById('closePendingInvoicesModal');
        const closePendingInvoicesBtn = document.getElementById('closePendingInvoicesBtn');
        const showPendingInvoicesBtn = document.getElementById('showPendingInvoicesBtn');
        const pendingInvoicesList = document.getElementById('pendingInvoicesList');
        const pendingInvoicesEmpty = document.getElementById('pendingInvoicesEmpty');
        const pendingInvoicesBadge = document.getElementById('pendingInvoicesBadge');
        const completeInvoiceBtn = document.getElementById('completeInvoiceBtn');
        const invoiceStatusEl = document.getElementById('invoiceStatus');
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        function init() {
            loadFromFirebase();
            loadPendingInvoicesFromFirebase();
            setCurrentDate();
            updateInvoiceNumber();
            addNewRow();
            setupEventListeners();
            setupClientInputListeners();
        }
        
        // Helper function to process products data from Firebase snapshot
        function processProductsData(data) {
            if (data && Array.isArray(data)) {
                // Filter out any null or undefined values that Firebase might have stored
                return data.filter(p => p != null && typeof p === 'object');
            } else if (data && typeof data === 'object' && !Array.isArray(data)) {
                // Firebase sometimes converts arrays with gaps to objects, convert back
                return Object.values(data).filter(p => p != null && typeof p === 'object');
            } else {
                // Initialize with empty data
                return [];
            }
        }
        
        function loadFromFirebase() {
            try {
                if (database) {
                    // Load products from Firebase with real-time listener
                    database.ref('facturasItems').on('value', (snapshot) => {
                        products = processProductsData(snapshot.val());
                        console.log(`Factura products loaded from Firebase: ${products.length} products`);
                        renderProductsDb();
                    });
                    
                    // Load invoice number from Firebase with real-time listener
                    database.ref('facturasInvoiceNumber').on('value', (snapshot) => {
                        const num = snapshot.val();
                        if (num && typeof num === 'number') {
                            invoiceNumber = num;
                            updateInvoiceNumber();
                            console.log(`Invoice number loaded from Firebase: ${invoiceNumber}`);
                        }
                    });
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (err) {
                console.warn('Firebase not available, using localStorage fallback', err);
                // Fallback to localStorage
                const storedProducts = localStorage.getItem('factura_products');
                if (storedProducts) {
                    products = JSON.parse(storedProducts);
                }
                
                const storedInvoiceNumber = localStorage.getItem('factura_invoiceNumber');
                if (storedInvoiceNumber) {
                    invoiceNumber = parseInt(storedInvoiceNumber, 10);
                }
            }
        }
        
        function saveProductsToFirebase() {
            return new Promise((resolve) => {
                try {
                    if (database) {
                        database.ref('facturasItems').set(products)
                            .then(() => {
                                console.log('Factura products saved to Firebase successfully');
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error for factura products, using localStorage as fallback', err);
                                // Fallback to localStorage
                                try {
                                    localStorage.setItem('factura_products', JSON.stringify(products));
                                } catch (e) {
                                    console.error('localStorage save failed', e);
                                }
                                resolve();
                            });
                    } else {
                        throw new Error('Firebase not available');
                    }
                } catch (err) {
                    console.warn('Firebase not available, using localStorage fallback', err);
                    try {
                        localStorage.setItem('factura_products', JSON.stringify(products));
                    } catch (e) {
                        console.error('localStorage save failed', e);
                    }
                    resolve();
                }
            });
        }
        
        function saveInvoiceNumberToFirebase() {
            return new Promise((resolve) => {
                try {
                    if (database) {
                        database.ref('facturasInvoiceNumber').set(invoiceNumber)
                            .then(() => {
                                console.log('Invoice number saved to Firebase successfully');
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error for invoice number, using localStorage as fallback', err);
                                // Fallback to localStorage
                                try {
                                    localStorage.setItem('factura_invoiceNumber', invoiceNumber.toString());
                                } catch (e) {
                                    console.error('localStorage save failed', e);
                                }
                                resolve();
                            });
                    } else {
                        throw new Error('Firebase not available');
                    }
                } catch (err) {
                    console.warn('Firebase not available, using localStorage fallback', err);
                    try {
                        localStorage.setItem('factura_invoiceNumber', invoiceNumber.toString());
                    } catch (e) {
                        console.error('localStorage save failed', e);
                    }
                    resolve();
                }
            });
        }
        
        // ============================================
        // PENDING INVOICES MANAGEMENT
        // ============================================
        
        function loadPendingInvoicesFromFirebase() {
            try {
                if (database) {
                    // Load pending invoices with real-time listener
                    database.ref('pendingInvoices').on('value', (snapshot) => {
                        const data = snapshot.val();
                        pendingInvoices = data || {};
                        console.log(`Pending invoices loaded: ${Object.keys(pendingInvoices).length} invoices`);
                        updatePendingInvoicesBadge();
                        
                        // Load the most recent pending invoice or current invoice number
                        if (!currentInvoiceId) {
                            const invoiceId = invoiceNumber.toString();
                            if (pendingInvoices[invoiceId]) {
                                loadInvoiceById(invoiceId);
                            } else {
                                currentInvoiceId = invoiceId;
                            }
                        }
                    });
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (err) {
                console.warn('Firebase not available for pending invoices, using localStorage fallback', err);
                try {
                    const stored = localStorage.getItem('pendingInvoices');
                    if (stored) {
                        pendingInvoices = JSON.parse(stored);
                        updatePendingInvoicesBadge();
                    }
                } catch (e) {
                    console.error('localStorage load failed', e);
                }
            }
        }
        
        function savePendingInvoicesToFirebase() {
            return new Promise((resolve) => {
                try {
                    if (database) {
                        database.ref('pendingInvoices').set(pendingInvoices)
                            .then(() => {
                                console.log('Pending invoices saved to Firebase successfully');
                                resolve();
                            })
                            .catch((err) => {
                                console.warn('Firebase save error for pending invoices, using localStorage as fallback', err);
                                try {
                                    localStorage.setItem('pendingInvoices', JSON.stringify(pendingInvoices));
                                } catch (e) {
                                    console.error('localStorage save failed', e);
                                }
                                resolve();
                            });
                    } else {
                        throw new Error('Firebase not available');
                    }
                } catch (err) {
                    console.warn('Firebase not available, using localStorage fallback', err);
                    try {
                        localStorage.setItem('pendingInvoices', JSON.stringify(pendingInvoices));
                    } catch (e) {
                        console.error('localStorage save failed', e);
                    }
                    resolve();
                }
            });
        }
        
        function getCurrentInvoiceData() {
            return {
                invoiceNumber: invoiceNumber,
                products: invoiceRows.map(row => ({
                    upc: row.upc || '',
                    qty: row.qty || 0,
                    product: row.product || '',
                    price: row.price || 0,
                    total: row.total || 0
                })),
                clientName: document.getElementById('clientName').value,
                clientAddress: document.getElementById('clientAddress').value,
                clientCity: document.getElementById('clientCity').value,
                date: document.getElementById('invoiceDate').textContent,
                total: parseFloat(grandTotalEl.textContent.replace('$', '').replace(',', '')) || 0,
                lastModified: new Date().toISOString(),
                status: 'pending'
            };
        }
        
        function autoSaveCurrentInvoice() {
            // Debounce auto-save
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            autoSaveTimeout = setTimeout(() => {
                saveCurrentInvoice();
            }, AUTOSAVE_DELAY);
        }
        
        function saveCurrentInvoice() {
            if (!currentInvoiceId) {
                currentInvoiceId = invoiceNumber.toString();
            }
            
            const invoiceData = getCurrentInvoiceData();
            pendingInvoices[currentInvoiceId] = invoiceData;
            
            updateInvoiceStatus('saving');
            
            savePendingInvoicesToFirebase().then(() => {
                updateInvoiceStatus('saved');
                setTimeout(() => {
                    updateInvoiceStatus('pending');
                }, 2000);
            });
        }
        
        function loadInvoiceById(invoiceId) {
            const invoice = pendingInvoices[invoiceId];
            if (!invoice) {
                showToast('Factura no encontrada', 'error');
                return;
            }
            
            currentInvoiceId = invoiceId;
            invoiceNumber = parseInt(invoice.invoiceNumber) || parseInt(invoiceId);
            
            // Load client info
            document.getElementById('clientName').value = invoice.clientName || '';
            document.getElementById('clientAddress').value = invoice.clientAddress || '';
            document.getElementById('clientCity').value = invoice.clientCity || '';
            document.getElementById('invoiceDate').textContent = invoice.date || '';
            
            // Clear and load invoice rows
            invoiceBody.innerHTML = '';
            invoiceRows = [];
            
            if (invoice.products && invoice.products.length > 0) {
                invoice.products.forEach(product => {
                    const rowId = addNewRow();
                    const row = invoiceRows.find(r => r.id === rowId);
                    if (row) {
                        row.upc = product.upc || '';
                        row.qty = product.qty || 0;
                        row.product = product.product || '';
                        row.price = product.price || 0;
                        row.total = product.total || 0;
                        updateRowDisplay(rowId);
                    }
                });
            } else {
                addNewRow();
            }
            
            updateInvoiceNumber();
            calculateTotal();
            updateInvoiceStatus('pending');
            
            showToast(`Factura #${invoiceNumber} cargada`, 'success');
        }
        
        function completeCurrentInvoice() {
            if (!currentInvoiceId || !pendingInvoices[currentInvoiceId]) {
                showToast('No hay factura para terminar', 'error');
                return;
            }
            
            const confirm = window.confirm(`¬øTerminar factura #${invoiceNumber}? Se eliminar√° de facturas pendientes.`);
            if (!confirm) return;
            
            // Remove from pending invoices
            delete pendingInvoices[currentInvoiceId];
            savePendingInvoicesToFirebase();
            
            showToast(`Factura #${invoiceNumber} completada`, 'success');
            
            // Create new invoice
            createNewInvoice();
        }
        
        function updatePendingInvoicesBadge() {
            const count = Object.keys(pendingInvoices).length;
            if (count > 0) {
                pendingInvoicesBadge.textContent = count;
                pendingInvoicesBadge.style.display = 'inline-block';
            } else {
                pendingInvoicesBadge.style.display = 'none';
            }
        }
        
        function updateInvoiceStatus(status) {
            const statusMap = {
                'pending': { text: 'Pendiente', class: 'pending' },
                'saving': { text: 'Guardando...', class: 'saving' },
                'saved': { text: '‚úì Guardado', class: 'saved' }
            };
            
            const statusInfo = statusMap[status] || statusMap['pending'];
            invoiceStatusEl.textContent = statusInfo.text;
            invoiceStatusEl.className = `status-badge ${statusInfo.class}`;
        }
        
        function showPendingInvoicesModal() {
            const invoiceIds = Object.keys(pendingInvoices).sort((a, b) => b - a);
            
            if (invoiceIds.length === 0) {
                pendingInvoicesList.style.display = 'none';
                pendingInvoicesEmpty.style.display = 'block';
            } else {
                pendingInvoicesList.style.display = 'block';
                pendingInvoicesEmpty.style.display = 'none';
                
                pendingInvoicesList.innerHTML = invoiceIds.map(id => {
                    const invoice = pendingInvoices[id];
                    const isActive = id === currentInvoiceId;
                    return `
                        <div class="pending-invoice-item ${isActive ? 'active' : ''}" data-invoice-id="${id}">
                            <div class="pending-invoice-header">
                                <span class="pending-invoice-number">Factura #${invoice.invoiceNumber || id}</span>
                                <span class="pending-invoice-date">${invoice.date || 'Sin fecha'}</span>
                            </div>
                            <div class="pending-invoice-details">
                                <div class="pending-invoice-detail">
                                    <span>üì¶ ${(invoice.products || []).length} productos</span>
                                </div>
                                <div class="pending-invoice-detail">
                                    <span>üë§ ${invoice.clientName || 'Sin cliente'}</span>
                                </div>
                                <div class="pending-invoice-detail pending-invoice-total">
                                    üí∞ $${(invoice.total || 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers
                document.querySelectorAll('.pending-invoice-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const invoiceId = this.getAttribute('data-invoice-id');
                        loadInvoiceById(invoiceId);
                        pendingInvoicesModal.classList.remove('show');
                    });
                });
            }
            
            pendingInvoicesModal.classList.add('show');
        }
        
        function setupClientInputListeners() {
            const clientNameInput = document.getElementById('clientName');
            const clientAddressInput = document.getElementById('clientAddress');
            const clientCityInput = document.getElementById('clientCity');
            
            [clientNameInput, clientAddressInput, clientCityInput].forEach(input => {
                input.addEventListener('input', () => {
                    autoSaveCurrentInvoice();
                });
            });
        }
        
        function setCurrentDate() {
            const today = new Date();
            const day = today.getDate();
            const months = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
            const month = months[today.getMonth()];
            const year = today.getFullYear();
            invoiceDateEl.textContent = `${day} ${month} ${year}`;
        }
        
        function updateInvoiceNumber() {
            invoiceNumberEl.textContent = invoiceNumber;
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            addRowBtn.addEventListener('click', addNewRow);
            newInvoiceBtn.addEventListener('click', createNewInvoice);
            printBtn.addEventListener('click', printInvoice);
            loadCsvBtn.addEventListener('click', () => csvInput.click());
            csvInput.addEventListener('change', handleCsvUpload);
            addProductBtn.addEventListener('click', openProductModal);
            closeModal.addEventListener('click', closeProductModal);
            cancelProductBtn.addEventListener('click', closeProductModal);
            saveProductBtn.addEventListener('click', saveNewProduct);
            
            // Products Database Modal events
            showProductsDbBtn.addEventListener('click', openProductsDbModal);
            closeProductsDbModal.addEventListener('click', closeProductsDbModalFn);
            closeProductsDbBtn.addEventListener('click', closeProductsDbModalFn);
            productsDbSearch.addEventListener('input', debounce(filterProductsDb, 300));
            
            // Close modal on outside click
            addProductModal.addEventListener('click', (e) => {
                if (e.target === addProductModal) {
                    closeProductModal();
                }
            });
            
            // Close products database modal on outside click
            productsDbModal.addEventListener('click', (e) => {
                if (e.target === productsDbModal) {
                    closeProductsDbModalFn();
                }
            });
            
            // Add to Database Confirmation Modal events
            closeAddToDbModal.addEventListener('click', closeAddToDbConfirmModal);
            cancelAddToDbBtn.addEventListener('click', closeAddToDbConfirmModal);
            confirmAddToDbBtn.addEventListener('click', confirmAddProductToDb);
            
            // Close add to database modal on outside click
            addToDbModal.addEventListener('click', (e) => {
                if (e.target === addToDbModal) {
                    closeAddToDbConfirmModal();
                }
            });
            
            // Change Invoice Number Modal events
            changeInvoiceNumberBtn.addEventListener('click', openChangeInvoiceNumberModal);
            closeChangeInvoiceModal.addEventListener('click', closeChangeInvoiceNumberModal);
            cancelChangeInvoiceBtn.addEventListener('click', closeChangeInvoiceNumberModal);
            confirmChangeInvoiceBtn.addEventListener('click', confirmChangeInvoiceNumber);
            
            // Close change invoice number modal on outside click
            changeInvoiceNumberModal.addEventListener('click', (e) => {
                if (e.target === changeInvoiceNumberModal) {
                    closeChangeInvoiceNumberModal();
                }
            });
            
            // Pending Invoices Modal events
            showPendingInvoicesBtn.addEventListener('click', showPendingInvoicesModal);
            closePendingInvoicesModal.addEventListener('click', () => {
                pendingInvoicesModal.classList.remove('show');
            });
            closePendingInvoicesBtn.addEventListener('click', () => {
                pendingInvoicesModal.classList.remove('show');
            });
            
            // Close pending invoices modal on outside click
            pendingInvoicesModal.addEventListener('click', (e) => {
                if (e.target === pendingInvoicesModal) {
                    pendingInvoicesModal.classList.remove('show');
                }
            });
            
            // Complete Invoice button
            completeInvoiceBtn.addEventListener('click', completeCurrentInvoice);
            
            // Close dropdowns on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.upc-cell') && !e.target.closest('.product-cell')) {
                    closeAllDropdowns();
                }
            });
        }
        
        // ============================================
        // INVOICE ROW MANAGEMENT
        // ============================================
        
        function addNewRow(autoFocus = true) {
            const rowId = Date.now().toString();
            const row = document.createElement('tr');
            row.dataset.rowId = rowId;
            
            row.innerHTML = `
                <td class="upc-cell">
                    <input type="text" class="upc-input" placeholder="Buscar UPC..." data-row-id="${rowId}">
                    <div class="upc-dropdown" id="dropdown-${rowId}"></div>
                </td>
                <td class="qty-cell">
                    <input type="number" class="qty-input" step="any" min="0.01" value="1" data-row-id="${rowId}">
                </td>
                <td class="product-cell">
                    <input type="text" class="product-input" placeholder="Buscar nombre..." data-row-id="${rowId}">
                    <div class="product-dropdown" id="product-dropdown-${rowId}"></div>
                </td>
                <td class="price-cell">
                    <input type="number" class="price-input" step="0.01" min="0" placeholder="0.00" data-row-id="${rowId}">
                </td>
                <td class="total-cell">
                    <input type="text" class="total-input" value="$0.00" readonly data-row-id="${rowId}">
                </td>
                <td class="delete-cell">
                    <button class="delete-btn" data-row-id="${rowId}">&times;</button>
                </td>
            `;
            
            invoiceBody.appendChild(row);
            
            // Setup event listeners for this row
            const upcInput = row.querySelector('.upc-input');
            const qtyInput = row.querySelector('.qty-input');
            const productInput = row.querySelector('.product-input');
            const priceInput = row.querySelector('.price-input');
            const deleteBtn = row.querySelector('.delete-btn');
            
            upcInput.addEventListener('input', (e) => handleUpcInput(e, rowId));
            upcInput.addEventListener('focus', (e) => handleUpcInput(e, rowId));
            qtyInput.addEventListener('input', () => {
                calculateRowTotal(rowId, false);
                autoSaveCurrentInvoice();
            });
            qtyInput.addEventListener('blur', () => calculateRowTotal(rowId, true));
            productInput.addEventListener('input', (e) => {
                handleProductNameInput(e, rowId);
                autoSaveCurrentInvoice();
            });
            productInput.addEventListener('focus', (e) => handleProductNameInput(e, rowId));
            priceInput.addEventListener('input', () => {
                handlePriceInput(rowId);
                autoSaveCurrentInvoice();
            });
            priceInput.addEventListener('blur', () => {
                // Check if product should be added to database when leaving price field
                checkAndPromptAddToDatabase(rowId);
            });
            priceInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Recalculate row total before adding new row
                    calculateRowTotal(rowId);
                    // Check if product should be added to database
                    checkAndPromptAddToDatabase(rowId);
                    // Create new row below
                    addNewRow();
                }
            });
            deleteBtn.addEventListener('click', () => deleteRow(rowId));
            
            // Store row data
            invoiceRows.push({
                id: rowId,
                upc: '',
                qty: 1,
                product: '',
                price: 0,
                total: 0,
                fromAutocomplete: false // Track if product was selected from autocomplete
            });
            
            // Focus on UPC input only when autoFocus is true
            // This prevents stealing focus when auto-adding rows during typing
            if (autoFocus) {
                upcInput.focus();
            }
            
            return rowId;
        }
        
        function deleteRow(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (row) {
                row.remove();
                invoiceRows = invoiceRows.filter(r => r.id !== rowId);
                calculateGrandTotal();
                autoSaveCurrentInvoice();
            }
        }
        
        // ============================================
        // UPC AUTOCOMPLETE
        // ============================================
        
        function handleUpcInput(e, rowId) {
            const input = e.target;
            const value = input.value.trim();
            const dropdown = document.getElementById(`dropdown-${rowId}`);
            
            // Update row data with the typed UPC
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.upc = value;
                // Reset autocomplete flag when manually typing UPC
                rowData.fromAutocomplete = false;
            }
            
            // Close all other dropdowns first
            closeAllDropdowns();
            
            if (value.length < 1) {
                dropdown.classList.remove('show');
                dropdown.innerHTML = '';
                return;
            }
            
            // Search for matching products
            const matches = products.filter(p => 
                p.upc.toLowerCase().includes(value.toLowerCase())
            );
            
            if (matches.length === 0) {
                dropdown.classList.remove('show');
                dropdown.innerHTML = '';
                return;
            }
            
            // Build dropdown items
            dropdown.innerHTML = matches.slice(0, 10).map(p => `
                <div class="upc-dropdown-item" data-upc="${p.upc}" data-name="${escapeHtml(p.name)}" data-price="${p.price}">
                    <div class="upc-code">${highlightMatch(p.upc, value)}</div>
                    <div class="product-name">${escapeHtml(p.name)} - $${p.price.toFixed(2)}</div>
                </div>
            `).join('');
            
            dropdown.classList.add('show');
            
            // Add click handlers to dropdown items
            dropdown.querySelectorAll('.upc-dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectProduct(item, rowId));
            });
        }
        
        function selectProduct(item, rowId) {
            const upc = item.dataset.upc;
            const name = item.dataset.name;
            const price = parseFloat(item.dataset.price);
            
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const upcInput = row.querySelector('.upc-input');
            const productInput = row.querySelector('.product-input');
            const priceInput = row.querySelector('.price-input');
            
            upcInput.value = upc;
            productInput.value = name;
            priceInput.value = price.toFixed(2);
            
            // Update row data
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.upc = upc;
                rowData.product = name;
                rowData.price = price;
                rowData.fromAutocomplete = true; // Mark as selected from autocomplete
            }
            
            // Close dropdown
            closeAllDropdowns();
            
            // Calculate row total
            calculateRowTotal(rowId);
            
            // Auto-save after selecting product
            autoSaveCurrentInvoice();
            
            // Check if we need to add a new row automatically
            checkAndAddNewRow();
            
            // Focus on qty input
            const qtyInput = row.querySelector('.qty-input');
            qtyInput.focus();
            qtyInput.select();
        }
        
        function closeAllDropdowns() {
            document.querySelectorAll('.upc-dropdown').forEach(d => {
                d.classList.remove('show');
            });
            document.querySelectorAll('.product-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
        
        // ============================================
        // PRODUCT NAME AUTOCOMPLETE
        // ============================================
        
        function handleProductNameInput(e, rowId) {
            const input = e.target;
            const value = input.value.trim();
            const dropdown = document.getElementById(`product-dropdown-${rowId}`);
            
            // Update row data with the typed product name
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.product = value;
                // Reset autocomplete flag when manually typing product name
                rowData.fromAutocomplete = false;
            }
            
            // Check if we need to add a new row
            checkAndAddNewRow();
            
            // Close all other dropdowns first
            closeAllDropdowns();
            
            if (value.length < 2) {
                dropdown.classList.remove('show');
                dropdown.innerHTML = '';
                return;
            }
            
            // Search for matching products by name
            const searchTerms = value.toLowerCase().split(/\s+/);
            const matches = products.filter(p => {
                const productName = (p.name || '').toLowerCase();
                // All search terms must be found in the product name
                return searchTerms.every(term => productName.includes(term));
            });
            
            if (matches.length === 0) {
                dropdown.classList.remove('show');
                dropdown.innerHTML = '';
                return;
            }
            
            // Build dropdown items
            dropdown.innerHTML = matches.slice(0, 10).map(p => `
                <div class="product-dropdown-item" data-upc="${p.upc}" data-name="${escapeHtml(p.name)}" data-price="${p.price}">
                    <div class="product-name-match">${highlightMatch(escapeHtml(p.name), value)}</div>
                    <div class="product-upc-info">UPC: ${p.upc} - $${p.price.toFixed(2)}</div>
                </div>
            `).join('');
            
            dropdown.classList.add('show');
            
            // Add click handlers to dropdown items
            dropdown.querySelectorAll('.product-dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectProductFromName(item, rowId));
            });
        }
        
        function selectProductFromName(item, rowId) {
            const upc = item.dataset.upc;
            const name = item.dataset.name;
            const price = parseFloat(item.dataset.price);
            
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const upcInput = row.querySelector('.upc-input');
            const productInput = row.querySelector('.product-input');
            const priceInput = row.querySelector('.price-input');
            
            upcInput.value = upc;
            productInput.value = name;
            priceInput.value = price.toFixed(2);
            
            // Update row data
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.upc = upc;
                rowData.product = name;
                rowData.price = price;
                rowData.fromAutocomplete = true; // Mark as selected from autocomplete
            }
            
            // Close dropdown
            closeAllDropdowns();
            
            // Calculate row total
            calculateRowTotal(rowId);
            
            // Auto-save after selecting product
            autoSaveCurrentInvoice();
            
            // Check if we need to add a new row automatically
            checkAndAddNewRow();
            
            // Focus on qty input
            const qtyInput = row.querySelector('.qty-input');
            qtyInput.focus();
            qtyInput.select();
        }
        
        // ============================================
        // MANUAL INPUT HANDLERS
        // ============================================
        
        function handlePriceInput(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const priceInput = row.querySelector('.price-input');
            const price = parseFloat(priceInput.value) || 0;
            
            // Update row data
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.price = price;
                // Reset autocomplete flag if user manually edits the price
                rowData.fromAutocomplete = false;
            }
            
            // Recalculate row total
            calculateRowTotal(rowId);
            
            // Check if we need to add a new row
            checkAndAddNewRow();
        }
        
        function checkAndAddNewRow() {
            // Don't add a row if there are no rows (handled by init/newInvoice)
            if (invoiceRows.length === 0) return;
            
            // Check if all existing rows have data (product name or price > 0)
            const allRowsFilled = invoiceRows.every(rowData => {
                return (rowData.product || '').trim() !== '' || rowData.price > 0;
            });
            
            // If all rows are filled, add a new empty row without stealing focus
            if (allRowsFilled) {
                addNewRow(false);
            }
        }
        
        function highlightMatch(text, search) {
            const regex = new RegExp(`(${escapeRegex(search)})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================
        // CALCULATIONS
        // ============================================
        
        function calculateRowTotal(rowId, enforceMin = true) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');
            const totalInput = row.querySelector('.total-input');
            
            let qty = parseFloat(qtyInput.value);
            if (isNaN(qty) || qty <= 0) {
                qty = 1;
                // Only update the input value when enforceMin is true (on blur)
                // This allows the user to clear the field while typing
                if (enforceMin) {
                    qtyInput.value = 1;
                }
            }
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;
            
            totalInput.value = formatCurrency(total);
            
            // Update row data
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (rowData) {
                rowData.qty = qty;
                rowData.total = total;
            }
            
            calculateGrandTotal();
        }
        
        function calculateGrandTotal() {
            const total = invoiceRows.reduce((sum, row) => sum + (row.total || 0), 0);
            grandTotalEl.textContent = formatCurrency(total);
        }
        
        function updateRowDisplay(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (!rowData) return;
            
            const upcInput = row.querySelector('.upc-input');
            const qtyInput = row.querySelector('.qty-input');
            const productInput = row.querySelector('.product-input');
            const priceInput = row.querySelector('.price-input');
            const totalInput = row.querySelector('.total-input');
            
            upcInput.value = rowData.upc || '';
            qtyInput.value = rowData.qty || 1;
            productInput.value = rowData.product || '';
            priceInput.value = rowData.price ? rowData.price.toFixed(2) : '';
            totalInput.value = formatCurrency(rowData.total || 0);
        }
        
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2);
        }
        
        // ============================================
        // CSV HANDLING
        // ============================================
        
        function handleCsvUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                let csvData = event.target.result;
                
                // Remove BOM (Byte Order Mark) if present - common in files from Numbers/Excel
                if (csvData.charCodeAt(0) === 0xFEFF) {
                    csvData = csvData.slice(1);
                }
                
                parseCsv(csvData);
            };
            reader.readAsText(file, 'UTF-8');
            
            // Reset input
            csvInput.value = '';
        }
        
        function parseCsv(csvData) {
            const lines = csvData.split('\n');
            let importedCount = 0;
            let skippedNoUpc = 0;
            
            // First pass: collect all products from CSV and group duplicates
            // Key: upc + name (JSON stringified), Value: { upc, name, price }
            const csvProducts = new Map();
            
            // Detect delimiter by analyzing multiple lines for more reliable detection
            const dataLines = lines.filter(line => line.trim() && !line.toLowerCase().startsWith('upc')).slice(0, 5);
            const delimiter = detectDelimiter(dataLines);
            
            lines.forEach((line, index) => {
                // Skip empty lines
                if (!line.trim()) return;
                
                // Skip header line (case-insensitive check for "UPC" in first column)
                const trimmedLine = line.trim();
                if (index === 0 && trimmedLine.toLowerCase().startsWith('upc')) return;
                
                // Parse CSV/TSV line (handle quoted values and detected delimiter)
                const values = parseCSVLine(line, delimiter);
                
                if (values.length >= 3) {
                    const upc = values[0].trim();
                    const name = values[1].trim();
                    // Remove currency symbols ($, ‚Ç¨, etc.) and clean up price format
                    // Handle both European (1.234,56) and US (1,234.56) formats
                    let priceStr = values[2].trim()
                        .replace(/[$‚Ç¨¬£¬•]/g, '')       // Remove currency symbols
                        .replace(/\s/g, '');           // Remove any whitespace
                    
                    // Determine decimal separator:
                    // European format: uses comma as decimal separator, dot as thousand separator
                    // US format: uses dot as decimal separator, comma as thousand separator
                    // Pattern explanation:
                    //   \d+ - one or more digits before optional thousand separators
                    //   (?:\.\d{3})* - zero or more groups of dot + exactly 3 digits (thousand separators)
                    //   ,\d{1,2}$ - comma followed by 1-2 digits at end (decimal portion)
                    if (/\d+(?:\.\d{3})*,\d{1,2}$/.test(priceStr)) {
                        // European format: 1.234,56 or 12.345.678,90 -> 1234.56 or 12345678.90
                        priceStr = priceStr.replace(/\./g, '').replace(',', '.');
                    } else {
                        // US format: remove thousand separators
                        // Pattern: comma followed by exactly 3 digits, but NOT followed by more digits
                        // This ensures we only remove thousand separators (1,234) not decimal commas (1,23)
                        priceStr = priceStr.replace(/,(?=\d{3}(?!\d))/g, '');
                        // If comma is used as decimal separator (e.g., 4,62 with no dot present), replace it
                        if (priceStr.includes(',') && !priceStr.includes('.')) {
                            priceStr = priceStr.replace(',', '.');
                        }
                    }
                    const price = parseFloat(priceStr);
                    
                    // Skip products without UPC
                    if (!upc) {
                        skippedNoUpc++;
                        return;
                    }
                    
                    if (name && !isNaN(price)) {
                        // Create key for grouping duplicates (same UPC and name)
                        // Using JSON.stringify to handle product names with special characters
                        const key = JSON.stringify([upc, name]);
                        
                        if (csvProducts.has(key)) {
                            // Duplicate found - keep the highest price
                            const existing = csvProducts.get(key);
                            if (price > existing.price) {
                                existing.price = price;
                            }
                        } else {
                            // New product
                            csvProducts.set(key, { upc, name, price });
                        }
                    }
                }
            });
            
            // Second pass: add/update products in the database
            csvProducts.forEach((product) => {
                const { upc, name, price } = product;
                
                // Check if product already exists in database
                const existingIndex = products.findIndex(p => p.upc === upc);
                if (existingIndex >= 0) {
                    // Update existing product with highest price
                    const existingPrice = products[existingIndex].price;
                    products[existingIndex] = { 
                        upc, 
                        name, 
                        price: Math.max(price, existingPrice) 
                    };
                } else {
                    // Add new product
                    products.push({ upc, name, price });
                }
                importedCount++;
            });
            
            saveProductsToFirebase();
            
            // Build message based on results
            let message = `${importedCount} productos importados correctamente`;
            if (skippedNoUpc > 0) {
                message += ` (${skippedNoUpc} omitidos por falta de UPC)`;
            }
            showToast(message, 'success');
        }
        
        /**
         * Detects the delimiter used in CSV/TSV data by analyzing multiple lines
         * Supports: tab (\t), comma (,), semicolon (;)
         * @param {string[]} lines - Array of sample lines from the file
         * @returns {string} The detected delimiter character
         */
        function detectDelimiter(lines) {
            if (!lines || lines.length === 0) {
                return ',';
            }
            
            // Analyze delimiter consistency across lines
            // Count how many columns each delimiter would produce per line
            const delimiterStats = {
                '\t': { counts: [], consistent: true },
                ',': { counts: [], consistent: true },
                ';': { counts: [], consistent: true }
            };
            
            // Map delimiters to their regex patterns for matching
            const delimiterPatterns = {
                '\t': /\t/g,
                ',': /,/g,
                ';': /;/g
            };
            
            lines.forEach(line => {
                // Count columns for each delimiter
                Object.keys(delimiterStats).forEach(delim => {
                    const matches = line.match(delimiterPatterns[delim]) || [];
                    const count = matches.length + 1; // columns = delimiters + 1
                    delimiterStats[delim].counts.push(count);
                });
            });
            
            // Check consistency: same number of columns across all lines
            Object.keys(delimiterStats).forEach(delim => {
                const counts = delimiterStats[delim].counts;
                if (counts.length > 1) {
                    delimiterStats[delim].consistent = counts.every(c => c === counts[0]);
                    delimiterStats[delim].avgCount = counts.reduce((a, b) => a + b, 0) / counts.length;
                } else if (counts.length === 1) {
                    delimiterStats[delim].avgCount = counts[0];
                } else {
                    delimiterStats[delim].avgCount = 1;
                }
            });
            
            // Helper function to check if a delimiter is viable
            const isViableDelimiter = (delim) => 
                delimiterStats[delim].consistent && delimiterStats[delim].avgCount >= 3;
            
            // Prioritize tab (most reliable), then check for consistency
            // Tab is preferred if it produces consistent column counts >= 3 (UPC, Name, Price)
            if (isViableDelimiter('\t')) {
                return '\t';
            }
            // Check semicolon (common in European CSVs) - prefer over comma if more columns
            if (isViableDelimiter(';') && delimiterStats[';'].avgCount > delimiterStats[','].avgCount) {
                return ';';
            }
            return ',';
        }
        
        /**
         * Parses a CSV/TSV line handling quoted values
         * @param {string} line - The line to parse
         * @param {string} delimiter - The delimiter character (default: comma)
         * @returns {string[]} Array of values
         */
        function parseCSVLine(line, delimiter = ',') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === delimiter && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }
        
        // ============================================
        // NEW PRODUCT MODAL
        // ============================================
        
        function openProductModal() {
            addProductModal.classList.add('show');
            document.getElementById('newProductUpc').focus();
        }
        
        function closeProductModal() {
            addProductModal.classList.remove('show');
            document.getElementById('newProductUpc').value = '';
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
        }
        
        function saveNewProduct() {
            const upc = document.getElementById('newProductUpc').value.trim();
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            
            if (!upc || !name || isNaN(price)) {
                showToast('Por favor, complete todos los campos', 'error');
                return;
            }
            
            // Check if product already exists
            const existingIndex = products.findIndex(p => p.upc === upc);
            if (existingIndex >= 0) {
                products[existingIndex] = { upc, name, price };
                showToast('Producto actualizado correctamente', 'success');
            } else {
                products.push({ upc, name, price });
                showToast('Producto agregado correctamente', 'success');
            }
            
            saveProductsToFirebase();
            closeProductModal();
        }
        
        // ============================================
        // PRODUCTS DATABASE MODAL
        // ============================================
        
        function openProductsDbModal() {
            renderProductsDb();
            productsDbSearch.value = '';
            productsDbModal.classList.add('show');
        }
        
        function closeProductsDbModalFn() {
            productsDbModal.classList.remove('show');
        }
        
        // ============================================
        // ADD TO DATABASE CONFIRMATION MODAL
        // ============================================
        
        function openAddToDbConfirmModal(upc, name, price) {
            pendingProductToAdd = { upc, name, price };
            confirmProductUpc.textContent = upc || 'N/A';
            confirmProductName.textContent = name;
            confirmProductPrice.textContent = '$' + price.toFixed(2);
            addToDbModal.classList.add('show');
        }
        
        function closeAddToDbConfirmModal() {
            addToDbModal.classList.remove('show');
            pendingProductToAdd = null;
        }
        
        function confirmAddProductToDb() {
            if (!pendingProductToAdd) {
                closeAddToDbConfirmModal();
                return;
            }
            
            const { upc, name, price } = pendingProductToAdd;
            
            // Check if product already exists (by UPC or name) - case insensitive
            const existingByUpc = upc ? products.findIndex(p => p.upc && p.upc.toLowerCase() === upc.toLowerCase()) : -1;
            const existingByName = products.findIndex(p => p.name && p.name.toLowerCase() === name.toLowerCase());
            
            if (existingByUpc >= 0) {
                // Update existing product by UPC
                products[existingByUpc] = { upc, name, price };
                showToast('Producto actualizado en la base de datos', 'success');
            } else if (existingByName >= 0) {
                // Update existing product by name
                products[existingByName] = { upc: upc || products[existingByName].upc, name, price };
                showToast('Producto actualizado en la base de datos', 'success');
            } else {
                // Add new product
                products.push({ upc: upc || '', name, price });
                showToast('Producto agregado a la base de datos', 'success');
            }
            
            saveProductsToFirebase();
            closeAddToDbConfirmModal();
        }
        
        /**
         * Checks if a product exists in the database
         * @param {string} upc - The UPC code
         * @param {string} name - The product name
         * @returns {boolean} - True if product exists
         */
        function productExistsInDatabase(upc, name) {
            if (!upc && !name) return false;
            
            return products.some(p => 
                // Check by UPC if provided
                (upc && p.upc && p.upc.toLowerCase() === upc.toLowerCase()) ||
                // Check by name if provided
                (name && p.name && p.name.toLowerCase() === name.toLowerCase())
            );
        }
        
        /**
         * Called when a row's data is complete (has product name and price)
         * Checks if the product exists and prompts to add if not
         * @param {string} rowId - The row ID
         */
        function checkAndPromptAddToDatabase(rowId) {
            const rowData = invoiceRows.find(r => r.id === rowId);
            if (!rowData) return;
            
            // If product was selected from autocomplete, it already exists in database
            if (rowData.fromAutocomplete) return;
            
            const upc = rowData.upc || '';
            const name = rowData.product || '';
            const price = rowData.price || 0;
            
            // Only check if we have at least a product name and a valid price
            if (!name.trim() || price <= MIN_VALID_PRICE) return;
            
            // Check if product already exists in database
            if (productExistsInDatabase(upc, name)) return;
            
            // Product doesn't exist - prompt to add
            openAddToDbConfirmModal(upc, name, price);
        }
        
        // ============================================
        // CHANGE INVOICE NUMBER MODAL
        // ============================================
        
        function openChangeInvoiceNumberModal() {
            newInvoiceNumberInput.value = invoiceNumber;
            changeInvoiceNumberModal.classList.add('show');
            newInvoiceNumberInput.focus();
            newInvoiceNumberInput.select();
        }
        
        function closeChangeInvoiceNumberModal() {
            changeInvoiceNumberModal.classList.remove('show');
        }
        
        function confirmChangeInvoiceNumber() {
            const newNumber = parseInt(newInvoiceNumberInput.value, 10);
            
            if (isNaN(newNumber) || newNumber < 1) {
                showToast('Por favor, ingresa un n√∫mero v√°lido (m√≠nimo 1)', 'error');
                return;
            }
            
            invoiceNumber = newNumber;
            saveInvoiceNumberToFirebase();
            updateInvoiceNumber();
            
            showToast(`N√∫mero de factura cambiado a #${invoiceNumber}`, 'success');
            closeChangeInvoiceNumberModal();
        }
        
        function renderProductsDb(searchTerm = '') {
            productsDbBody.innerHTML = '';
            
            let filtered = products;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = products.filter(p => 
                    p.upc.toLowerCase().includes(term) || 
                    p.name.toLowerCase().includes(term)
                );
            }
            
            if (filtered.length === 0) {
                productsDbTableContainer.style.display = 'none';
                productsDbEmpty.style.display = 'block';
                productsDbCount.textContent = '';
                return;
            }
            
            productsDbTableContainer.style.display = 'block';
            productsDbEmpty.style.display = 'none';
            productsDbCount.textContent = `${filtered.length} producto${filtered.length !== 1 ? 's' : ''}`;
            
            filtered.forEach((product, index) => {
                const originalIndex = products.findIndex(p => p.upc === product.upc);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(product.upc)}</td>
                    <td>${escapeHtml(product.name)}</td>
                    <td class="text-right">
                        <input type="number" 
                            class="price-edit-input" 
                            value="${product.price.toFixed(2)}" 
                            step="0.01" 
                            min="0" 
                            data-index="${originalIndex}">
                    </td>
                    <td class="text-center">
                        <button class="btn btn-success btn-save-price save-price-btn" data-index="${originalIndex}">
                            Guardar
                        </button>
                    </td>
                `;
                productsDbBody.appendChild(row);
            });
            
            // Add event listeners for save buttons
            productsDbBody.querySelectorAll('.save-price-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    const input = productsDbBody.querySelector(`.price-edit-input[data-index="${index}"]`);
                    const newPrice = parseFloat(input.value);
                    
                    // Allow 0 for free samples/promotional items
                    if (isNaN(newPrice) || newPrice < 0) {
                        showToast('Por favor, ingrese un precio v√°lido (0 o mayor)', 'error');
                        return;
                    }
                    
                    products[index].price = newPrice;
                    saveProductsToFirebase();
                    // Update the input field to show the saved value
                    input.value = newPrice.toFixed(2);
                    showToast('Precio actualizado correctamente', 'success');
                });
            });
            
            // Allow pressing Enter to save price
            productsDbBody.querySelectorAll('.price-edit-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const index = parseInt(input.dataset.index, 10);
                        const btn = productsDbBody.querySelector(`.save-price-btn[data-index="${index}"]`);
                        if (btn) btn.click();
                    }
                });
            });
        }
        
        function filterProductsDb() {
            const searchTerm = productsDbSearch.value.trim();
            renderProductsDb(searchTerm);
        }
        
        // Debounce helper function for search
        function debounce(fn, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }
        
        // ============================================
        // INVOICE ACTIONS
        // ============================================
        
        function createNewInvoice() {
            // Save current invoice before creating new one
            if (invoiceRows.length > 0 && invoiceRows.some(r => r.total > 0)) {
                saveCurrentInvoice();
                showToast('Factura actual guardada como pendiente', 'success');
            }
            
            // Increment invoice number
            invoiceNumber++;
            saveInvoiceNumberToFirebase();
            updateInvoiceNumber();
            
            // Set new current invoice ID
            currentInvoiceId = invoiceNumber.toString();
            
            // Clear table
            invoiceBody.innerHTML = '';
            invoiceRows = [];
            
            // Clear client info
            document.getElementById('clientName').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientCity').value = '';
            
            // Reset totals
            grandTotalEl.textContent = '$0.00';
            
            // Update date
            setCurrentDate();
            
            // Add first row
            addNewRow();
            
            // Update status
            updateInvoiceStatus('pending');
            
            showToast('Nueva factura creada', 'success');
        }
        
        function printInvoice() {
            try {
                if (!window.jspdf) {
                    showToast('Error: jsPDF no se carg√≥.', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Get invoice data
                const invoiceNum = document.getElementById('invoiceNumber').textContent;
                const invoiceDate = document.getElementById('invoiceDate').textContent;
                const clientName = document.getElementById('clientName').value || 'Cliente';
                const clientAddress = document.getElementById('clientAddress').value || '';
                const clientCity = document.getElementById('clientCity').value || '';
                const grandTotal = document.getElementById('grandTotal').textContent;
                
                // Page dimensions
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const rightColX = pageWidth / 2 + 10;
                const leftColX = margin;
                
                let yPos = 25;
                
                // === HEADER SECTION ===
                // LEFT SIDE: Invoice badge + Company info
                // Invoice badge - smaller size, proportional to text
                doc.setFillColor(204, 0, 0);
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                const invoiceBadgeText = `INVOICE #${invoiceNum}`;
                const badgeWidth = doc.getTextWidth(invoiceBadgeText) + 6;
                doc.roundedRect(leftColX, yPos - 5, badgeWidth + 4, 8, 1.5, 1.5, 'F');
                doc.text(invoiceBadgeText, leftColX + 3, yPos);
                
                // Company info (left aligned, below badge)
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('MEXIQUENSE MARKET LLC', leftColX, yPos + 10);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('9525 LACKLAND RD', leftColX, yPos + 18);
                doc.text('OVERLAND MO 63114', leftColX, yPos + 26);
                
                // Date
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.text(invoiceDate, leftColX, yPos + 36);
                
                // RIGHT SIDE: BILL TO
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('BILL TO:', pageWidth - margin - doc.getTextWidth('BILL TO:'), yPos);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, pageWidth - margin - doc.getTextWidth(clientName), yPos + 10);
                if (clientAddress) {
                    doc.text(clientAddress, pageWidth - margin - doc.getTextWidth(clientAddress), yPos + 18);
                }
                if (clientCity) {
                    doc.text(clientCity, pageWidth - margin - doc.getTextWidth(clientCity), yPos + 26);
                }
                
                yPos = 75;
                
                // === TABLE SECTION ===
                // Collect invoice rows data
                const tableData = [];
                const rows = document.querySelectorAll('#invoiceBody tr');
                
                rows.forEach(row => {
                    const upc = row.querySelector('.upc-input')?.value || '';
                    const qty = row.querySelector('.qty-input')?.value || '';
                    const product = row.querySelector('.product-input')?.value || '';
                    const price = row.querySelector('.price-input')?.value || '';
                    const total = row.querySelector('.total-input')?.value || '';
                    
                    // Only add rows with data
                    if (product || upc || (qty && parseFloat(qty) > 0)) {
                        tableData.push([
                            upc,
                            qty,
                            product,
                            price ? `$${parseFloat(price).toFixed(2)}` : '',
                            total
                        ]);
                    }
                });
                
                // Create table
                doc.autoTable({
                    startY: yPos,
                    head: [['UPC', 'QTY', 'PRODUCT', 'PRICE', 'TOTAL']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [0, 104, 71],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 10
                    },
                    styles: {
                        fontSize: 9,
                        cellPadding: 4
                    },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 25, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right' }
                    },
                    margin: { left: margin, right: margin }
                });
                
                // === TOTAL SECTION ===
                const finalY = doc.lastAutoTable.finalY + 15;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 104, 71);
                const totalLabel = 'TOTAL GENERAL:';
                const totalValue = grandTotal;
                
                doc.setTextColor(0, 0, 0);
                doc.text(totalLabel, pageWidth - margin - 80, finalY);
                doc.setTextColor(0, 104, 71);
                doc.text(totalValue, pageWidth - margin - doc.getTextWidth(totalValue), finalY);
                
                // Save the PDF
                const fileName = `factura-${invoiceNum}-${Date.now()}.pdf`;
                doc.save(fileName);
                
                showToast('PDF descargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Error al generar el PDF', 'error');
            }
        }
        
        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ============================================
        // INITIALIZE APP
        // ============================================
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
